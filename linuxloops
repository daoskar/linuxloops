#!/bin/bash

usage()
{
cat << USAGE
LinuxLoops: Flexible linux distro installer.
Usage: sudo bash linuxloops -distro <distribution name> -env <desktop environment> -dst <disk name or disk image path> [-s <total install size>] [-z <swap size>] [-b] [-e] [-a] [-H <hostname>] [-L <locale>] [-K <keymap>] [-T <timezone>] [-n] [-S] [-c <custom_packages_list>] [-C <custom_script_path>] [-k <kernel_parameters_list>]
-distro, --distribution <distribution name>			(Distribution to install)
-env, --environment <desktop environment>			(Desktop environment to install)
-dst, --destination <disk name or disk image path>		(e.g. /dev/sda or /ubuntu.img)
-s, --size <total install size>					(number in GB, minimum 14GB)
-z, --swapsize <swap size>					(number in GB)
-b, --btrfs							(Use btrfs for the root filesystem)
-e, --encrypt							(Encrypt the root filesystem)
-a, --autologin							(Enable user autologin)
-H, --hostname							(Provide a specific hostname)
-L, --locale <locale>						(specify locale to be used, by default "en_US")
-K, --keymap <keymap>						(specify keymap to be used, by default "us")
-T, --timezone <timezone>					(specify timezone to be used, by default "UTC")
-n, --nvidia							(Install nvidia drivers)
-S, --surface							(Add patches for Surface devices from github.com/linux-surface)
-c, --custom-packages						(list of additional packages to be installed - space separated)
-C, --custom-script						(bash script that should be run at the end of the install process)
-k, --kernel-parameters						(specific kernel parameters to be applied - space separated)
-d, --declarative <config_file_path>				(Use a declarative configuration file)
-l, --list							(List available distros and desktop environments)
-ll, --list-locales						(List available locales)
-lk, --list-keymaps						(List available keymaps)
-lt, --list-timezones						(List available timezones)
-h, --help							(Display this menu)
USAGE
}

available_distros=( "AlmaLinux" "Arch" "Artix" "BlendOS" "BlissOS" "Brunch" "ChromeOS-Flex" "Debian" "Devuan" "Elementary" "Fedora" "Gentoo" "Kali" "Linuxmint" "LMDE" "Manjaro" "MX" "Neon" "NixOS" "Nobara" "OpenSUSE" "Parrot" "Pop" "Proxmox" "Qubes" "RockyLinux" "SteamOS" "Tails" "Ubuntu" "Ubuntu-LTS" "Void" "Zorin" )
btrfs_supported=( "Arch" "Artix" "BlendOS" "Debian" "Devuan" "Elementary" "Fedora" "Gentoo" "Kali" "Linuxmint" "LMDE" "Manjaro" "MX" "Neon" "NixOS" "Nobara" "OpenSUSE" "Parrot" "Pop" "Proxmox" "SteamOS" "Qubes" "Ubuntu" "Ubuntu-LTS" "Void" "Zorin" )
nvidia_supported=( "Arch" "Artix" "BlendOS" "Debian" "Devuan" "Elementary" "Fedora" "Gentoo" "Kali" "Linuxmint" "Manjaro" "MX" "Neon" "NixOS" "Nobara" "OpenSUSE" "Parrot" "Pop" "Proxmox" "SteamOS" "Ubuntu" "Ubuntu-LTS" "Void" "Zorin" )
surface_supported=( "Arch" "Debian" "Elementary" "Fedora" "Kali" "Linuxmint" "LMDE" "Manjaro" "MX" "Neon" "Nobara" "Proxmox" "SteamOS" "Ubuntu" "Ubuntu-LTS" "Zorin" )

list_desktops()
{
case "${1}" in
	'AlmaLinux')
	available_desktops=( "None" "Full" )
	bootstrap="lxc almalinux 9 default"
	bootloader_id="almalinux"
	bootloader_name="shimx64.efi"
	;;
	'Arch')
	available_desktops=( "None" "Budgie" "Cinnamon" "Deepin" "Deepin/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="arch"
	bootloader_name="shimx64.efi"
	;;
	'Artix')
	available_desktops=( "None" "Budgie" "Cinnamon" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="artix"
	bootloader_name="shimx64.efi"
	;;
	'BlendOS')
	available_desktops=( "None" "Cinnamon" "Gnome" "Lxqt" "Mate" "Plasma" "Xfce" )
	bootstrap="lxc archlinux current default"
	bootloader_id="blendos"
	bootloader_name="shimx64.efi"
	;;
	'BlissOS')
	available_desktops=( "14/OpenGApps/Generic" "14/OpenGApps/Go" "14/OpenGApps/Surface" "14/FOSS/Generic" "14/FOSS/Go" "14/FOSS/Surface" "15/Gapps/Generic" "15/Gapps/Go" "15/Gapps/Surface" "15/FOSS/Generic" "15/FOSS/Go" "15/FOSS/Surface" "16/Gapps/Generic" "16/Gapps/Go" "16/Gapps/Surface" "16/FOSS/Generic" "16/FOSS/Go" "16/FOSS/Surface" )
	bootstrap="lxc archlinux current default"
	bootloader_id="boot"
	bootloader_name="bootx64.efi"
	;;
	'Brunch')
	available_desktops=( "Stable/Bobba" "Stable/Gumboz" "Stable/Jinlon" "Stable/Reven" "Stable/Shyvana" "Stable/Voxel" "Unstable/Bobba" "Unstable/Gumboz" "Unstable/Jinlon" "Unstable/Reven" "Unstable/Shyvana" "Unstable/Voxel" )
	bootstrap="lxc archlinux current default"
	bootloader_id="boot"
	bootloader_name="bootx64.efi"
	;;
	'ChromeOS-Flex')
	available_desktops=( "Full" "Full/Devmode" )
	bootstrap="lxc archlinux current default"
	bootloader_id="boot"
	bootloader_name="bootx64.efi"
	;;
	'Debian')
	available_desktops=( "None" "Budgie" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc debian bookworm default"
	bootloader_id="debian"
	bootloader_name="shimx64.efi"
	;;
	'Devuan')
	available_desktops=( "None" "Budgie" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc devuan daedalus default"
	bootloader_id="debian"
	bootloader_name="shimx64.efi"
	;;
	'Elementary')
	available_desktops=( "None" "Full" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	;;
	'Fedora')
	available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxqt" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc fedora 39 default"
	bootloader_id="fedora"
	bootloader_name="shimx64.efi"
	;;
	'Gentoo')
	available_desktops=( "None/Openrc" "None/Systemd" "Cinnamon/Openrc" "Cinnamon/Systemd" "Enlightenment/Openrc" "Enlightenment/Systemd" "Gnome/Openrc" "Gnome/Systemd" "i3/Openrc" "i3/Systemd" "Lxqt/Openrc" "Lxqt/Systemd" "Mate/Openrc" "Mate/Systemd" "Plasma/Openrc" "Plasma/Systemd" "Xfce/Openrc" "Xfce/Systemd" )
	bootstrap="lxc archlinux current default"
	bootloader_id="gentoo"
	bootloader_name="shimx64.efi"
	;;
	'Kali')
	available_desktops=( "None" "Cinnamon" "Cinnamon/Full" "Gnome" "Gnome/Full" "i3" "i3/Full" "Lxde" "Lxde/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	#available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Enlightenment/Full" "Gnome" "Gnome/Full" "i3" "i3/Full" "Lxde" "Lxde/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc kali current default"
	bootloader_id="debian"
	bootloader_name="grubx64.efi"
	grub_theme="/boot/grub/themes/kali/theme.txt"
	;;
	'Linuxmint')
	available_desktops=( "None" "Cinnamon" "Cinnamon/Full" "Mate" "Mate/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	grub_theme="/boot/grub/themes/linuxmint/theme.txt"
	;;
	'LMDE')
	available_desktops=( "None" "Cinnamon" "Cinnamon/Full" )
	bootstrap="lxc debian bookworm default"
	bootloader_id="debian"
	bootloader_name="shimx64.efi"
	grub_theme="/boot/grub/themes/linuxmint/theme.txt"
	;;
	'Manjaro')
	available_desktops=( "None" "Budgie" "Cinnamon" "Deepin" "Deepin/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="manjaro"
	bootloader_name="shimx64.efi"
	;;
	'MX')
	available_desktops=( "None" "Budgie" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc debian bookworm default"
	bootloader_id="debian"
	bootloader_name="shimx64.efi"
	grub_theme="/boot/grub/themes/mx_linux/theme.txt"
	;;
	'Neon')
	available_desktops=( "None" "Essentials" "Full" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	grub_theme="/boot/grub/themes/breeze/theme.txt"
	;;
	'NixOS')
	available_desktops=( "None" "Budgie/Full" "Cinnamon/Full" "Deepin/Full" "Gnome/Full" "i3/Full" "Lxqt/Full" "Mate/Full" "Pantheon/Full" "Plasma/Full" "Xfce/Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="nixos"
	bootloader_name="grubx64.efi"
	;;
	'Nobara')
	available_desktops=( "None" "Gnome" "Gnome/Full" "Nobara" "Nobara/Full" "Plasma" "Plasma/Full" "SteamDeck" "SteamDeck/Full" )
	bootstrap="lxc fedora 39 default"
	bootloader_id="fedora"
	bootloader_name="shimx64.efi"
	;;
	'OpenSUSE')
	available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Deepin" "Deepin/Full" "Enlightenment" "Enlightenment/Full" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc opensuse tumbleweed default"
	bootloader_id="opensuse"
	bootloader_name="shim.efi"
	;;
	'Parrot')
	available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Gnome" "Gnome/Full" "i3" "i3/Full" "Lxde" "Lxde/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	#available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Enlightenment/Full" "Gnome" "Gnome/Full" "i3" "i3/Full" "Lxde" "Lxde/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="debian"
	bootloader_name="grubx64.efi"
	;;
	'Pop')
	available_desktops=( "None" "Full" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	;;
	'Proxmox')
	available_desktops=( "None" "Budgie" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc debian bookworm default"
	bootloader_id="debian"
	bootloader_name="shimx64.efi"
	;;
	'Qubes')
	available_desktops=( "Full" )
	bootstrap="iso https://ftp.qubes-os.org/iso/Qubes-R4.2.0-x86_64.iso /images/install.img /LiveOS/rootfs.img"
	bootloader_id="qubes"
	bootloader_name="grubx64.efi"
	grub_theme="/boot/grub2/themes/qubes/theme.txt"
	;;
	'RockyLinux')
	available_desktops=( "None" "Full" )
	bootstrap="lxc rockylinux 9 default"
	bootloader_id="rocky"
	bootloader_name="shimx64.efi"
	;;
	'SteamOS')
	available_desktops=( "None" "Desktop" "Gamescope" )
	bootstrap="lxc archlinux current default"
	bootloader_id="steamos"
	bootloader_name="shimx64.efi"
	;;
	'Tails')
	available_desktops=( "Full" )
	bootstrap="lxc archlinux current default"
	bootloader_id="boot"
	bootloader_name="bootx64.efi"
	;;
	'Ubuntu')
	available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Studio/Full" "Ubuntu" "Ubuntu/Full" "Unity" "Unity/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc ubuntu noble default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	;;
	'Ubuntu-LTS')
	available_desktops=( "None" "Budgie" "Budgie/Full" "Cinnamon" "Cinnamon/Full" "Enlightenment" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxde/Full" "Lxqt" "Lxqt/Full" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Studio/Full" "Ubuntu" "Ubuntu/Full" "Xfce" "Xfce/Full" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	;;
	'Void')
	available_desktops=( "None" "Budgie" "Cinnamon" "Gnome" "Gnome/Full" "i3" "Lxde" "Lxqt" "Mate" "Mate/Full" "Plasma" "Plasma/Full" "Xfce" )
	bootstrap="lxc voidlinux current default"
	bootloader_id="voidlinux"
	bootloader_name="grubx64.efi"
	;;
	'Zorin')
	available_desktops=( "None" "Core" "Core/Windows_apps_support" "Lite" "Lite/Windows_apps_support" )
	bootstrap="lxc ubuntu jammy default"
	bootloader_id="ubuntu"
	bootloader_name="shimx64.efi"
	;;
esac
}

available_locales=(
"TRUE" "en_US" "American English, United States"
"FALSE" "aa_DJ" "Afar, Djibouti"
"FALSE" "aa_ER" "Afar, Eritrea"
"FALSE" "aa_ET" "Afar, Ethiopia"
"FALSE" "ab_GE" "Abkhazian, Georgia"
"FALSE" "af_ZA" "Afrikaans, South Africa"
"FALSE" "agr_PE" "Aguaruna, Peru"
"FALSE" "ak_GH" "Akan, Ghana"
"FALSE" "am_ET" "Amharic, Ethiopia"
"FALSE" "an_ES" "Aragonese, Spain"
"FALSE" "anp_IN" "Angika, India"
"FALSE" "ar_AE" "Arabic, United Arab Emirates"
"FALSE" "ar_BH" "Arabic, Bahrain"
"FALSE" "ar_DZ" "Arabic, Algeria"
"FALSE" "ar_EG" "Arabic, Egypt"
"FALSE" "ar_IN" "Arabic, India"
"FALSE" "ar_IQ" "Arabic, Iraq"
"FALSE" "ar_JO" "Arabic, Jordan"
"FALSE" "ar_KW" "Arabic, Kuwait"
"FALSE" "ar_LB" "Arabic, Lebanon"
"FALSE" "ar_LY" "Arabic, Libya"
"FALSE" "ar_MA" "Arabic, Morocco"
"FALSE" "ar_OM" "Arabic, Oman"
"FALSE" "ar_QA" "Arabic, Qatar"
"FALSE" "ar_SA" "Arabic, Saudi Arabia"
"FALSE" "ar_SD" "Arabic, Sudan"
"FALSE" "ar_SS" "Arabic, South Sudan"
"FALSE" "ar_SY" "Arabic, Syria"
"FALSE" "ar_TN" "Arabic, Tunisia"
"FALSE" "ar_YE" "Arabic, Yemen"
"FALSE" "as_IN" "Assamese, India"
"FALSE" "ast_ES" "Asturian, Spain"
"FALSE" "ayc_PE" "Aymara, Peru"
"FALSE" "az_AZ" "Azerbaijani, Azerbaijan"
"FALSE" "az_IR" "South Azerbaijani, Iran"
"FALSE" "be_BY" "Belarusian, Belarus"
"FALSE" "bem_ZM" "Bemba, Zambia"
"FALSE" "ber_DZ" "Berber, Algeria"
"FALSE" "ber_MA" "Berber, Morocco"
"FALSE" "bg_BG" "Bulgarian, Bulgaria"
"FALSE" "bhb_IN" "Bhili, India"
"FALSE" "bho_IN" "Bhojpuri, India"
"FALSE" "bho_NP" "Bhojpuri, Nepal"
"FALSE" "bi_VU" "Bislama, Vanuatu"
"FALSE" "bn_BD" "Bangla, Bangladesh"
"FALSE" "bn_IN" "Bangla, India"
"FALSE" "bo_CN" "Tibetan, China"
"FALSE" "bo_IN" "Tibetan, India"
"FALSE" "br_FR" "Breton, France"
"FALSE" "brx_IN" "Bodo, India"
"FALSE" "bs_BA" "Bosnian, Bosnia & Herzegovina"
"FALSE" "byn_ER" "Blin, Eritrea"
"FALSE" "ca_AD" "Catalan, Andorra"
"FALSE" "ca_ES" "Catalan, Spain"
"FALSE" "ca_FR" "Catalan, France"
"FALSE" "ca_IT" "Catalan, Italy"
"FALSE" "ce_RU" "Chechen, Russia"
"FALSE" "chr_US" "Cherokee, United States"
"FALSE" "ckb_IQ" "Central Kurdish, Iraq"
"FALSE" "cmn_TW" "Mandarin Chinese, Taiwan"
"FALSE" "crh_UA" "Crimean Tatar, Ukraine"
"FALSE" "csb_PL" "Kashubian, Poland"
"FALSE" "cs_CZ" "Czech, Czech Republic"
"FALSE" "cv_RU" "Chuvash, Russia"
"FALSE" "cy_GB" "Welsh, United Kingdom"
"FALSE" "da_DK" "Danish, Denmark"
"FALSE" "de_AT" "Austrian German, Austria"
"FALSE" "de_BE" "German, Belgium"
"FALSE" "de_CH" "Swiss High German, Switzerland"
"FALSE" "de_DE" "German, Germany"
"FALSE" "de_IT" "German, Italy"
"FALSE" "de_LI" "German, Liechtenstein"
"FALSE" "de_LU" "German, Luxembourg"
"FALSE" "doi_IN" "Dogri, India"
"FALSE" "dsb_DE" "Lower Sorbian, Germany"
"FALSE" "dv_MV" "Divehi, Maldives"
"FALSE" "dz_BT" "Dzongkha, Bhutan"
"FALSE" "el_CY" "Greek, Cyprus"
"FALSE" "el_GR" "Greek, Greece"
"FALSE" "en_AG" "English, Antigua & Barbuda"
"FALSE" "en_AU" "Australian English, Australia"
"FALSE" "en_BW" "English, Botswana"
"FALSE" "en_CA" "Canadian English, Canada"
"FALSE" "en_DK" "English, Denmark"
"FALSE" "en_GB" "British English, United Kingdom"
"FALSE" "en_HK" "English, Hong Kong SAR China"
"FALSE" "en_IE" "English, Ireland"
"FALSE" "en_IL" "English, Israel"
"FALSE" "en_IN" "English, India"
"FALSE" "en_NG" "English, Nigeria"
"FALSE" "en_NZ" "English, New Zealand"
"FALSE" "en_PH" "English, Philippines"
"FALSE" "en_SC" "English, Seychelles"
"FALSE" "en_SG" "English, Singapore"
"FALSE" "en_ZA" "English, South Africa"
"FALSE" "en_ZM" "English, Zambia"
"FALSE" "en_ZW" "English, Zimbabwe"
"FALSE" "es_AR" "Spanish, Argentina"
"FALSE" "es_BO" "Spanish, Bolivia"
"FALSE" "es_CL" "Spanish, Chile"
"FALSE" "es_CO" "Spanish, Colombia"
"FALSE" "es_CR" "Spanish, Costa Rica"
"FALSE" "es_CU" "Spanish, Cuba"
"FALSE" "es_DO" "Spanish, Dominican Republic"
"FALSE" "es_EC" "Spanish, Ecuador"
"FALSE" "es_ES" "European Spanish, Spain"
"FALSE" "es_GT" "Spanish, Guatemala"
"FALSE" "es_HN" "Spanish, Honduras"
"FALSE" "es_MX" "Mexican Spanish, Mexico"
"FALSE" "es_NI" "Spanish, Nicaragua"
"FALSE" "es_PA" "Spanish, Panama"
"FALSE" "es_PE" "Spanish, Peru"
"FALSE" "es_PR" "Spanish, Puerto Rico"
"FALSE" "es_PY" "Spanish, Paraguay"
"FALSE" "es_SV" "Spanish, El Salvador"
"FALSE" "es_UY" "Spanish, Uruguay"
"FALSE" "es_VE" "Spanish, Venezuela"
"FALSE" "et_EE" "Estonian, Estonia"
"FALSE" "eu_ES" "Basque, Spain"
"FALSE" "fa_IR" "Persian, Iran"
"FALSE" "ff_SN" "Fulah, Senegal"
"FALSE" "fi_FI" "Finnish, Finland"
"FALSE" "fil_PH" "Filipino, Philippines"
"FALSE" "fo_FO" "Faroese, Faroe Islands"
"FALSE" "fr_BE" "French, Belgium"
"FALSE" "fr_CA" "Canadian French, Canada"
"FALSE" "fr_CH" "Swiss French, Switzerland"
"FALSE" "fr_FR" "French, France"
"FALSE" "fr_LU" "French, Luxembourg"
"FALSE" "fur_IT" "Friulian, Italy"
"FALSE" "fy_DE" "Western Frisian, Germany"
"FALSE" "fy_NL" "Western Frisian, Netherlands"
"FALSE" "ga_IE" "Irish, Ireland"
"FALSE" "gd_GB" "Scottish Gaelic, United Kingdom"
"FALSE" "gez_ER" "Geez, Eritrea"
"FALSE" "gez_ET" "Geez, Ethiopia"
"FALSE" "gl_ES" "Galician, Spain"
"FALSE" "gu_IN" "Gujarati, India"
"FALSE" "gv_GB" "Manx, United Kingdom"
"FALSE" "hak_TW" "Hakka Chinese, Taiwan"
"FALSE" "ha_NG" "Hausa, Nigeria"
"FALSE" "he_IL" "Hebrew, Israel"
"FALSE" "hif_FJ" "Fiji Hindi, Fiji"
"FALSE" "hi_IN" "Hindi, India"
"FALSE" "hne_IN" "Chhattisgarhi, India"
"FALSE" "hr_HR" "Croatian, Croatia"
"FALSE" "hsb_DE" "Upper Sorbian, Germany"
"FALSE" "ht_HT" "Haitian Creole, Haiti"
"FALSE" "hu_HU" "Hungarian, Hungary"
"FALSE" "hy_AM" "Armenian, Armenia"
"FALSE" "ia_FR" "Interlingua, France"
"FALSE" "id_ID" "Indonesian, Indonesia"
"FALSE" "ig_NG" "Igbo, Nigeria"
"FALSE" "ik_CA" "Inupiaq, Canada"
"FALSE" "is_IS" "Icelandic, Iceland"
"FALSE" "it_CH" "Italian, Switzerland"
"FALSE" "it_IT" "Italian, Italy"
"FALSE" "iu_CA" "Inuktitut, Canada"
"FALSE" "ja_JP" "Japanese, Japan"
"FALSE" "kab_DZ" "Kabyle, Algeria"
"FALSE" "ka_GE" "Georgian, Georgia"
"FALSE" "kk_KZ" "Kazakh, Kazakhstan"
"FALSE" "kl_GL" "Kalaallisut, Greenland"
"FALSE" "km_KH" "Khmer, Cambodia"
"FALSE" "kn_IN" "Kannada, India"
"FALSE" "kok_IN" "Konkani, India"
"FALSE" "ko_KR" "Korean, South Korea"
"FALSE" "ks_IN" "Kashmiri, India"
"FALSE" "ku_TR" "Kurdish, Turkey"
"FALSE" "kw_GB" "Cornish, United Kingdom"
"FALSE" "ky_KG" "Kyrgyz, Kyrgyzstan"
"FALSE" "lb_LU" "Luxembourgish, Luxembourg"
"FALSE" "lg_UG" "Ganda, Uganda"
"FALSE" "li_BE" "Limburgish, Belgium"
"FALSE" "lij_IT" "Ligurian, Italy"
"FALSE" "li_NL" "Limburgish, Netherlands"
"FALSE" "ln_CD" "Lingala, Democratic Republic of the Congo"
"FALSE" "lo_LA" "Lao, Laos"
"FALSE" "lt_LT" "Lithuanian, Lithuania"
"FALSE" "lv_LV" "Latvian, Latvia"
"FALSE" "lzh_TW" "Literary Chinese, Taiwan"
"FALSE" "mag_IN" "Magahi, India"
"FALSE" "mai_IN" "Maithili, India"
"FALSE" "mai_NP" "Maithili, Nepal"
"FALSE" "mfe_MU" "Morisyen, Mauritius"
"FALSE" "mg_MG" "Malagasy, Madagascar"
"FALSE" "mhr_RU" "Meadow Mari, Russia"
"FALSE" "mi_NZ" "Maori, New Zealand"
"FALSE" "miq_NI" "Miskito, Nicaragua"
"FALSE" "mjw_IN" "Karbi, India"
"FALSE" "mk_MK" "Macedonian, Macedonia"
"FALSE" "ml_IN" "Malayalam, India"
"FALSE" "mni_IN" "Manipuri, India"
"FALSE" "mn_MN" "Mongolian, Mongolia"
"FALSE" "mnw_MM" "Mon, Myanmar"
"FALSE" "mr_IN" "Marathi, India"
"FALSE" "ms_MY" "Malay, Malaysia"
"FALSE" "mt_MT" "Maltese, malta"
"FALSE" "my_MM" "Burmese, Myanmar (Burma)"
"FALSE" "nan_TW" "Min Nan Chinese, Taiwan"
"FALSE" "nb_NO" "Norwegian Bokm<U00E5>l, Norway"
"FALSE" "nds_DE" "Low German, Germany"
"FALSE" "nds_NL" "Low Saxon, Netherlands"
"FALSE" "ne_NP" "Nepali, Nepal"
"FALSE" "nhn_MX" "Central Nahuatl, Mexico"
"FALSE" "niu_NU" "Niuean, Niue"
"FALSE" "niu_NZ" "Niuean, New Zealand"
"FALSE" "nl_AW" "Dutch, Aruba"
"FALSE" "nl_BE" "Flemish, Belgium"
"FALSE" "nl_NL" "Dutch, Netherlands"
"FALSE" "nn_NO" "Norwegian Nynorsk, Norway"
"FALSE" "nr_ZA" "South Ndebele, South Africa"
"FALSE" "nso_ZA" "Northern Sotho, South Africa"
"FALSE" "oc_FR" "Occitan, France"
"FALSE" "om_ET" "Oromo, Ethiopia"
"FALSE" "om_KE" "Oromo, Kenya"
"FALSE" "or_IN" "Odia, India"
"FALSE" "os_RU" "Ossetic, Russia"
"FALSE" "pa_IN" "Punjabi, India"
"FALSE" "pap_AW" "Papiamento, Aruba"
"FALSE" "pap_CW" "Papiamento, Cura<U00E7>ao"
"FALSE" "pa_PK" "Punjabi, Pakistan"
"FALSE" "pl_PL" "Polish, Poland"
"FALSE" "ps_AF" "Pashto, Afghanistan"
"FALSE" "pt_BR" "Brazilian Portuguese, Brazil"
"FALSE" "pt_PT" "European Portuguese, Portugal"
"FALSE" "quz_PE" "Cusco Quechua, Peru"
"FALSE" "raj_IN" "Rajasthani, India"
"FALSE" "rif_MA" "Tarifit, Morocco"
"FALSE" "ro_RO" "Romanian, Romania"
"FALSE" "ru_RU" "Russian, Russia"
"FALSE" "ru_UA" "Russian, Ukraine"
"FALSE" "rw_RW" "Kinyarwanda, Rwanda"
"FALSE" "sah_RU" "Sakha, Russian Federation"
"FALSE" "sa_IN" "Sanskrit, India"
"FALSE" "sat_IN" "Santali, India"
"FALSE" "sc_IT" "Sardinian, Italy"
"FALSE" "sd_IN" "Sindhi, India"
"FALSE" "se_NO" "Northern Sami, Norway"
"FALSE" "sgs_LT" "Samogitian, Lithuania"
"FALSE" "shn_MM" "Shan, Myanmar"
"FALSE" "shs_CA" "Shuswap, Canada"
"FALSE" "sid_ET" "Sidamo, Ethiopia"
"FALSE" "si_LK" "Sinhala, Sri Lanka"
"FALSE" "sk_SK" "Slovak, Slovakia"
"FALSE" "sl_SI" "Slovenian, Slovenia"
"FALSE" "sm_WS" "Samoan, Samoa"
"FALSE" "so_DJ" "Somali, Djibouti"
"FALSE" "so_ET" "Somali, Ethiopia"
"FALSE" "so_KE" "Somali, Kenya"
"FALSE" "so_SO" "Somali, Somalia"
"FALSE" "sq_AL" "Albanian, Albania"
"FALSE" "sq_MK" "Albanian, Macedonia"
"FALSE" "sr_ME" "Serbian, Montenegro"
"FALSE" "sr_RS" "Serbian, Serbia"
"FALSE" "ss_ZA" "Swati, South Africa"
"FALSE" "st_ZA" "Southern Sotho, South Africa"
"FALSE" "sv_FI" "Swedish, Finland"
"FALSE" "sv_SE" "Swedish, Sweden"
"FALSE" "sw_KE" "Swahili, Kenya"
"FALSE" "sw_TZ" "Swahili, Tanzania"
"FALSE" "szl_PL" "Silesian, Poland"
"FALSE" "ta_IN" "Tamil, India"
"FALSE" "ta_LK" "Tamil, Sri Lanka"
"FALSE" "tcy_IN" "Tulu, India"
"FALSE" "te_IN" "Telugu, India"
"FALSE" "tg_TJ" "Tajik, Tajikistan"
"FALSE" "the_NP" "Chitwania Tharu, Nepal"
"FALSE" "th_TH" "Thai, Thailand"
"FALSE" "ti_ER" "Tigrinya, Eritrea"
"FALSE" "ti_ET" "Tigrinya, Ethiopia"
"FALSE" "tig_ER" "Tigre, Eritrea"
"FALSE" "tk_TM" "Turkmen, Turkmenistan"
"FALSE" "tl_PH" "Tagalog, Philippines"
"FALSE" "tn_ZA" "Tswana, South Africa"
"FALSE" "to_TO" "Tongan, Tonga"
"FALSE" "tpi_PG" "Tok Pisin, Papua New Guinea"
"FALSE" "tr_CY" "Turkish, Cyprus"
"FALSE" "tr_TR" "Turkish, Turkey"
"FALSE" "ts_ZA" "Tsonga, South Africa"
"FALSE" "tt_RU" "Tatar, Russia"
"FALSE" "ug_CN" "Uyghur, China"
"FALSE" "uk_UA" "Ukrainian, Ukraine"
"FALSE" "unm_US" "Unami Delaware, United States"
"FALSE" "ur_IN" "Urdu, India"
"FALSE" "ur_PK" "Urdu, Pakistan"
"FALSE" "uz_UZ" "Uzbek, Uzbekistan"
"FALSE" "ve_ZA" "Venda, South Africa"
"FALSE" "vi_VN" "Vietnamese, Vietnam"
"FALSE" "wa_BE" "Walloon, Belgium"
"FALSE" "wae_CH" "Walser, Switzerland"
"FALSE" "wal_ET" "Wolaytta, Ethiopia"
"FALSE" "wo_SN" "Wolof, Senegal"
"FALSE" "xh_ZA" "Xhosa, South Africa"
"FALSE" "yi_US" "Yiddish, United States"
"FALSE" "yo_NG" "Yoruba, Nigeria"
"FALSE" "yue_HK" "Cantonese, Hong Kong SAR China"
"FALSE" "yuw_PG" "Yau, Papua New Guinea"
"FALSE" "zh_CN" "Chinese, China"
"FALSE" "zh_HK" "Chinese, Hong Kong SAR China"
"FALSE" "zh_SG" "Chinese, Singapore"
"FALSE" "zh_TW" "Chinese, Taiwan"
"FALSE" "zu_ZA" "Zulu, South Africa"
"FALSE" "C" "Default locale"
)

available_keymaps=(
"TRUE" "us" "USA"
"FALSE" "ad" "Andorra"
"FALSE" "af" "Afghanistan"
"FALSE" "al" "Albania"
"FALSE" "am" "Armenia"
"FALSE" "ara" "Arabic"
"FALSE" "az" "Azerbaijan"
"FALSE" "ba" "Bosnia and Herzegovina"
"FALSE" "bd" "Bangladesh"
"FALSE" "be" "Belgium"
"FALSE" "bg" "Bulgaria"
"FALSE" "br" "Brazil"
"FALSE" "brai" "Braille"
"FALSE" "bt" "Bhutan"
"FALSE" "by" "Belarus"
"FALSE" "ca" "Canada"
"FALSE" "cd" "Congo, Democratic Republic of the"
"FALSE" "ch" "Switzerland"
"FALSE" "cn" "China"
"FALSE" "cz" "Czechia"
"FALSE" "de" "Germany"
"FALSE" "dk" "Denmark"
"FALSE" "ee" "Estonia"
"FALSE" "es" "Spain"
"FALSE" "et" "Ethiopia"
"FALSE" "fi" "Finland"
"FALSE" "fo" "Faroe Islands"
"FALSE" "fr" "France"
"FALSE" "gb" "United Kingdom"
"FALSE" "ge" "Georgia"
"FALSE" "gh" "Ghana"
"FALSE" "gn" "Guinea"
"FALSE" "gr" "Greece"
"FALSE" "hr" "Croatia"
"FALSE" "hu" "Hungary"
"FALSE" "ie" "Ireland"
"FALSE" "il" "Israel"
"FALSE" "in" "India"
"FALSE" "iq" "Iraq"
"FALSE" "ir" "Iran"
"FALSE" "is" "Iceland"
"FALSE" "it" "Italy"
"FALSE" "jp" "Japan"
"FALSE" "kg" "Kyrgyzstan"
"FALSE" "kh" "Cambodia"
"FALSE" "kr" "Korea, Republic of"
"FALSE" "kz" "Kazakhstan"
"FALSE" "la" "Laos"
"FALSE" "latam" "Latin American"
"FALSE" "lk" "Sri Lanka"
"FALSE" "lt" "Lithuania"
"FALSE" "lv" "Latvia"
"FALSE" "ma" "Morocco"
"FALSE" "mao" "Maori"
"FALSE" "me" "Montenegro"
"FALSE" "mk" "Macedonia"
"FALSE" "ml" "Mali"
"FALSE" "mm" "Myanmar"
"FALSE" "mn" "Mongolia"
"FALSE" "mt" "Malta"
"FALSE" "mv" "Maldives"
"FALSE" "ng" "Nigeria"
"FALSE" "nl" "Netherlands"
"FALSE" "no" "Norway"
"FALSE" "np" "Nepal"
"FALSE" "pk" "Pakistan"
"FALSE" "pl" "Poland"
"FALSE" "pt" "Portugal"
"FALSE" "ro" "Romania"
"FALSE" "rs" "Serbia"
"FALSE" "ru" "Russia"
"FALSE" "se" "Sweden"
"FALSE" "si" "Slovenia"
"FALSE" "sk" "Slovakia"
"FALSE" "sn" "Senegal"
"FALSE" "sy" "Syria"
"FALSE" "th" "Thailand"
"FALSE" "tj" "Tajikistan"
"FALSE" "tm" "Turkmenistan"
"FALSE" "tr" "Turkey"
"FALSE" "tw" "Taiwan"
"FALSE" "tz" "Tanzania"
"FALSE" "ua" "Ukraine"
"FALSE" "uz" "Uzbekistan"
"FALSE" "vn" "Vietnam"
"FALSE" "za" "South Africa"
)

available_timezones=(
"TRUE" "UTC"
"FALSE" "Africa/Abidjan"
"FALSE" "Africa/Accra"
"FALSE" "Africa/Addis_Ababa"
"FALSE" "Africa/Algiers"
"FALSE" "Africa/Asmara"
"FALSE" "Africa/Asmera"
"FALSE" "Africa/Bamako"
"FALSE" "Africa/Bangui"
"FALSE" "Africa/Banjul"
"FALSE" "Africa/Bissau"
"FALSE" "Africa/Blantyre"
"FALSE" "Africa/Brazzaville"
"FALSE" "Africa/Bujumbura"
"FALSE" "Africa/Cairo"
"FALSE" "Africa/Casablanca"
"FALSE" "Africa/Ceuta"
"FALSE" "Africa/Conakry"
"FALSE" "Africa/Dakar"
"FALSE" "Africa/Dar_es_Salaam"
"FALSE" "Africa/Djibouti"
"FALSE" "Africa/Douala"
"FALSE" "Africa/El_Aaiun"
"FALSE" "Africa/Freetown"
"FALSE" "Africa/Gaborone"
"FALSE" "Africa/Harare"
"FALSE" "Africa/Johannesburg"
"FALSE" "Africa/Juba"
"FALSE" "Africa/Kampala"
"FALSE" "Africa/Khartoum"
"FALSE" "Africa/Kigali"
"FALSE" "Africa/Kinshasa"
"FALSE" "Africa/Lagos"
"FALSE" "Africa/Libreville"
"FALSE" "Africa/Lome"
"FALSE" "Africa/Luanda"
"FALSE" "Africa/Lubumbashi"
"FALSE" "Africa/Lusaka"
"FALSE" "Africa/Malabo"
"FALSE" "Africa/Maputo"
"FALSE" "Africa/Maseru"
"FALSE" "Africa/Mbabane"
"FALSE" "Africa/Mogadishu"
"FALSE" "Africa/Monrovia"
"FALSE" "Africa/Nairobi"
"FALSE" "Africa/Ndjamena"
"FALSE" "Africa/Niamey"
"FALSE" "Africa/Nouakchott"
"FALSE" "Africa/Ouagadougou"
"FALSE" "Africa/Porto-Novo"
"FALSE" "Africa/Sao_Tome"
"FALSE" "Africa/Timbuktu"
"FALSE" "Africa/Tripoli"
"FALSE" "Africa/Tunis"
"FALSE" "Africa/Windhoek"
"FALSE" "America/Adak"
"FALSE" "America/Anchorage"
"FALSE" "America/Anguilla"
"FALSE" "America/Antigua"
"FALSE" "America/Araguaina"
"FALSE" "America/Argentina/Buenos_Aires"
"FALSE" "America/Argentina/Catamarca"
"FALSE" "America/Argentina/ComodRivadavia"
"FALSE" "America/Argentina/Cordoba"
"FALSE" "America/Argentina/Jujuy"
"FALSE" "America/Argentina/La_Rioja"
"FALSE" "America/Argentina/Mendoza"
"FALSE" "America/Argentina/Rio_Gallegos"
"FALSE" "America/Argentina/Salta"
"FALSE" "America/Argentina/San_Juan"
"FALSE" "America/Argentina/San_Luis"
"FALSE" "America/Argentina/Tucuman"
"FALSE" "America/Argentina/Ushuaia"
"FALSE" "America/Aruba"
"FALSE" "America/Asuncion"
"FALSE" "America/Atikokan"
"FALSE" "America/Atka"
"FALSE" "America/Bahia"
"FALSE" "America/Bahia_Banderas"
"FALSE" "America/Barbados"
"FALSE" "America/Belem"
"FALSE" "America/Belize"
"FALSE" "America/Blanc-Sablon"
"FALSE" "America/Boa_Vista"
"FALSE" "America/Bogota"
"FALSE" "America/Boise"
"FALSE" "America/Buenos_Aires"
"FALSE" "America/Cambridge_Bay"
"FALSE" "America/Campo_Grande"
"FALSE" "America/Cancun"
"FALSE" "America/Caracas"
"FALSE" "America/Catamarca"
"FALSE" "America/Cayenne"
"FALSE" "America/Cayman"
"FALSE" "America/Chicago"
"FALSE" "America/Chihuahua"
"FALSE" "America/Ciudad_Juarez"
"FALSE" "America/Coral_Harbour"
"FALSE" "America/Cordoba"
"FALSE" "America/Costa_Rica"
"FALSE" "America/Creston"
"FALSE" "America/Cuiaba"
"FALSE" "America/Curacao"
"FALSE" "America/Danmarkshavn"
"FALSE" "America/Dawson"
"FALSE" "America/Dawson_Creek"
"FALSE" "America/Denver"
"FALSE" "America/Detroit"
"FALSE" "America/Dominica"
"FALSE" "America/Edmonton"
"FALSE" "America/Eirunepe"
"FALSE" "America/El_Salvador"
"FALSE" "America/Ensenada"
"FALSE" "America/Fort_Nelson"
"FALSE" "America/Fort_Wayne"
"FALSE" "America/Fortaleza"
"FALSE" "America/Glace_Bay"
"FALSE" "America/Godthab"
"FALSE" "America/Goose_Bay"
"FALSE" "America/Grand_Turk"
"FALSE" "America/Grenada"
"FALSE" "America/Guadeloupe"
"FALSE" "America/Guatemala"
"FALSE" "America/Guayaquil"
"FALSE" "America/Guyana"
"FALSE" "America/Halifax"
"FALSE" "America/Havana"
"FALSE" "America/Hermosillo"
"FALSE" "America/Indiana/Indianapolis"
"FALSE" "America/Indiana/Knox"
"FALSE" "America/Indiana/Marengo"
"FALSE" "America/Indiana/Petersburg"
"FALSE" "America/Indiana/Tell_City"
"FALSE" "America/Indiana/Vevay"
"FALSE" "America/Indiana/Vincennes"
"FALSE" "America/Indiana/Winamac"
"FALSE" "America/Indianapolis"
"FALSE" "America/Inuvik"
"FALSE" "America/Iqaluit"
"FALSE" "America/Jamaica"
"FALSE" "America/Jujuy"
"FALSE" "America/Juneau"
"FALSE" "America/Kentucky/Louisville"
"FALSE" "America/Kentucky/Monticello"
"FALSE" "America/Knox_IN"
"FALSE" "America/Kralendijk"
"FALSE" "America/La_Paz"
"FALSE" "America/Lima"
"FALSE" "America/Los_Angeles"
"FALSE" "America/Louisville"
"FALSE" "America/Lower_Princes"
"FALSE" "America/Maceio"
"FALSE" "America/Managua"
"FALSE" "America/Manaus"
"FALSE" "America/Marigot"
"FALSE" "America/Martinique"
"FALSE" "America/Matamoros"
"FALSE" "America/Mazatlan"
"FALSE" "America/Mendoza"
"FALSE" "America/Menominee"
"FALSE" "America/Merida"
"FALSE" "America/Metlakatla"
"FALSE" "America/Mexico_City"
"FALSE" "America/Miquelon"
"FALSE" "America/Moncton"
"FALSE" "America/Monterrey"
"FALSE" "America/Montevideo"
"FALSE" "America/Montreal"
"FALSE" "America/Montserrat"
"FALSE" "America/Nassau"
"FALSE" "America/New_York"
"FALSE" "America/Nipigon"
"FALSE" "America/Nome"
"FALSE" "America/Noronha"
"FALSE" "America/North_Dakota/Beulah"
"FALSE" "America/North_Dakota/Center"
"FALSE" "America/North_Dakota/New_Salem"
"FALSE" "America/Nuuk"
"FALSE" "America/Ojinaga"
"FALSE" "America/Panama"
"FALSE" "America/Pangnirtung"
"FALSE" "America/Paramaribo"
"FALSE" "America/Phoenix"
"FALSE" "America/Port-au-Prince"
"FALSE" "America/Port_of_Spain"
"FALSE" "America/Porto_Acre"
"FALSE" "America/Porto_Velho"
"FALSE" "America/Puerto_Rico"
"FALSE" "America/Punta_Arenas"
"FALSE" "America/Rainy_River"
"FALSE" "America/Rankin_Inlet"
"FALSE" "America/Recife"
"FALSE" "America/Regina"
"FALSE" "America/Resolute"
"FALSE" "America/Rio_Branco"
"FALSE" "America/Rosario"
"FALSE" "America/Santa_Isabel"
"FALSE" "America/Santarem"
"FALSE" "America/Santiago"
"FALSE" "America/Santo_Domingo"
"FALSE" "America/Sao_Paulo"
"FALSE" "America/Scoresbysund"
"FALSE" "America/Shiprock"
"FALSE" "America/Sitka"
"FALSE" "America/St_Barthelemy"
"FALSE" "America/St_Johns"
"FALSE" "America/St_Kitts"
"FALSE" "America/St_Lucia"
"FALSE" "America/St_Thomas"
"FALSE" "America/St_Vincent"
"FALSE" "America/Swift_Current"
"FALSE" "America/Tegucigalpa"
"FALSE" "America/Thule"
"FALSE" "America/Thunder_Bay"
"FALSE" "America/Tijuana"
"FALSE" "America/Toronto"
"FALSE" "America/Tortola"
"FALSE" "America/Vancouver"
"FALSE" "America/Virgin"
"FALSE" "America/Whitehorse"
"FALSE" "America/Winnipeg"
"FALSE" "America/Yakutat"
"FALSE" "America/Yellowknife"
"FALSE" "Antarctica/Casey"
"FALSE" "Antarctica/Davis"
"FALSE" "Antarctica/DumontDUrville"
"FALSE" "Antarctica/Macquarie"
"FALSE" "Antarctica/Mawson"
"FALSE" "Antarctica/McMurdo"
"FALSE" "Antarctica/Palmer"
"FALSE" "Antarctica/Rothera"
"FALSE" "Antarctica/South_Pole"
"FALSE" "Antarctica/Syowa"
"FALSE" "Antarctica/Troll"
"FALSE" "Antarctica/Vostok"
"FALSE" "Arctic/Longyearbyen"
"FALSE" "Asia/Aden"
"FALSE" "Asia/Almaty"
"FALSE" "Asia/Amman"
"FALSE" "Asia/Anadyr"
"FALSE" "Asia/Aqtau"
"FALSE" "Asia/Aqtobe"
"FALSE" "Asia/Ashgabat"
"FALSE" "Asia/Ashkhabad"
"FALSE" "Asia/Atyrau"
"FALSE" "Asia/Baghdad"
"FALSE" "Asia/Bahrain"
"FALSE" "Asia/Baku"
"FALSE" "Asia/Bangkok"
"FALSE" "Asia/Barnaul"
"FALSE" "Asia/Beirut"
"FALSE" "Asia/Bishkek"
"FALSE" "Asia/Brunei"
"FALSE" "Asia/Calcutta"
"FALSE" "Asia/Chita"
"FALSE" "Asia/Choibalsan"
"FALSE" "Asia/Chongqing"
"FALSE" "Asia/Chungking"
"FALSE" "Asia/Colombo"
"FALSE" "Asia/Dacca"
"FALSE" "Asia/Damascus"
"FALSE" "Asia/Dhaka"
"FALSE" "Asia/Dili"
"FALSE" "Asia/Dubai"
"FALSE" "Asia/Dushanbe"
"FALSE" "Asia/Famagusta"
"FALSE" "Asia/Gaza"
"FALSE" "Asia/Harbin"
"FALSE" "Asia/Hebron"
"FALSE" "Asia/Ho_Chi_Minh"
"FALSE" "Asia/Hong_Kong"
"FALSE" "Asia/Hovd"
"FALSE" "Asia/Irkutsk"
"FALSE" "Asia/Istanbul"
"FALSE" "Asia/Jakarta"
"FALSE" "Asia/Jayapura"
"FALSE" "Asia/Jerusalem"
"FALSE" "Asia/Kabul"
"FALSE" "Asia/Kamchatka"
"FALSE" "Asia/Karachi"
"FALSE" "Asia/Kashgar"
"FALSE" "Asia/Kathmandu"
"FALSE" "Asia/Katmandu"
"FALSE" "Asia/Khandyga"
"FALSE" "Asia/Kolkata"
"FALSE" "Asia/Krasnoyarsk"
"FALSE" "Asia/Kuala_Lumpur"
"FALSE" "Asia/Kuching"
"FALSE" "Asia/Kuwait"
"FALSE" "Asia/Macao"
"FALSE" "Asia/Macau"
"FALSE" "Asia/Magadan"
"FALSE" "Asia/Makassar"
"FALSE" "Asia/Manila"
"FALSE" "Asia/Muscat"
"FALSE" "Asia/Nicosia"
"FALSE" "Asia/Novokuznetsk"
"FALSE" "Asia/Novosibirsk"
"FALSE" "Asia/Omsk"
"FALSE" "Asia/Oral"
"FALSE" "Asia/Phnom_Penh"
"FALSE" "Asia/Pontianak"
"FALSE" "Asia/Pyongyang"
"FALSE" "Asia/Qatar"
"FALSE" "Asia/Qostanay"
"FALSE" "Asia/Qyzylorda"
"FALSE" "Asia/Rangoon"
"FALSE" "Asia/Riyadh"
"FALSE" "Asia/Saigon"
"FALSE" "Asia/Sakhalin"
"FALSE" "Asia/Samarkand"
"FALSE" "Asia/Seoul"
"FALSE" "Asia/Shanghai"
"FALSE" "Asia/Singapore"
"FALSE" "Asia/Srednekolymsk"
"FALSE" "Asia/Taipei"
"FALSE" "Asia/Tashkent"
"FALSE" "Asia/Tbilisi"
"FALSE" "Asia/Tehran"
"FALSE" "Asia/Tel_Aviv"
"FALSE" "Asia/Thimbu"
"FALSE" "Asia/Thimphu"
"FALSE" "Asia/Tokyo"
"FALSE" "Asia/Tomsk"
"FALSE" "Asia/Ujung_Pandang"
"FALSE" "Asia/Ulaanbaatar"
"FALSE" "Asia/Ulan_Bator"
"FALSE" "Asia/Urumqi"
"FALSE" "Asia/Ust-Nera"
"FALSE" "Asia/Vientiane"
"FALSE" "Asia/Vladivostok"
"FALSE" "Asia/Yakutsk"
"FALSE" "Asia/Yangon"
"FALSE" "Asia/Yekaterinburg"
"FALSE" "Asia/Yerevan"
"FALSE" "Atlantic/Azores"
"FALSE" "Atlantic/Bermuda"
"FALSE" "Atlantic/Canary"
"FALSE" "Atlantic/Cape_Verde"
"FALSE" "Atlantic/Faeroe"
"FALSE" "Atlantic/Faroe"
"FALSE" "Atlantic/Jan_Mayen"
"FALSE" "Atlantic/Madeira"
"FALSE" "Atlantic/Reykjavik"
"FALSE" "Atlantic/South_Georgia"
"FALSE" "Atlantic/St_Helena"
"FALSE" "Atlantic/Stanley"
"FALSE" "Australia/ACT"
"FALSE" "Australia/Adelaide"
"FALSE" "Australia/Brisbane"
"FALSE" "Australia/Broken_Hill"
"FALSE" "Australia/Canberra"
"FALSE" "Australia/Currie"
"FALSE" "Australia/Darwin"
"FALSE" "Australia/Eucla"
"FALSE" "Australia/Hobart"
"FALSE" "Australia/LHI"
"FALSE" "Australia/Lindeman"
"FALSE" "Australia/Lord_Howe"
"FALSE" "Australia/Melbourne"
"FALSE" "Australia/NSW"
"FALSE" "Australia/North"
"FALSE" "Australia/Perth"
"FALSE" "Australia/Queensland"
"FALSE" "Australia/South"
"FALSE" "Australia/Sydney"
"FALSE" "Australia/Tasmania"
"FALSE" "Australia/Victoria"
"FALSE" "Australia/West"
"FALSE" "Australia/Yancowinna"
"FALSE" "Brazil/Acre"
"FALSE" "Brazil/DeNoronha"
"FALSE" "Brazil/East"
"FALSE" "Brazil/West"
"FALSE" "CET"
"FALSE" "CST6CDT"
"FALSE" "Canada/Atlantic"
"FALSE" "Canada/Central"
"FALSE" "Canada/Eastern"
"FALSE" "Canada/Mountain"
"FALSE" "Canada/Newfoundland"
"FALSE" "Canada/Pacific"
"FALSE" "Canada/Saskatchewan"
"FALSE" "Canada/Yukon"
"FALSE" "Chile/Continental"
"FALSE" "Chile/EasterIsland"
"FALSE" "Cuba"
"FALSE" "EET"
"FALSE" "EST"
"FALSE" "EST5EDT"
"FALSE" "Egypt"
"FALSE" "Eire"
"FALSE" "Europe/Amsterdam"
"FALSE" "Europe/Andorra"
"FALSE" "Europe/Astrakhan"
"FALSE" "Europe/Athens"
"FALSE" "Europe/Belfast"
"FALSE" "Europe/Belgrade"
"FALSE" "Europe/Berlin"
"FALSE" "Europe/Bratislava"
"FALSE" "Europe/Brussels"
"FALSE" "Europe/Bucharest"
"FALSE" "Europe/Budapest"
"FALSE" "Europe/Busingen"
"FALSE" "Europe/Chisinau"
"FALSE" "Europe/Copenhagen"
"FALSE" "Europe/Dublin"
"FALSE" "Europe/Gibraltar"
"FALSE" "Europe/Guernsey"
"FALSE" "Europe/Helsinki"
"FALSE" "Europe/Isle_of_Man"
"FALSE" "Europe/Istanbul"
"FALSE" "Europe/Jersey"
"FALSE" "Europe/Kaliningrad"
"FALSE" "Europe/Kiev"
"FALSE" "Europe/Kirov"
"FALSE" "Europe/Kyiv"
"FALSE" "Europe/Lisbon"
"FALSE" "Europe/Ljubljana"
"FALSE" "Europe/London"
"FALSE" "Europe/Luxembourg"
"FALSE" "Europe/Madrid"
"FALSE" "Europe/Malta"
"FALSE" "Europe/Mariehamn"
"FALSE" "Europe/Minsk"
"FALSE" "Europe/Monaco"
"FALSE" "Europe/Moscow"
"FALSE" "Europe/Nicosia"
"FALSE" "Europe/Oslo"
"FALSE" "Europe/Paris"
"FALSE" "Europe/Podgorica"
"FALSE" "Europe/Prague"
"FALSE" "Europe/Riga"
"FALSE" "Europe/Rome"
"FALSE" "Europe/Samara"
"FALSE" "Europe/San_Marino"
"FALSE" "Europe/Sarajevo"
"FALSE" "Europe/Saratov"
"FALSE" "Europe/Simferopol"
"FALSE" "Europe/Skopje"
"FALSE" "Europe/Sofia"
"FALSE" "Europe/Stockholm"
"FALSE" "Europe/Tallinn"
"FALSE" "Europe/Tirane"
"FALSE" "Europe/Tiraspol"
"FALSE" "Europe/Ulyanovsk"
"FALSE" "Europe/Uzhgorod"
"FALSE" "Europe/Vaduz"
"FALSE" "Europe/Vatican"
"FALSE" "Europe/Vienna"
"FALSE" "Europe/Vilnius"
"FALSE" "Europe/Volgograd"
"FALSE" "Europe/Warsaw"
"FALSE" "Europe/Zagreb"
"FALSE" "Europe/Zaporozhye"
"FALSE" "Europe/Zurich"
"FALSE" "Factory"
"FALSE" "GB"
"FALSE" "GB-Eire"
"FALSE" "GMT"
"FALSE" "GMT+0"
"FALSE" "GMT-0"
"FALSE" "GMT0"
"FALSE" "Greenwich"
"FALSE" "HST"
"FALSE" "Hongkong"
"FALSE" "Iceland"
"FALSE" "Indian/Antananarivo"
"FALSE" "Indian/Chagos"
"FALSE" "Indian/Christmas"
"FALSE" "Indian/Cocos"
"FALSE" "Indian/Comoro"
"FALSE" "Indian/Kerguelen"
"FALSE" "Indian/Mahe"
"FALSE" "Indian/Maldives"
"FALSE" "Indian/Mauritius"
"FALSE" "Indian/Mayotte"
"FALSE" "Indian/Reunion"
"FALSE" "Iran"
"FALSE" "Israel"
"FALSE" "Jamaica"
"FALSE" "Japan"
"FALSE" "Kwajalein"
"FALSE" "Libya"
"FALSE" "MET"
"FALSE" "MST"
"FALSE" "MST7MDT"
"FALSE" "Mexico/BajaNorte"
"FALSE" "Mexico/BajaSur"
"FALSE" "Mexico/General"
"FALSE" "NZ"
"FALSE" "NZ-CHAT"
"FALSE" "Navajo"
"FALSE" "PRC"
"FALSE" "PST8PDT"
"FALSE" "Pacific/Apia"
"FALSE" "Pacific/Auckland"
"FALSE" "Pacific/Bougainville"
"FALSE" "Pacific/Chatham"
"FALSE" "Pacific/Chuuk"
"FALSE" "Pacific/Easter"
"FALSE" "Pacific/Efate"
"FALSE" "Pacific/Enderbury"
"FALSE" "Pacific/Fakaofo"
"FALSE" "Pacific/Fiji"
"FALSE" "Pacific/Funafuti"
"FALSE" "Pacific/Galapagos"
"FALSE" "Pacific/Gambier"
"FALSE" "Pacific/Guadalcanal"
"FALSE" "Pacific/Guam"
"FALSE" "Pacific/Honolulu"
"FALSE" "Pacific/Johnston"
"FALSE" "Pacific/Kanton"
"FALSE" "Pacific/Kiritimati"
"FALSE" "Pacific/Kosrae"
"FALSE" "Pacific/Kwajalein"
"FALSE" "Pacific/Majuro"
"FALSE" "Pacific/Marquesas"
"FALSE" "Pacific/Midway"
"FALSE" "Pacific/Nauru"
"FALSE" "Pacific/Niue"
"FALSE" "Pacific/Norfolk"
"FALSE" "Pacific/Noumea"
"FALSE" "Pacific/Pago_Pago"
"FALSE" "Pacific/Palau"
"FALSE" "Pacific/Pitcairn"
"FALSE" "Pacific/Pohnpei"
"FALSE" "Pacific/Ponape"
"FALSE" "Pacific/Port_Moresby"
"FALSE" "Pacific/Rarotonga"
"FALSE" "Pacific/Saipan"
"FALSE" "Pacific/Samoa"
"FALSE" "Pacific/Tahiti"
"FALSE" "Pacific/Tarawa"
"FALSE" "Pacific/Tongatapu"
"FALSE" "Pacific/Truk"
"FALSE" "Pacific/Wake"
"FALSE" "Pacific/Wallis"
"FALSE" "Pacific/Yap"
"FALSE" "Poland"
"FALSE" "Portugal"
"FALSE" "ROC"
"FALSE" "ROK"
"FALSE" "Singapore"
"FALSE" "Turkey"
"FALSE" "UCT"
"FALSE" "US/Alaska"
"FALSE" "US/Aleutian"
"FALSE" "US/Arizona"
"FALSE" "US/Central"
"FALSE" "US/East-Indiana"
"FALSE" "US/Eastern"
"FALSE" "US/Hawaii"
"FALSE" "US/Indiana-Starke"
"FALSE" "US/Michigan"
"FALSE" "US/Mountain"
"FALSE" "US/Pacific"
"FALSE" "US/Samoa"
"FALSE" "Universal"
"FALSE" "W-SU"
"FALSE" "WET"
"FALSE" "Zulu"
)

chroot_AlmaLinux()
{
prepare_bootstrap="
dnf update -y
dnf install -y bash bash-completion bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
dnf install --installroot=/mnt --releasever / -y @core openssl tar
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
dnf install -y epel-release
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL*
dnf upgrade --refresh -y
dnf install -y kernel kernel-headers dkms linux-firmware iwl100-firmware iwl1000-firmware iwl105-firmware iwl135-firmware iwl2000-firmware iwl2030-firmware iwl3160-firmware iwl5000-firmware iwl5150-firmware iwl6000g2a-firmware iwl6000g2b-firmware iwl6050-firmware iwl7260-firmware wireless-regdb glibc-locale-source ntfs-3g bash sudo ModemManager NetworkManager-bluetooth NetworkManager-wifi wpa_supplicant bluez cryptsetup e2fsprogs ntfsprogs nano acpid curl thermald bash-completion gpg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr nss-mdns grub2-efi-x64 os-prober shim microcode_ctl mokutil dosfstools cpio
dnf --enablerepo=crb install -y almalinux-sb-certs
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

case "${desktop}" in
	'Full')
	default_session="gnome-wayland"
	install_desktop="
dnf install -y @\"Server with GUI\"
systemctl set-default graphical
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
if [ "${autologin}" == "Yes" ]; then
	if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
	echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\ndnf install -y ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Arch()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl reflector sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
reflector --latest 10 --threads 10 --connection-timeout 1 --download-timeout 1 --protocol https --completion-percent 90 --sort rate --save /etc/pacman.d/mirrorlist --verbose
pacstrap -G /mnt base base-devel
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
pacman-key --init
pacman-key --populate
pacman -Syu --noconfirm --needed linux linux-headers dkms linux-firmware sof-firmware wireless-regdb bash sudo modemmanager networkmanager wpa_supplicant bluez cryptsetup e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr grub os-prober shim amd-ucode intel-ucode sbsigntools mokutil dosfstools btrfs-progs cpio
systemctl enable bluetooth.service ModemManager.service NetworkManager.service
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-lib alsa-utils alsa-topology-conf alsa-ucm-conf at-spi2-core avahi cups nss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xorg-server"
basic_packages="gvfs packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adobe-source-code-pro-fonts adwaita-icon-theme breeze-gtk breeze-icons gnome-backgrounds materia-gtk-theme noto-fonts oxygen-icons papirus-icon-theme ttf-dejavu ttf-roboto"
specific_packages="archlinux-wallpaper"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter budgie-desktop nemo gnome-terminal network-manager-applet arc-gtk-theme gnome-control-center
systemctl enable lightdm.service
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter cinnamon gnome-terminal nemo network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Deepin')
	default_session="dde-x11"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter deepin deepin-terminal
systemctl enable lightdm.service
"
	;;
	'Deepin/Full')
	default_session="dde-x11"
	install_desktop="
pacman -S --noconfirm --overwrite \"*\" ${desktop_base} lightdm lightdm-slick-greeter deepin deepin-terminal deepin-extra
systemctl enable lightdm.service
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
systemctl disable NetworkManager.service
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter enlightenment connman terminology
systemctl enable lightdm.service connman.service
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gnome-shell gnome-control-center gnome-keyring gnome-terminal nautilus
systemctl enable gdm.service
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gnome
systemctl enable gdm.service
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter i3-wm i3lock i3status dmenu rxvt-unicode volumeicon network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxde-common lxde-icon-theme lxappearance lxpanel lxsession lxterminal openbox pcmanfm network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxde network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxqt-config lxqt-notificationd lxqt-panel lxqt-policykit lxqt-powermanagement lxqt-qtplugin lxqt-session lxqt-themes openbox pcmanfm-qt qterminal network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxqt network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter mate mate-terminal network-manager-applet blueman mate-media mate-power-manager
systemctl enable lightdm.service
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter mate mate-terminal mate-extra network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
	'Plasma')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard plasma-desktop plasma-nm plasma-pa kwin dolphin konsole bluedevil powerdevil systemsettings discover kwallet-pam packagekit-qt6
systemctl enable sddm.service
"
	;;
	'Plasma/Full')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard plasma dolphin konsole packagekit-qt6
systemctl enable sddm.service
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter xfce4 network-manager-applet blueman xfce4-pulseaudio-plugin
systemctl enable lightdm.service
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter xfce4 xfce4-goodies network-manager-applet blueman
systemctl enable lightdm.service
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/archlinux/small.png"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/archlinux/small.png"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
cat > '/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml' <<'XFCETHEME'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="IconThemeName" type="string" value="Papirus"/>
    <property name="ThemeName" type="string" value="Materia"/>
  </property>
</channel>
XFCETHEME
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		mkdir -p /etc/sddm.conf.d
		echo -e '[Theme]\nCurrent = breeze' > /etc/sddm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			echo -e '\n[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		if [ "${desktop}" == "Deepin" ] || [ "${desktop}" == "Deepin/Full" ]; then
			echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-deepin-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf		
		else
			echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-slick-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
			echo -e '[Greeter]\nbackground = /usr/share/backgrounds/archlinux/small.png\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		fi
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux linux-headers"
initramfs_type="initcpio"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\npacman -S --noconfirm ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Artix()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
curl -L https://gitea.artixlinux.org/packages/pacman/raw/branch/master/pacman.conf -o /etc/pacman_artix.conf
sed -i 's@SigLevel    = Required DatabaseOptional@SigLevel    = Never@g' /etc/pacman_artix.conf
sed -i 's@#RemoteFileSigLevel = Required@RemoteFileSigLevel = Optional@g' /etc/pacman_artix.conf
curl https://gitea.artixlinux.org/packages/artix-mirrorlist/raw/branch/master/mirrorlist -o /etc/pacman.d/mirrorlist
pacstrap -C /etc/pacman_artix.conf -G /mnt base base-devel elogind-runit
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
pacman-key --init
pacman-key --populate
pacman -Sy --noconfirm base runit-system runit elogind-runit mkinitcpio rsync nano lsb-release esysusers etmpfiles artix-branding-base artix-archlinux-support
echo -e "\n[extra]\nInclude = /etc/pacman.d/mirrorlist-arch\n\n[community]\nInclude = /etc/pacman.d/mirrorlist-arch\n\n#[multilib]\n#Include = /etc/pacman.d/mirrorlist-arch" >> /etc/pacman.conf
pacman -Syu --noconfirm linux linux-headers dkms linux-firmware sof-firmware wireless-regdb bash sudo modemmanager networkmanager networkmanager-runit wpa_supplicant bluez bluez-runit cryptsetup e2fsprogs ntfs-3g nano acpid acpid-runit curl thermald bash-completion gnupg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr grub os-prober shim amd-ucode intel-ucode sbsigntools mokutil dosfstools btrfs-progs cpio
ln -s /etc/runit/sv/bluetoothd /etc/runit/sv/NetworkManager /etc/runit/runsvdir/default/
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG audio,wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
cat >/etc/polkit-1/rules.d/50-org.freedesktop.NetworkManager.rules <<'NETWORKMANAGER'
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.freedesktop.NetworkManager.") == 0 && subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
NETWORKMANAGER
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

hardware_support="alsa-lib alsa-utils alsa-topology-conf alsa-ucm-conf at-spi2-core avahi avahi-runit cups cups-runit nss-mdns pulseaudio system-config-printer xorg-server"
basic_packages="gvfs packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adobe-source-code-pro-fonts adwaita-icon-theme breeze-gtk breeze-icons gnome-backgrounds materia-gtk-theme noto-fonts oxygen-icons papirus-icon-theme ttf-dejavu ttf-roboto"
specific_packages="artix-backgrounds artix-dark-theme artix-desktop-presets artix-gtk-presets artix-icons artix-qt-presets ttf-roboto-mono pamac"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="/etc/runit/sv/avahi-daemon /etc/runit/sv/cupsd"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit budgie-desktop nemo gnome-terminal network-manager-applet arc-gtk-theme gnome-control-center
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit cinnamon gnome-terminal nemo network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
rm /etc/runit/runsvdir/default/NetworkManager
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit enlightenment terminology connman connman-runit
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/sv/connmand /etc/runit/runsvdir/default/
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gdm-runit gnome-shell gnome-control-center gnome-keyring gnome-terminal nautilus
ln -s ${desktop_services} /etc/runit/sv/gdm /etc/runit/runsvdir/default/
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gdm-runit gnome
ln -s ${desktop_services} /etc/runit/sv/gdm /etc/runit/runsvdir/default/
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit i3-wm i3lock i3status dmenu rxvt-unicode volumeicon network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit lxde-common lxde-icon-theme lxappearance lxpanel lxsession lxterminal openbox pcmanfm network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit lxde network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit lxqt-config lxqt-notificationd lxqt-panel lxqt-policykit lxqt-powermanagement lxqt-qtplugin lxqt-session lxqt-themes openbox pcmanfm-qt qterminal network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit lxqt network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit mate mate-terminal network-manager-applet blueman mate-media mate-power-manager mate-applets
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit mate mate-terminal mate-extra network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Plasma')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard sddm-runit sddm-theme-artix plasma-desktop plasma-nm plasma-pa kwin dolphin konsole bluedevil powerdevil systemsettings discover kwallet-pam packagekit-qt6 falkon
ln -s ${desktop_services} /etc/runit/sv/sddm /etc/runit/runsvdir/default/
"
	;;
	'Plasma/Full')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard sddm-runit sddm-theme-artix plasma dolphin konsole packagekit-qt6 falkon
ln -s ${desktop_services} /etc/runit/sv/sddm /etc/runit/runsvdir/default/
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit xfce4 xfce4-whiskermenu-plugin network-manager-applet blueman xfce4-pulseaudio-plugin
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lightdm-runit xfce4 xfce4-goodies network-manager-applet blueman
ln -s ${desktop_services} /etc/runit/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/Artix_dna_spiral_dark.jpg"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/Artix_dna_spiral_dark.jpg"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
cat > '/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml' <<'XFCETHEME'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="IconThemeName" type="string" value="Papirus"/>
    <property name="ThemeName" type="string" value="Materia"/>
  </property>
</channel>
XFCETHEME
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		mkdir -p /etc/sddm.conf.d
		echo -e '[Theme]\nCurrent = artix' > /etc/sddm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			echo -e '\n[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-slick-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/Artix_dna_spiral_dark.jpg\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="initcpio"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\npacman -S --noconfirm ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_BlendOS()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl reflector sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
reflector --latest 10 --threads 10 --connection-timeout 1 --download-timeout 1 --protocol https --completion-percent 90 --sort rate --save /etc/pacman.d/mirrorlist --verbose
pacstrap -G /mnt base base-devel btrfs-progs cpio grub mkinitcpio ntfs-3g sbsigntools
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
/linuxloops/install_settings
rm /linuxloops/install_settings
pacman-key --init
pacman-key --populate
mkdir -p /boot/grub
grub-mkconfig -o /boot/grub/grub.cfg
echo -e '[breakfast]\nSigLevel = Never\nServer = https://pkg-repo.blendos.co' >> /etc/pacman.conf
yes | pacman -Syu filesystem-blend akshara
ln -sf /run/NetworkManager/resolv.conf /etc/resolv.conf
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

if [ "${desktop}" == "None" ]; then
	install_desktop="
echo \"track: 'blendos-base'\" >> /system.yaml
"
else
	custom_packages="iptables accountsservice alsa-lib alsa-utils alsa-topology-conf alsa-ucm-conf at-spi2-core avahi cups nss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xorg-xhost xorg-server gvfs udisks2 polkit zstd fwupd adobe-source-code-pro-fonts adwaita-icon-theme breeze-gtk breeze-icons gnome-backgrounds materia-gtk-theme noto-fonts oxygen-icons papirus-icon-theme ttf-dejavu ttf-roboto archlinux-wallpaper flatpak plymouth-blend blend-web-store ${custom_packages}"
	case "${desktop}" in
		'Cinnamon')
		default_session="cinnamon"
		install_desktop="
echo \"track: 'cinnamon'\" >> /system.yaml
"
		custom_packages="gnome-terminal nemo network-manager-applet xdg-desktop-portal-gtk ${custom_packages}"
		;;
		'Gnome')
		default_session="gnome-wayland"
		install_desktop="
echo \"track: 'gnome'\" >> /system.yaml
"
		custom_packages="gnome-keyring gnome-terminal nautilus xdg-desktop-portal-gnome ${custom_packages}"
		;;
		'Lxqt')
		default_session="lxqt"
		install_desktop="
echo \"track: 'lxqt'\" >> /system.yaml
"
		custom_packages="network-manager-applet blueman xdg-desktop-portal-lxqt ${custom_packages}"
		;;
		'Mate')
		default_session="mate"
		install_desktop="
echo \"track: 'mate'\" >> /system.yaml
"
		custom_packages="mate-terminal mate-extra network-manager-applet blueman xdg-desktop-portal-gtk ${custom_packages}"
		;;
		'Plasma')
		default_session="plasmawayland"
		install_desktop="
echo \"track: 'plasma'\" >> /system.yaml
"
		custom_packages="dolphin konsole xdg-desktop-portal-kde ${custom_packages}"
		;;
		'Xfce')
		default_session="xfce"
		install_desktop="
echo \"track: 'xfce'\" >> /system.yaml
"
		custom_packages="blueman network-manager-applet xfce4-pulseaudio-plugin xdg-desktop-portal-gtk ${custom_packages}"
		;;
	esac
fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
mkdir -p /usr/etc
cat >/system.yaml <<'SYSTEMYAML'
repo: 'https://pkg-repo.blendos.co/'
impl: 'https://github.com/blend-os/tracks/raw/main'
SYSTEMYAML
${install_desktop}
# Add chaotic aur as a fix for outdated paru package in the BlendOS repo
echo -e "package-repos:\n    - name: 'chaotic-aur'\n      repo-url: 'https://cdn-mirror.chaotic.cx/\\\$repo/\\\$arch'" >> /system.yaml
echo -e "packages:\n  - 'btrfs-progs'\n  - 'glibc-locales'\n  - 'ntfs-3g'\n  - 'sbsigntools'\n  - 'xdg-user-dirs'" >> /system.yaml
if [ ! -z "${custom_packages}" ]; then for i in ${custom_packages}; do echo "  - '\${i}'" >> /system.yaml; done; fi
if [ "${nvidia}" == "Yes" ]; then echo "  - 'nvidia-dkms'" >> /system.yaml; fi
echo -e "aur-packages:\n  - 'shim-signed'" >> /system.yaml;
if [ "${encryption}" == "Yes" ]; then add_encryption="encrypt "; fi
cat >>/system.yaml <<SYSTEMYAML
commands:
  - 'ln -s /boot/linuxloops/initcpio-hook/linuxloops /etc/initcpio/install/linuxloops'
  - 'echo "HOOKS=(base udev autodetect keyboard keymap modconf block \${add_encryption}akshara filesystems fsck linuxloops)" > /etc/mkinitcpio.conf.d/linuxloops.conf'
  - 'if [ -f /proc/1/cwd/system.yaml ] && [ -d /proc/1/cwd/boot/linuxloops ]; then cp -r /proc/1/cwd/boot/linuxloops /boot/; fi'

$(cat /linuxloops/install_custom_script 2>/dev/null)
SYSTEMYAML
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
case "${desktop}" in
	'Gnome')
		mkdir -p /etc/gdm
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Lxqt')
		mkdir -p /etc/sddm.conf.d
		echo -e '[Theme]\nCurrent = breeze' > /etc/sddm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			echo -e '\n[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-gtk-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="initcpio"

if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_BlissOS()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion busybox bzip2 ca-certificates coreutils cpio cryptsetup curl dosfstools e2fsprogs efibootmgr gzip libarchive lsof nano ntfs-3g openssl sbsigntools sudo strace tar util-linux unzip xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
/linuxloops/install_script
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script <<INSTALL_SCRIPT
#!/bin/bash
set -e
mkdir -p /isomount/initramfs /isomount/iso
echo "Downloading BlissOS iso"
curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f "\$(curl https://sourceforge.net/projects/blissos-x86/files/Official/BlissOS${desktop}/ | tr '"' "\n" | grep "sourceforge.net/projects/.*iso/download" | head -1)" -o /root/bliss.iso || { echo -e "BlissOS image download failed."; exit 1; }
mount /root/bliss.iso /isomount/iso
install_folder="\$(cat /isomount/iso/efi/boot/android.cfg | grep 'title="' | cut -d' ' -f3)"
mkdir -p /mnt/android-"\${install_folder}"/data
cp /isomount/iso/initrd.img /mnt/android-"\${install_folder}"/
cp /isomount/iso/kernel /mnt/android-"\${install_folder}"/
if [ -f /isomount/iso/system.efs ]; then
	cp /isomount/iso/system.efs /mnt/android-"\${install_folder}"/
else
	cp /isomount/iso/system.sfs /mnt/android-"\${install_folder}"/
fi
cp -r /isomount/iso/boot /mnt/boot/efi/
cp -r /isomount/iso/efi /mnt/boot/efi/
cat >/mnt/boot/efi/boot/grub/grub.cfg <<BLISSCONFIG
set timeout=5
set debug_mode="(DEBUG mode)"
set kdir="/android-\${install_folder}"

source \\\$cmdpath/android.cfg
BLISSCONFIG
if [ "${install_type}" == "image" ]; then
	cd /isomount/initramfs
	mkdir -p ./usr/bin ./usr/local/bin ./usr/local/etc ./usr/local/lib ./usr/sbin
	for i in \$(ldd /usr/bin/blkid | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/blkid ./usr/local/bin/
	echo 'alias blkid="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/blkid"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/e2fsck | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/e2fsck ./usr/local/bin/
	echo 'alias e2fsck="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/e2fsck"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/losetup | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/losetup ./usr/local/bin/
	echo 'alias losetup="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/losetup"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/mkfs.ext4 | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/mkfs.ext4 ./usr/local/bin/
	echo 'alias mkfs.ext4="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/mkfs.ext4"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/modprobe | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/modprobe ./usr/local/bin/
	echo 'alias modprobe="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/modprobe"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/ntfs-3g | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/ntfs-3g ./usr/local/bin/
	echo 'alias ntfs-3g="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/ntfs-3g"' >> ./usr/local/etc/profile
	for i in \$(ldd /usr/bin/ntfsfix | cut -d' ' -f3); do cp "\${i}" ./usr/local/lib/; done
	cp -a /usr/bin/ntfsfix ./usr/local/bin/
	echo 'alias ntfsfix="LD_LIBRARY_PATH=/usr/local/lib /usr/local/lib/ld-linux-x86-64.so.2 /usr/local/bin/ntfsfix"' >> ./usr/local/etc/profile
	cp -a /usr/lib/ld-linux-x86-64.so.2 ./usr/local/lib/
	cp -a /usr/lib/libgcc_s.so.1 ./usr/local/lib/
	cat >./linuxloops <<'INITSCRIPT'
#!/bin/busybox sh

busybox mount -t proc none /proc
busybox mount -t sysfs none /sys
busybox --install -s
mkdir -p /dev/block
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

source /usr/local/etc/profile

if [ ! -z "\$linuxloops_debug" ] && [ "\$linuxloops_debug" -eq 1 ]; then
	echo 0 0 0 0 > /proc/sys/kernel/printk
	exec sh
fi

if { [ ! -z "\$img_uuid" ] || [ ! -z "\$img_part" ]; } && [ ! -z "\$img_path" ]; then
	linuxloops_timeout=0
	until false; do
		if [ ! -z "\$img_uuid" ]; then img_part="\$(blkid --match-token PARTUUID=\$img_uuid | cut -d':' -f1)"; fi
		echo "\$img_uuid | \$img_part"
		if [ -b "\$img_part" ]; then break; fi
		if [ \$linuxloops_timeout == 10 ]; then echo "The boot partition was not found, falling back to shell..." > /dev/kmsg; exec sh; fi
		linuxloops_timeout=\$(( \$linuxloops_timeout + 1 ))
		sleep 1
	done
else
	echo "The grub configuration is invalid, falling back to shell..." > /dev/kmsg
	exec sh
fi

if [ -e "\$img_part" ] && [ ! -z "\$img_path" ]; then
	mkdir /mainroot
	fstype=\$(blkid -s TYPE -o value "\$img_part")
	if [ "\$fstype" == "ntfs" ]; then
		ntfs-3g "\$img_part" /mainroot
	else
		mount -n "\$img_part" /mainroot
	fi
	if [ -f /mainroot/"\$img_path" ]; then
		if [ ! -b /dev/loop0 ]; then mknod -m660 /dev/loop0 b 7 0; fi
		losetup --direct-io=off -P /dev/loop0 /mainroot"\$img_path"
		bootdevice=/dev/loop0
	else
		echo "linuxloops: loopfile \$img_path not found on device \$img_part..." > /dev/kmsg
		exec sh
	fi
fi

sed -i 's@dirname \$BOOT_IMAGE@dirname \$BOOT_IMAGE | cut -d"/" -f2@g' /init
sed -i 's@\[hmnsvx]\[dmrv]\[0-9a-z]\*@loop0p2@g' /init

if [ ! -z "\$linuxloops_debug" ] && [ "\$linuxloops_debug" -eq 2 ]; then
	echo 0 0 0 0 > /proc/sys/kernel/printk
	exec sh
fi

HAS_CTTY=yes exec /init "\$@"
INITSCRIPT
	chmod 0755 ./linuxloops
	find . | cpio -o -H newc > /mnt/linuxloops.img
	cd ../..
	rm -r /isomount/initramfs
fi
umount /isomount/iso
rm /root/bliss.iso
INSTALL_SCRIPT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script
}

chroot_Brunch()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip libarchive lsof nano openssl sudo strace tar util-linux unzip xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
/linuxloops/install_script
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script <<INSTALL_SCRIPT
#!/bin/bash
set -e
case "$(echo ${desktop} | cut -d'/' -f2)" in
	'Bobba') board="octopus" ;;
	'Gumboz') board="zork" ;;
	'Jinlon') board="hatch" ;;
	'Reven') board="reven" ;;
	'Shyvana') board="rammus" ;;
	'Voxel') board="volteer" ;;
esac
mkdir -p /isomount/data /isomount/efi /isomount/rootc /isomount/tmp
mkfs.ext4 -E nodiscard -F -L "H-STATE" "${partition_path}"1
mount "${partition_path}"1 /isomount/data
if [ "\$(echo ${desktop} | cut -d'/' -f1)" == "Unstable" ]; then
	echo "Downloading Brunch unstable"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f \$(curl -L -s "https://api.github.com/repos/sebanc/brunch-unstable/releases/latest" | grep browser_download_url | tr -d '"' | sed 's#browser_download_url: ##g') -o /isomount/data/brunch.tar.gz || { echo -e "ChromeOS recovery image download failed."; exit 1; }
else
	echo "Downloading Brunch stable"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f \$(curl -L -s "https://api.github.com/repos/sebanc/brunch/releases/latest" | grep browser_download_url | tr -d '"' | sed 's#browser_download_url: ##g') -o /isomount/data/brunch.tar.gz || { echo -e "Brunch image download failed."; exit 1; }
fi
mkdir -p /isomount/data/brunch
tar zxf /isomount/data/brunch.tar.gz -C /isomount/data/brunch
rm /isomount/data/brunch.tar.gz
if [ "\${board}" == "reven" ]; then
	echo "Downloading ChromeOS-Flex recovery image"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f "\$(curl -L https://dl.google.com/dl/edgedl/chromeos/recovery/cloudready_recovery.conf | grep .bin.zip | tail -1 | cut -d'=' -f2)" -o /isomount/data/recovery.zip || { echo -e "ChromeOS recovery image download failed."; exit 1; }
else
	echo "Downloading ChromeOS recovery image"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f \$(curl -L https://dl.google.com/dl/edgedl/chromeos/recovery/recovery.conf | grep .bin.zip | cut -d'=' -f2 | grep "\$board" | sort -n | tail -1) -o /isomount/data/recovery.zip || { echo -e "ChromeOS recovery image download failed."; exit 1; }
fi
bsdtar -xvf /isomount/data/recovery.zip -C /root
rm -f /isomount/data/recovery.zip
isomount="\$(losetup --show -fP \$(ls /root/chromeos_*.bin))"
for (( i=1; i<=12; i++ )); do
	case \${i} in
		1)
			continue
		;;
		2)
			dd if="\${isomount}"p4 of="${partition_path}""\${i}" bs=1M conv=notrunc status=progress
			continue
		;;
		5)
			dd if="\${isomount}"p3 of="${partition_path}""\${i}" bs=1M conv=notrunc status=progress
			continue
		;;
		7)
			mount /isomount/data/brunch/rootc.img /isomount/tmp
			mkfs.ext4 -E nodiscard -F -L "ROOT-C" "${partition_path}""\${i}"
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir "${partition_path}""\${i}"; fi
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed "${partition_path}""\${i}"; fi
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file "${partition_path}""\${i}"; fi
			mount "${partition_path}""\${i}" /isomount/rootc
			cp -r /isomount/tmp/* /isomount/rootc/
			umount /isomount/rootc
			umount /isomount/tmp
			continue
		;;
		12)
			mount /isomount/data/brunch/efi_secure.img /isomount/tmp
			mkfs.fat -n 'EFI' "${partition_path}""\${i}"
			mount "${partition_path}""\${i}" /isomount/efi
			cp -r /isomount/tmp/* /isomount/efi/
			umount /isomount/efi
			umount /isomount/tmp
			continue
		;;
		6|9|10|11)
			continue
		;;
		*)
			part_source="\${i}"
		;;
	esac
	dd if="\${isomount}"p"\${part_source}" of="${partition_path}""\${i}" bs=1M conv=notrunc status=progress
done
losetup -d "\${isomount}"
rm -rf /isomount/data/*
umount /isomount/data
if [ "${install_type}" == "image" ]; then mkdir -p /mnt/etc/secureboot_key; curl -L https://github.com/sebanc/brunch/raw/main/brunch.der -o /mnt/etc/secureboot_key/MOK.der; fi
INSTALL_SCRIPT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script
}

chroot_ChromeOS-Flex()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion busybox bzip2 ca-certificates coreutils cpio cryptsetup curl dosfstools e2fsprogs efibootmgr gzip libarchive lsof nano ntfs-3g openssl sbsigntools sudo strace tar util-linux unzip xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
/linuxloops/install_script
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

if [ "${desktop}" == "Full/Devmode" ]; then dev_mode="cros_debug"; fi

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script <<INSTALL_SCRIPT
#!/bin/bash
set -e
mkdir -p /isomount/data /isomount/roota /isomount/rootc /isomount/efi /isomount/tmp
mkfs.ext4 -E nodiscard -F -L "H-STATE" "${partition_path}"1
mount "${partition_path}"1 /isomount/data
echo "Downloading ChromeOS-Flex recovery image"
curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f "\$(curl -L https://dl.google.com/dl/edgedl/chromeos/recovery/cloudready_recovery.conf | grep .bin.zip | tail -1 | cut -d'=' -f2)" -o /isomount/data/recovery.zip || { echo -e "ChromeOS recovery image download failed."; exit 1; }
bsdtar -xvf /isomount/data/recovery.zip -C /root || { echo -e "Failed to extract the recovery image."; return 1; }
rm -f /isomount/data/recovery.zip
isomount="\$(losetup --show -fP \$(ls /root/chromeos_*.bin))"
for (( i=1; i<=12; i++ )); do
	(echo "x"; echo "u"; echo "\${i}"; echo "\$(blkid -o value -s PARTUUID "\${isomount}"p"\${i}")"; echo "r"; sleep 5; echo "w") | fdisk "${destination_device}" || { echo -e "Partition UUID update failed. Exiting.\n"; exit 1; }
	case \${i} in
		1)
			continue
		;;
		7)
			mkfs.ext4 -E nodiscard -F -L "ROOT-C" "${partition_path}""\${i}"
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir "${partition_path}""\${i}"; fi
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed "${partition_path}""\${i}"; fi
			if tune2fs -l "${partition_path}""\${i}" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file "${partition_path}""\${i}"; fi
			continue
		;;
		12)
			mount "\${isomount}"p12 /isomount/tmp
			mkfs.fat -n 'EFI' "${partition_path}""\${i}"
			mount "${partition_path}""\${i}" /isomount/efi
			cp -r /isomount/tmp/* /isomount/efi/
			umount /isomount/efi
			umount /isomount/tmp
			continue
		;;
		*)
			part_source="\${i}"
		;;
	esac
	dd if="\${isomount}"p"\${part_source}" of="${partition_path}""\${i}" bs=1M conv=notrunc status=progress
done
losetup -d "\${isomount}"
rm -rf /isomount/data/*
umount /isomount/data
if [ "${install_type}" == "image" ]; then
	mount "${partition_path}"7 /isomount/rootc
	mkdir -p /isomount/rootc/initramfs
	cd /isomount/rootc/initramfs
	mkdir -p etc proc sys tmp usr/bin usr/lib usr/mbin usr/sbin
	ln -s /usr/bin bin
	ln -s /usr/lib lib
	ln -s /usr/lib lib64
	ln -s /usr/sbin sbin
	for i in \$(ldd /usr/bin/bash | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/bash ./usr/bin/
	for i in \$(ldd /usr/bin/busybox | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/busybox ./usr/bin/
	for i in \$(ldd /usr/bin/blkid | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/blkid ./usr/mbin/
	for i in \$(ldd /usr/bin/e2fsck | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/e2fsck ./usr/mbin/
	for i in \$(ldd /usr/bin/losetup | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/losetup ./usr/mbin/
	for i in \$(ldd /usr/bin/mkfs.ext4 | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/mkfs.ext4 ./usr/mbin/
	for i in \$(ldd /usr/bin/modprobe | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/modprobe ./usr/mbin/
	for i in \$(ldd /usr/bin/ntfs-3g | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/ntfs-3g ./usr/mbin/
	for i in \$(ldd /usr/bin/ntfsfix | cut -d' ' -f3); do cp "\${i}" ./usr/lib/; done
	cp -a /usr/bin/ntfsfix ./usr/mbin/
	cp -a /usr/lib/ld-linux-x86-64.so.2 ./usr/lib/
	cp -a /usr/lib/libgcc_s.so.1 ./usr/lib/
	cat >./init <<'INITSCRIPT'
#!/usr/bin/bash
export PATH=/usr/mbin:/usr/sbin:/usr/bin
export LD_LIBRARY_PATH=/usr/lib

busybox mount -t proc none /proc
busybox mount -t sysfs none /sys
busybox mount -t devtmpfs none /dev
busybox --install -s
ln -s /proc/mounts /etc/mtab

if [ ! -z "\$linuxloops_debug" ] && [ "\$linuxloops_debug" -eq 1 ]; then
	echo 0 0 0 0 > /proc/sys/kernel/printk
	exec sh
fi

if { [ ! -z "\$img_uuid" ] || [ ! -z "\$img_part" ]; } && [ ! -z "\$img_path" ]; then
	linuxloops_timeout=0
	until false; do
		if [ ! -z "\$img_uuid" ]; then img_part="\$(blkid --match-token PARTUUID=\$img_uuid | cut -d':' -f1)"; fi
		echo "\$img_uuid | \$img_part"
		if [ -b "\$img_part" ]; then break; fi
		if [ \$linuxloops_timeout == 10 ]; then echo "The boot partition was not found, falling back to shell..." > /dev/kmsg; exec sh; fi
		linuxloops_timeout=\$(( \$linuxloops_timeout + 1 ))
		sleep 1
	done
else
	echo "The grub configuration is invalid, falling back to shell..." > /dev/kmsg
	exec sh
fi

if [ -e "\$img_part" ] && [ ! -z "\$img_path" ]; then
	mkdir /mainroot
	fstype=\$(blkid -s TYPE -o value "\$img_part")
	if [ "\$fstype" == "ntfs" ]; then
		ntfs-3g "\$img_part" /mainroot
	else
		mount -n "\$img_part" /mainroot
	fi
	if [ -f /mainroot/"\$img_path" ]; then
		if [ ! -b /dev/loop0 ]; then mknod -m660 /dev/loop0 b 7 0; fi
		losetup --direct-io=off -P /dev/loop0 /mainroot"\$img_path"
		bootdevice=/dev/loop0
	else
		echo "linuxloops: ChromeOS loopfile \$img_path not found on device \$img_part..." > /dev/kmsg
		exec sh
	fi
fi

if [ ! -z "\$linuxloops_debug" ] && [ "\$linuxloops_debug" -eq 2 ]; then
	echo 0 0 0 0 > /proc/sys/kernel/printk
	exec sh
fi

if [ "\$bootimage" == "B" ]; then bootpart=5; else bootpart=3; fi
printf '\000' | dd of="\$bootdevice"p"\$bootpart" seek=\$((0x464 + 3)) conv=notrunc count=1 bs=1 status=none
mkdir -p chromeosroot
mount "\$bootdevice"p"\$bootpart" /chromeosroot

touch /chromeosroot/.nodelta
if [ ! -f /chromeosroot/usr/sbin/mount-encrypted.real ]; then
	mv /chromeosroot/usr/sbin/mount-encrypted /chromeosroot/usr/sbin/mount-encrypted.real
	cat >/chromeosroot/usr/sbin/mount-encrypted <<'MOUNTS'
#!/bin/bash
if [ \$# -eq 0 ]; then
	if ! mountpoint -q /var && ! mountpoint -q /home/chronos; then
		mkdir -p /mnt/stateful_partition/encrypted/var
		mount -n --bind /mnt/stateful_partition/encrypted/var /var || exit 1
		mkdir -p /mnt/stateful_partition/encrypted/chronos
		mount -n --bind /mnt/stateful_partition/encrypted/chronos /home/chronos || exit 1
	fi
else
	mount-encrypted.real "\$@"
fi
MOUNTS
	chmod 0755 /chromeosroot/usr/sbin/mount-encrypted
fi
if [ ! -f /chromeosroot/usr/bin/chroot.real ]; then
	mv /chromeosroot/usr/bin/chroot /chromeosroot/usr/bin/chroot.real
	cat >/chromeosroot/usr/bin/chroot <<'CHROOT'
#!/bin/bash
set -e
if [ "\$EUID" -eq 0 ] && [ "\${1}" == "." ] && [ "\${2}" == "/usr/bin/cros_installer" ]; then
	rootpath=\$(echo "\$(rootdev)" | sed 's/.\$//')
	rm -rf /mnt/stateful_partition/newroot /mnt/stateful_partition/rootc
	mkdir -p /mnt/stateful_partition/newroot /mnt/stateful_partition/rootc
	mount "\$rootpath"7 /mnt/stateful_partition/rootc
	find ./lib/firmware | bsdcpio -o -H newc > /mnt/stateful_partition/rootc/firmwares.img
	find ./lib/modules | bsdcpio -o -H newc > /mnt/stateful_partition/rootc/modules.img
	if [ "\$(rootdev)" == "\$rootpath"3 ]; then
		echo "bootimage=B" > /mnt/stateful_partition/rootc/bootimage.cfg
	else
		echo "bootimage=A" > /mnt/stateful_partition/rootc/bootimage.cfg
	fi
	umount /mnt/stateful_partition/rootc
	chroot.real "\$@"
else
	chroot.real "\$@"
fi
CHROOT
	chmod 0755 /chromeosroot/usr/bin/chroot
fi

umount /chromeosroot
printf '\377' | dd of="\$bootdevice"p"\$bootpart" seek=\$((0x464 + 3)) conv=notrunc count=1 bs=1 status=none
mount -o ro "\$bootdevice"p"\$bootpart" /chromeosroot

mount --move /dev /chromeosroot/dev
mount --move /sys /chromeosroot/sys
mount --move /proc /chromeosroot/proc

sync

if [ ! -z "\$linuxloops_debug" ] && [ "\$linuxloops_debug" -eq 3 ]; then
	echo 0 0 0 0 > /roota/proc/sys/kernel/printk
	exec sh
fi

exec switch_root /chromeosroot /sbin/init "\$@"
INITSCRIPT
	chmod 0755 ./init
	find . | cpio -o -H newc > /isomount/rootc/initramfs.img
	mount -o ro "${partition_path}"3 /isomount/roota
	(cd /isomount/roota; find ./lib/firmware | cpio -o -H newc > /isomount/rootc/firmwares.img)
	(cd /isomount/roota; find ./lib/modules | cpio -o -H newc > /isomount/rootc/modules.img)
	umount /isomount/roota
	cd ../../..
	rm -r /isomount/rootc/initramfs
	umount /isomount/rootc
fi
mount "${partition_path}"12 /isomount/efi
if [ "${desktop}" == "full-devmode" ]; then
	sed -i 's@defaultA=2@defaultA=0@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@defaultB=3@defaultB=1@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@menuentry "local image A" {@local_image_A="@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@menuentry "local image B" {@local_image_B="@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@menuentry "verified image A" {@verified_image_A="@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@menuentry "verified image B" {@verified_image_B="@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@menuentry "Alternate USB Boot" {@Alternate_USB_Boot="@g' /isomount/efi/efi/boot/grub.cfg
	sed -i 's@}@"@g' /isomount/efi/efi/boot/grub.cfg
	cat >>/isomount/efi/efi/boot/grub.cfg <<MODEDGRUB

menuentry "local image A" {
  \\\$local_image_A ${dev_mode}
}

menuentry "local image B" {
  \\\$local_image_B ${dev_mode}
}

menuentry "verified image A" {
  \\\$verified_image_A ${dev_mode}
}

menuentry "verified image B" {
  \\\$verified_image_B ${dev_mode}
}
MODEDGRUB
fi
if [ "${install_type}" == "image" ]; then
	mkdir -p /mnt/etc/secureboot_key
	sbattach --signum 1 --detach /mnt/etc/secureboot_key/MOK.tmp /isomount/efi/efi/boot/grubx64.efi
	openssl pkcs7 -print_certs -inform der -in /mnt/etc/secureboot_key/MOK.tmp -out /mnt/etc/secureboot_key/MOK.pem
	openssl x509 -outform DER -in /mnt/etc/secureboot_key/MOK.pem -out /mnt/etc/secureboot_key/MOK.der
fi
umount /isomount/efi
INSTALL_SCRIPT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script
}

chroot_Debian()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales bookworm /mnt http://deb.debian.org/debian
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware

deb http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware

deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode lsb-release sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="desktop-base plymouth-themes synaptic"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nemo gnome-terminal paper-icon-theme
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon cinnamon-core network-manager-gnome blueman gnome-terminal nemo
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop network-manager-gnome blueman
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-shell gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-icon-theme gnome-keyring libpam-gnome-keyring gnome-packagekit
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 task-gnome-desktop
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde-core lxterminal pcmanfm lxde-icon-theme network-manager-gnome blueman lxappearance
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxde-desktop network-manager-gnome blueman
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxqt-core qterminal pcmanfm-qt lxqt-theme-debian network-manager-gnome blueman openbox lxqt-powermanagement lxqt-themes
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxqt-desktop network-manager-gnome blueman
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mate-desktop mate-session-manager marco mate-control-center mate-notification-daemon mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja network-manager-gnome blueman mate-media mate-power-manager
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-mate-desktop blueman
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze kde-plasma-desktop plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze task-kde-desktop plasma-workspace-wayland
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager-plugins xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-xfce-desktop blueman
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/images/desktop-base/login-background.svg"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/images/desktop-base/login-background.svg"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
[org.mate.interface]
icon-theme='Papirus'
gtk-theme='Materia'
[org.mate.Marco.general]
theme='Materia'
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
cat > '/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml' <<'XFCETHEME'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="IconThemeName" type="string" value="Papirus"/>
    <property name="ThemeName" type="string" value="Materia"/>
  </property>
</channel>
XFCETHEME
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-headers-* linux-image-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Devuan()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales daedalus /mnt http://deb.devuan.org/merged
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://deb.devuan.org/merged daedalus main contrib non-free non-free-firmware
deb http://deb.devuan.org/merged daedalus-updates main contrib non-free non-free-firmware
deb http://deb.devuan.org/merged daedalus-security main contrib non-free non-free-firmware
#deb http://deb.devuan.org/merged daedalus-backports main contrib non-free non-free-firmware
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode lsb-release sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="desktop-base devuan-baseconf synaptic"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop budgie-desktop-view arc-theme nautilus gnome-terminal paper-icon-theme
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon network-manager-gnome blueman gnome-terminal nemo
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop network-manager-gnome blueman
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-shell gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-icon-theme gnome-keyring libpam-gnome-keyring gnome-packagekit
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 task-gnome-desktop
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde-core lxterminal pcmanfm lxde-icon-theme network-manager-gnome blueman lxappearance
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxde-desktop network-manager-gnome blueman
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxqt-core qterminal pcmanfm-qt lxqt-theme-debian network-manager-gnome blueman openbox lxqt-powermanagement lxqt-themes
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxqt-desktop network-manager-gnome blueman
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mate-desktop mate-session-manager marco mate-control-center mate-notification-daemon mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja network-manager-gnome blueman mate-media mate-power-manager
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-mate-desktop blueman
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze kde-plasma-desktop plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze task-kde-desktop plasma-workspace-wayland
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager-plugins xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-xfce-desktop blueman
yes | DEBIAN_FRONTEND=noninteractive apt purge slim
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/images/desktop-base/your-way_deepsea-wide-large.svg"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/images/desktop-base/your-way_deepsea-wide-large.svg"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		mkdir -p /etc/sddm.conf.d
		echo -e '[Theme]\nCurrent = breeze' > /etc/sddm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			echo -e '\n[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		echo -e '[Greeter]\nbackground = /usr/share/images/desktop-base/your-way_deepsea-wide-large.svg\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Elementary()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
yes | DEBIAN_FRONTEND=noninteractive apt install software-properties-common
echo -e 'Package: *\nPin: release o=LP-PPA-elementary-os-*\nPin-Priority: 1000' > /etc/apt/preferences.d/elementary.pref
add-apt-repository ppa:elementary-os/stable -y
add-apt-repository ppa:elementary-os/os-patches -y
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed update-manager-core sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

case "${desktop}" in
	'Full')
	default_session="pantheon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install pantheon-greeter elementary-desktop
yes | DEBIAN_FRONTEND=noninteractive apt purge gdm3 ubuntu-session
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
if [ "${autologin}" == "Yes" ]; then
	groupadd -r autologin
	usermod -aG autologin '${username}'
	mkdir -p /etc/lightdm/lightdm.conf.d
	echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Fedora()
{
prepare_bootstrap="
dnf update -y
dnf install -y bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
dnf install --installroot=/mnt --releasever 40 -y @core grubby openssl tar gstreamer1-plugins-bad-free gstreamer1-plugins-ugly-free
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-\$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-\$(rpm -E %fedora).noarch.rpm
dnf groupupdate -y core
dnf upgrade --refresh -y
dnf install -y kernel kernel-headers akmods dkms linux-firmware iwl100-firmware iwl1000-firmware iwl105-firmware iwl135-firmware iwl2000-firmware iwl2030-firmware iwl3160-firmware iwl5000-firmware iwl5150-firmware iwl6000g2a-firmware iwl6000g2b-firmware iwl6050-firmware iwl7260-firmware wireless-regdb glibc-locale-source ntfs-3g bash sudo ModemManager NetworkManager-bluetooth NetworkManager-tui NetworkManager-wifi wpa_supplicant bluez cryptsetup e2fsprogs ntfsprogs nano acpid curl thermald bash-completion gpg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr nss-mdns grub2-efi-x64 os-prober shim microcode_ctl sbsigntools mokutil selinux-policy-targeted dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-lib alsa-utils alsa-sof-firmware alsa-topology at-spi2-core avahi cups cups-browsed nss-mdns system-config-printer xorg-x11-drivers"
basic_packages="gvfs-fuse PackageKit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk breeze-icon-theme dejavu-sans-fonts google-noto-sans-fonts google-roboto-fonts gnome-backgrounds materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="dnfdragora dnf-plugin-system-upgrade f39-backgrounds plymouth-system-theme"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter budgie-desktop budgie-desktop-defaults gnome-terminal nemo blueman dnfdragora-updater
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @budgie-desktop @budgie-desktop-apps dnfdragora-updater
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter cinnamon clutter-gtk gnome-terminal nemo paper-icon-theme blueman dnfdragora-updater
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @cinnamon-desktop-environment dnfdragora-updater
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
dnf install -y ${desktop_base} gdm gnome-shell nautilus gnome-terminal gnome-software gnome-keyring gnome-keyring-pam
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
dnf install -y ${desktop_base} gdm @gnome-desktop
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @i3 volumeicon network-manager-applet blueman dnfdragora-updater
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @lxde-desktop-environment lxde-icon-theme blueman dnfdragora-updater
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @lxqt-desktop-environment lxqt-themes blueman
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter mate-desktop marco network-manager-applet blueman mate-session-manager mate-media mate-power-manager caja mate-terminal mate-themes libgnome-keyring dnfdragora-updater
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @mate-desktop-environment dnfdragora-updater
"
	;;
	'Plasma')
	default_session="plasma"
	install_desktop="
dnf install -y ${desktop_base} sddm sddm-breeze plasma-desktop plasma-discover plasma-nm bluedevil dolphin konsole pam-kwallet
"
	;;
	'Plasma/Full')
	default_session="plasma"
	install_desktop="
dnf install -y ${desktop_base} sddm sddm-breeze @kde-desktop-environment
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter xfdesktop xfce4-session xfce4-settings xfce4-notifyd yaru-theme network-manager-applet blueman thunar xfce4-appfinder xfce4-pulseaudio-plugin xfce4-power-manager xfce4-terminal  xfce4-settings libgnome-keyring dnfdragora-updater
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
dnf install -y ${desktop_base} lightdm slick-greeter @xfce-desktop-environment dnfdragora-updater
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.mate.interface]
icon-theme='Papirus-Light'
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
cat > '/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml' <<'XFCETHEME'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="IconThemeName" type="string" value="Papirus"/>
    <property name="ThemeName" type="string" value="Materia-dark"/>
  </property>
</channel>
XFCETHEME
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/default.png\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\ndnf install -y ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Gentoo()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl reflector sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
if [ "$(echo ${desktop} | cut -d '/' -f2)" == "Openrc" ]; then
	echo "Downloading Gentoo stage 3"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f https://gentoo.osuosl.org/releases/amd64/autobuilds/"\$(curl -L https://gentoo.osuosl.org/releases/amd64/autobuilds/latest-stage3-amd64-openrc.txt | grep 'stage3' | cut -d' ' -f1)" -o /gentoo-stage3.tar.xz || { echo -e "Gentoo stage 3 image download failed."; exit 1; }
else
	echo "Downloading Gentoo stage 3"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f https://gentoo.osuosl.org/releases/amd64/autobuilds/"\$(curl -L https://gentoo.osuosl.org/releases/amd64/autobuilds/latest-stage3-amd64-systemd.txt | grep 'stage3' | cut -d' ' -f1)" -o /gentoo-stage3.tar.xz || { echo -e "Gentoo stage 3 image download failed."; exit 1; }
fi
tar xf /gentoo-stage3.tar.xz -C /mnt
rm /gentoo-stage3.tar.xz
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
localedef -i en_US -f UTF-8 en_US.UTF-8
echo "LANG=en_US.UTF-8" > /etc/locale.conf
emerge-webrsync
rm -rf /etc/portage/gnupg /var/cache/binpkgs
getuto
echo -e "\nGRUB_PLATFORMS=\"efi-64\"" >> /etc/portage/make.conf
echo -e "SECUREBOOT_SIGN_KEY=\"/etc/secureboot_key/MOK.key\"" >> /etc/portage/make.conf
echo -e "SECUREBOOT_SIGN_CERT=\"/etc/secureboot_key/MOK.crt\"" >> /etc/portage/make.conf
if [ "${desktop}" == "None/Openrc" ]; then
	echo -e "\nUSE=\"bluetooth dbus dracut elogind policykit mount pam -systemd\"" >> /etc/portage/make.conf
elif [ "${desktop}" == "None/Systemd" ]; then
	echo -e "\nUSE=\"bluetooth dbus dracut -elogind policykit mount pam systemd\"" >> /etc/portage/make.conf
	echo "SYSTEMD_KERNEL_INSTALL=0" > /etc/env.d/99no-systemd-kernel-install
elif [ "$(echo ${desktop} | cut -d '/' -f2)" == "Openrc" ]; then
	echo -e "\nUSE=\"a52 aac accessibility acl alsa appindicator bluetooth boost branding cairo cdda cdr client colord cups dbus dracut drm dts dvd eds egl elogind exif flac gif gles2 grub gstreamer gtk gtk3 icu initramfs inspector introspection jpeg keyring lcms libei libnotify lock mbim mdnsresponder-compat minizip modemmanager mount mp3 mpeg networkmanager nss ogg opengl opus pam pango pdf png policykit pulseaudio python qml sdl secureboot spell svg sysprof -systemd text theora tiff tracker truetype udev udisks usb vala vorbis vpx vulkan wayland webp wpasupplicant X x264 xml xorg xvid zeroconf\"" >> /etc/portage/make.conf
	echo -e 'app-crypt/pinentry -gtk\nmedia-libs/tiff -webp\nnet-print/cups -zeroconf' > /etc/portage/package.use/dep_cycle_fix
else
	echo -e "\nUSE=\"a52 aac accessibility acl alsa appindicator bluetooth boost branding cairo cdda cdr client colord cups dbus dracut drm dts dvd eds egl -elogind exif flac gif gles2 grub gstreamer gtk gtk3 icu initramfs inspector introspection jpeg keyring lcms libei libnotify lock mbim mdnsresponder-compat minizip modemmanager mount mp3 mpeg networkmanager nss ogg opengl opus pam pango pdf png policykit pulseaudio python qml sdl secureboot spell svg sysprof systemd text theora tiff tracker truetype udev udisks usb vala vorbis vpx vulkan wayland webp wpasupplicant X x264 xml xorg xvid zeroconf\"" >> /etc/portage/make.conf
	echo -e 'app-crypt/pinentry -gtk\nmedia-libs/tiff -webp\nnet-print/cups -zeroconf' > /etc/portage/package.use/dep_cycle_fix
	echo "SYSTEMD_KERNEL_INSTALL=0" > /etc/env.d/99no-systemd-kernel-install
fi
echo -e "VIDEO_CARDS=\"amdgpu dummy fbdev intel nouveau qxl radeon radeonsi vesa virtualbox\"" >> /etc/portage/make.conf
echo -e "INPUT_DEVICES=\"libinput\"" >> /etc/portage/make.conf
echo -e "\nMAKEOPTS=\"--jobs 2\"\nEMERGE_DEFAULT_OPTS=\"--jobs 2\"" >> /etc/portage/make.conf
echo -e "FEATURES=\"getbinpkg\"" >> /etc/portage/make.conf
mkdir /etc/portage/package.license
echo -e "*/* *" >> /etc/portage/package.license/custom
/linuxloops/install_secureboot
rm /linuxloops/install_secureboot
emerge app-portage/gentoolkit
emerge -uDN --noconfmem @world sys-kernel/gentoo-kernel-bin sys-kernel/linux-firmware sys-firmware/intel-microcode sys-kernel/dracut net-wireless/wireless-regdb app-admin/sudo sys-fs/ntfs3g net-misc/networkmanager sys-fs/cryptsetup app-editors/nano dev-vcs/git sys-power/acpid net-misc/curl sys-power/thermald app-shells/bash-completion app-crypt/gnupg sys-auth/polkit app-arch/zstd sys-auth/pambase sys-boot/grub sys-boot/os-prober sys-boot/shim app-crypt/sbsigntools sys-fs/dosfstools sys-fs/btrfs-progs app-arch/cpio
echo -e '[main]\nhostname-mode=none' > /etc/NetworkManager/NetworkManager.conf
if [ "$(echo ${desktop} | cut -d '/' -f2)" == "Openrc" ]; then
	rc-update add bluetooth default
	rc-update add NetworkManager default
else
	systemctl enable bluetooth.service NetworkManager.service
fi
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

desktop_base="app-admin/system-config-printer gnome-base/gvfs kde-frameworks/breeze-icons kde-frameworks/oxygen-icons kde-plasma/breeze-gtk media-fonts/dejavu media-fonts/noto media-fonts/roboto net-print/cups net-print/cups-filters sys-boot/plymouth sys-fs/udisks x11-base/xorg-drivers x11-misc/xdg-user-dirs x11-misc/xdg-user-dirs-gtk x11-themes/adapta-gtk-theme x11-themes/adwaita-icon-theme x11-themes/gnome-backgrounds x11-themes/numix-gtk-theme x11-themes/numix-icon-theme x11-themes/numix-icon-theme-circle x11-themes/oxygen-gtk x11-themes/papirus-icon-theme x11-themes/xcursor-themes"
case "${desktop}" in
	'Cinnamon/Openrc')
	default_session="cinnamon"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm gnome-extra/cinnamon x11-terms/gnome-terminal gnome-extra/nemo net-wireless/blueman
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Cinnamon/Systemd')
	default_session="cinnamon"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm gnome-extra/cinnamon x11-terms/gnome-terminal gnome-extra/nemo net-wireless/blueman
systemctl enable lightdm.service
"
	;;
	'Enlightenment/Openrc')
	default_session="enlightenment"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm x11-wm/enlightenment x11-terms/terminology
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Enlightenment/Systemd')
	default_session="enlightenment"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm x11-wm/enlightenment x11-terms/terminology
systemctl enable lightdm.service
"
	;;
	'Gnome/Openrc')
	default_session="gnome-wayland"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init gnome-base/gdm gnome-base/gnome x11-terms/gnome-terminal gnome-base/nautilus
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"gdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Gnome/Systemd')
	default_session="gnome-wayland"
	install_desktop="
emerge ${desktop_base} gnome-base/gdm gnome-base/gnome x11-terms/gnome-terminal gnome-base/nautilus
systemctl enable gdm.service
"
	;;
	'i3/Openrc')
	default_session="i3"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm x11-wm/i3 x11-misc/i3lock x11-misc/i3status x11-misc/dmenu x11-terms/rxvt-unicode media-sound/volumeicon gnome-extra/nm-applet net-wireless/blueman
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'i3/Systemd')
	default_session="i3"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm x11-wm/i3 x11-misc/i3lock x11-misc/i3status x11-misc/dmenu x11-terms/rxvt-unicode media-sound/volumeicon gnome-extra/nm-applet net-wireless/blueman
systemctl enable lightdm.service
"
	;;
	'Lxqt/Openrc')
	default_session="lxqt"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm lxqt-base/lxqt-meta x11-terms/qterminal gnome-extra/nm-applet lxqt-base/lxqt-powermanagement net-wireless/blueman
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Lxqt/Systemd')
	default_session="lxqt"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm lxqt-base/lxqt-meta x11-terms/qterminal gnome-extra/nm-applet lxqt-base/lxqt-powermanagement net-wireless/blueman
systemctl enable lightdm.service
"
	;;
	'Mate/Openrc')
	default_session="mate"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm mate-base/mate x11-terms/mate-terminal gnome-extra/nm-applet mate-extra/mate-power-manager mate-extra/mate-media net-wireless/blueman
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Mate/Systemd')
	default_session="mate"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm mate-base/mate x11-terms/mate-terminal gnome-extra/nm-applet mate-extra/mate-power-manager mate-extra/mate-media net-wireless/blueman
systemctl enable lightdm.service
"
	;;
	'Plasma/Openrc')
	default_session="plasmawayland"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/sddm kde-plasma/plasma-meta kde-apps/konsole kde-plasma/plasma-nm kde-apps/dolphin
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"sddm\"@g' /etc/conf.d/display-manager
"
	;;
	'Plasma/Systemd')
	default_session="plasmawayland"
	install_desktop="
emerge ${desktop_base} x11-misc/sddm kde-plasma/plasma-meta kde-apps/konsole kde-plasma/plasma-nm kde-apps/dolphin
systemctl enable sddm.service
"
	;;
	'Xfce/Openrc')
	default_session="xfce"
	install_desktop="
emerge ${desktop_base} gui-libs/display-manager-init x11-misc/lightdm xfce-base/xfce4-meta x11-terms/xfce4-terminal gnome-extra/nm-applet net-wireless/blueman xfce-base/xfce4-power-manager net-wireless/blueman
sed -i 's@DISPLAYMANAGER=\"xdm\"@DISPLAYMANAGER=\"lightdm\"@g' /etc/conf.d/display-manager
"
	;;
	'Xfce/Systemd')
	default_session="xfce"
	install_desktop="
emerge ${desktop_base} x11-misc/lightdm xfce-base/xfce4-meta x11-terms/xfce4-terminal gnome-extra/nm-applet net-wireless/blueman xfce-base/xfce4-power-manager net-wireless/blueman
systemctl enable lightdm.service
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None/Openrc" ] || [ "${desktop}" == "None/Systemd" ]; then exit 0; fi
emerge x11-base/xorg-server dev-util/vulkan-headers dev-util/wayland-scanner
${install_desktop}
if [ "$(echo ${desktop} | cut -d '/' -f2)" == "Openrc" ]; then
	rc-update add elogind boot
	rc-update add dbus default
	rc-update add display-manager default
	rc-update add cupsd default
elif [ "${desktop}" != "None" ]; then
	systemctl enable cups.service
	systemctl --global enable pulseaudio.service pulseaudio.socket
fi
rm -f /etc/portage/package.use/dep_cycle_fix
emerge -uDN @world
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
sed -i 's/^password/#password/g' /etc/pam.d/system-auth
echo 'password       required        pam_unix.so nullok sha512 shadow' >> /etc/pam.d/system-auth
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
if [ ! -d /etc/sudoers.d ]; then mkdir -p /etc/sudoers.d; chmod 0750 /etc/sudoers.d; fi
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None/Openrc" ] || [ "${desktop}" == "None/Systemd" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome/Openrc'|'Gnome/Systemd')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma/Openrc'|'Plasma/Systemd')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nemerge ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Kali()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales kali-rolling /mnt http://http.kali.org/kali
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://http.kali.org/kali kali-rolling main contrib non-free non-free-firmware
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-bin os-prober shim-signed amd64-microcode intel-microcode lsb-release kali-themes sbsigntool mokutil dosfstools btrfs-progs cpio kali-linux-core
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover avahi-dnsconfd cups cups-browsed cups-filters libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="plymouth-themes synaptic kali-defaults-desktop kali-themes-common"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nemo gnome-terminal libgdk-pixbuf2.0-bin
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nemo gnome-terminal libgdk-pixbuf2.0-bin kali-linux-default
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop gnome-terminal blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop gnome-terminal blueman kali-linux-default
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-e17 terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
systemctl enable connman.service
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Enlightenment/Full')
	default_session="enlightenment"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-e17 terminology kali-linux-default
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
systemctl enable connman.service
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 kali-desktop-gnome gnome-keyring libpam-gnome-keyring
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 kali-desktop-gnome gnome-keyring libpam-gnome-keyring kali-linux-default
"
	;;
	'i3')
	default_session="i3"
	hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover avahi-dnsconfd cups cups-browsed cups-filters libnss-mdns pulseaudio pulseaudio-module-bluetooth system-config-printer xserver-xorg"
	desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-i3 volumeicon-alsa network-manager-gnome blueman
"
	;;
	'i3/Full')
	default_session="i3"
	hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover avahi-dnsconfd cups cups-browsed cups-filters libnss-mdns pulseaudio pulseaudio-module-bluetooth system-config-printer xserver-xorg"
	desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-i3 volumeicon-alsa network-manager-gnome blueman kali-linux-default
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-lxde network-manager-gnome blueman
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-lxde network-manager-gnome blueman kali-linux-default
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-mate mate-power-manager mate-media blueman
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-mate mate-power-manager mate-media blueman kali-linux-default
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kali-desktop-kde plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kali-desktop-kde plasma-workspace-wayland kwin-wayland plasma-nm plasma-pa powerdevil bluedevil libpam-kwallet5 kali-linux-default
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-xfce blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter kali-desktop-xfce blueman kali-linux-default
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/kali/login.svg"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/kali/login.svg"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-headers-* linux-image-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Linuxmint()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
rm -f /etc/apt/sources.list
cat >/etc/apt/sources.list.d/official-package-repositories.list <<'REPOS'
deb http://packages.linuxmint.com virginia main upstream import backport #id:linuxmint_main

deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
deb http://archive.ubuntu.com/ubuntu jammy-backports main restricted universe multiverse

deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
REPOS
cat >/etc/apt/preferences.d/official-package-repositories.pref <<'PRIORITY'
Package: *
Pin: origin live.linuxmint.com
Pin-Priority: 750

Package: *
Pin: release o=linuxmint,c=upstream
Pin-Priority: 700

Package: *
Pin: release o=LP-PPA-linuxmint-daily-build-team-daily-builds
Pin-Priority: 700
PRIORITY
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install linuxmint-keyring mintsources --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed libnss-mdns pipewire pipewire-audio-client-libraries pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="mint-artwork mint-themes mint-x-icons mint-y-icons mint-backgrounds-vera plymouth-themes fonts-ubuntu mintinstall mintsystem mintupdate mintupgrade ubuntu-system-adjustments grub2-theme-mint"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-cinnamon mint-info-cinnamon cinnamon-desktop-environment gnome-terminal nemo gnome-keyring libpam-gnome-keyring
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-cinnamon mint-info-cinnamon cinnamon-desktop-environment gnome-terminal nemo gnome-keyring libpam-gnome-keyring
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-mate mint-info-mate mate-desktop-environment gnome-terminal nemo
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-mate mint-info-mate mate-desktop-environment gnome-terminal nemo
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-xfce mint-info-xfce xfce4 xfce4-power-manager xfce4-terminal thunar greybird-gtk-theme elementary-xfce-icon-theme
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-xfce mint-info-xfce xfce4 xfce4-power-manager xfce4-terminal thunar greybird-gtk-theme elementary-xfce-icon-theme
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
echo -e '[Greeter]\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
if [ "${autologin}" == "Yes" ]; then
	groupadd -r autologin
	usermod -aG autologin '${username}'
	mkdir -p /etc/lightdm/lightdm.conf.d
	echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_LMDE()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales bookworm /mnt http://deb.debian.org/debian
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
rm -f /etc/apt/sources.list
cat >/etc/apt/sources.list.d/official-package-repositories.list <<'REPOS'
deb http://packages.linuxmint.com faye main upstream import backport #id:linuxmint_main

deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
deb http://deb.debian.org/debian bookworm-backports main contrib non-free non-free-firmware

deb http://security.debian.org bookworm-security main contrib non-free non-free-firmware
REPOS
cat >/etc/apt/preferences.d/official-package-repositories.pref <<'PRIORITY'
Package: *
Pin: origin live.linuxmint.com
Pin-Priority: 750

Package: *
Pin: release o=linuxmint,c=upstream
Pin-Priority: 700
PRIORITY
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install linuxmint-keyring mintsources --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed bind9-host dns-root-data amd64-microcode intel-microcode lsb-release sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="mint-artwork mint-themes mint-x-icons mint-y-icons plymouth-themes fonts-ubuntu mintinstall mintsystem mintupdate mintupgrade grub2-theme-mint"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-cinnamon cinnamon-desktop-environment gnome-terminal nemo gnome-keyring libpam-gnome-keyring
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mint-meta-cinnamon cinnamon-desktop-environment gnome-terminal nemo gnome-keyring libpam-gnome-keyring
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
mkdir -p /etc/lightdm/lightdm.conf.d
echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
if [ "${autologin}" == "Yes" ]; then
	groupadd -r autologin
	usermod -aG autologin '${username}'
	echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-headers-* linux-image-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Manjaro()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
curl https://gitlab.manjaro.org/packages/core/pacman/-/raw/master/pacman.conf?inline=false -o /etc/pacman_manjaro.conf
sed -i 's@SigLevel    = Required DatabaseOptional@SigLevel    = Never@g' /etc/pacman_manjaro.conf
sed -i 's@#RemoteFileSigLevel = Required@RemoteFileSigLevel = Optional@g' /etc/pacman_manjaro.conf
sed -i '/SyncFirst/d' /etc/pacman_manjaro.conf
echo 'Server = https://mirrors2.manjaro.org/stable/\$repo/\$arch' > /etc/pacman.d/mirrorlist
pacstrap -M -C /etc/pacman_manjaro.conf -G /mnt base base-devel pacman-mirrors
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
pacman-key --init
pacman-key --populate
pacman-mirrors --fasttrack 20
pacman -Syu --noconfirm systemd linux66 linux66-headers dkms linux-firmware sof-firmware wireless-regdb bash sudo modemmanager networkmanager wpa_supplicant bluez cryptsetup e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr grub os-prober shim amd-ucode intel-ucode sbsigntools mokutil dosfstools btrfs-progs cpio
systemctl enable bluetooth.service ModemManager.service NetworkManager.service
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-lib alsa-utils alsa-topology-conf alsa-ucm-conf at-spi2-core avahi cups cups-filters nss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xorg-server"
basic_packages="gvfs packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adobe-source-code-pro-fonts adwaita-icon-theme breeze-gtk breeze-icons gnome-backgrounds materia-gtk-theme noto-fonts oxygen-icons papirus-icon-theme ttf-dejavu ttf-roboto ttf-meslo-nerd-font-powerlevel10k"
specific_packages="manjaro-wallpapers-18.0 manjaro-settings-manager matcha-gtk-theme plymouth-theme-manjaro"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter budgie-desktop manjaro-budgie-settings network-manager-applet gnome-terminal nemo arc-gtk-theme papirus-maia-icon-theme pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter cinnamon manjaro-cinnamon-settings gnome-terminal nemo pamac-gtk blueman
systemctl enable lightdm.service
"
	;;
	'Deepin')
	default_session="dde-x11"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter deepin deepin-manjaro deepin-terminal deepin-wallpapers pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Deepin/Full')
	default_session="dde-x11"
	install_desktop="
pacman -S --noconfirm --overwrite \"*\" ${desktop_base} lightdm lightdm-slick-greeter deepin deepin-manjaro deepin-terminal deepin-wallpapers pamac-gtk deepin-extra
systemctl enable lightdm.service
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
systemctl disable NetworkManager.service
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter enlightenment terminology pamac-gtk connman
systemctl enable lightdm.service connman.service
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gnome-shell gnome-control-center gnome-keyring gnome-software gnome-terminal nautilus manjaro-gnome-settings
systemctl enable gdm.service
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} gdm gnome gnome-extra manjaro-gnome-settings
systemctl enable gdm.service
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter i3-wm i3lock i3status dmenu rxvt-unicode manjaro-i3-settings volumeicon network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxde-common lxde-icon-theme lxappearance lxpanel lxsession lxterminal openbox manjaro-lxde-config manjaro-lxde-desktop-settings manjaro-lxde-logout-banner manjaro-lxde-xfce4-notifyd manjaro-lxde-xfce4-volumed-pulse arc-maia-icon-theme kvantum-manjaro lxterminal pcmanfm network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxde manjaro-lxde-config manjaro-lxde-desktop-settings manjaro-lxde-logout-banner manjaro-lxde-xfce4-notifyd manjaro-lxde-xfce4-volumed-pulse arc-maia-icon-theme kvantum-manjaro lxterminal pcmanfm network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxqt-config lxqt-notificationd lxqt-panel lxqt-policykit lxqt-powermanagement lxqt-qtplugin lxqt-session lxqt-themes openbox manjaro-lxqt-config manjaro-lxqt-desktop-settings manjaro-openbox-adapta-maia papirus-maia-icon-theme qterminal pcmanfm-qt network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter lxqt manjaro-lxqt-config manjaro-lxqt-desktop-settings manjaro-openbox-adapta-maia papirus-maia-icon-theme qterminal pcmanfm-qt network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter mate manjaro-mate-settings arc-maia-icon-theme papirus-maia-icon-theme mate-terminal caja mate-control-center network-manager-applet blueman mate-media mate-power-manager pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter mate mate-extra manjaro-mate-settings arc-maia-icon-theme papirus-maia-icon-theme mate-terminal caja mate-control-center network-manager-applet blueman mate-media mate-power-manager pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Plasma')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard plasma-desktop plasma-nm plasma-pa kwin dolphin konsole bluedevil powerdevil systemsettings discover kwallet-pam packagekit-qt6 pamac-tray-icon-plasma
systemctl enable sddm.service
"
	;;
	'Plasma/Full')
	default_session="plasma"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm qt6-virtualkeyboard plasma manjaro-kde-settings dolphin discover packagekit-qt5 konsole packagekit-qt6 pamac-tray-icon-plasma
systemctl enable sddm.service
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter xfce4 manjaro-xfce-settings xfce4-terminal xfce4-notifyd xfce4-whiskermenu-plugin thunar xfce4-battery-plugin xfce4-power-manager xfce4-pulseaudio-plugin network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
pacman -S --noconfirm ${desktop_base} lightdm lightdm-slick-greeter xfce4 xfce4-goodies manjaro-xfce-settings xfce4-terminal xfce4-notifyd xfce4-whiskermenu-plugin thunar xfce4-battery-plugin xfce4-power-manager xfce4-pulseaudio-plugin network-manager-applet blueman pamac-gtk
systemctl enable lightdm.service
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		if [ "${desktop}" == "Deepin" ] || [ "${desktop}" == "Deepin/Full" ]; then
			echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-deepin-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf		
		else
			echo -e '[LightDM]\nlogind-check-graphical=true\n\n[Seat:*]\nsession-wrapper=/etc/lightdm/Xsession\ngreeter-session=lightdm-slick-greeter' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux66 linux66-headers"
initramfs_type="initcpio"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\npacman -S --noconfirm ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_MX()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales bookworm /mnt http://deb.debian.org/debian
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware

deb http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware

deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
cat >/etc/apt/sources.list.d/mx.list <<'SOURCES'
deb http://mxrepo.com/mx/repo/ bookworm main non-free
#deb http://mxrepo.com/mx/repo/ bookworm ahs
SOURCES
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install mx23-archive-keyring --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse pipewire-setup-mx wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="grub-themes-mx plymouth-themes-mx synaptic mx-greybird-themes mx-comfort-themes mx-icons-start mx-sound-theme-borealis mx-sound-theme-fresh-and-clean mx-system mx23-artwork desktop-defaults-mx-applications desktop-defaults-mx-common"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nautilus gnome-terminal
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon gnome-terminal nemo blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop blueman
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-shell gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-icon-theme gnome-keyring libpam-gnome-keyring
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 task-gnome-desktop
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde-core lxterminal pcmanfm lxde-icon-theme network-manager-gnome lxappearance lxinput blueman
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxde-desktop network-manager-gnome blueman
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxqt-core qterminal pcmanfm-qt lxqt-theme-debian lxde-icon-theme network-manager-gnome mutter lxqt-powermanagement lxqt-themes oxygen-icon-theme blueman
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxqt-desktop network-manager-gnome blueman
yes | DEBIAN_FRONTEND=noninteractive apt purge sddm
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mate-desktop mate-session-manager marco mate-control-center mate-notification-daemon mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja network-manager-gnome blueman mate-media mate-power-manager
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-mate-desktop blueman
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze kde-plasma-desktop plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings plasma-look-and-feel-theme-mx plasma-modified-defaults-mx desktop-defaults-mx-kde
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze task-kde-desktop plasma-workspace-wayland plasma-look-and-feel-theme-mx plasma-modified-defaults-mx desktop-defaults-mx-kde
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager xfce4-terminal thunar xfce4-notifyd xfce4-whiskermenu-plugin network-manager-gnome blueman desktop-defaults-mx-xfce papirus-mxblue xfce4-docklike-plugin
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-xfce-desktop network-manager-gnome blueman desktop-defaults-mx-xfce papirus-mxblue xfce4-docklike-plugin
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/default23.png"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/default23.png"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
plymouth-set-default-theme MXLiveLogo
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG audio,sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/default23.png\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-headers-* linux-image-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Neon()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
cat >/etc/apt/sources.list.d/neon.list <<'RECOMMENDS'
deb http://archive.neon.kde.org/user/ jammy main
RECOMMENDS
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install gnupg neon-keyring neon-settings --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode update-manager-core sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed iio-sensor-proxy libnss-mdns pipewire pipewire-audio-client-libraries pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
desktop_base="${hardware_support} ${basic_packages}"
case "${desktop}" in
	'Essentials')
	default_session="plasma"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm neon-essentials-desktop plasma-workspace-wayland libpam-kwallet5
"
	;;
	'Full')
	default_session="plasma"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm neon-desktop plasma-workspace-wayland libpam-kwallet5
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
yes | DEBIAN_FRONTEND=noninteractive apt purge plasma-firewall firewalld
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
sudo -u '${username}' xdg-user-dirs-update
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
if [ "${autologin}" == "Yes" ]; then
	mkdir -p /etc/sddm.conf.d
	echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
	sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_NixOS()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<NIXOS_PREPARE_CHROOT
#!/bin/bash
set -e
/linuxloops/install_secureboot /mnt
/linuxloops/install_fstab
/linuxloops/install_initramfs
groupadd -g 30000 nixbld
useradd -u 30000 -g nixbld -G nixbld nixbld
useradd -s /bin/bash -m 'temp'
echo -e 'temp\ntemp' | passwd 'temp'
echo 'temp      ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/90-wheel
sudo -u temp bash << 'NIXOSINSTALL'
sudo mkdir -p /nix && sudo chown -R temp /nix
curl -L https://nixos.org/nix/install | sh
. /home/temp/.nix-profile/etc/profile.d/nix.sh
nix-channel --add https://nixos.org/channels/nixos-23.11 nixpkgs
nix-channel --update
nix-env -f '<nixpkgs>' -iA nixos-install-tools
sudo NIX_PATH=/home/temp/.nix-defexpr/channels nixos-install
/linuxloops/install_user
NIXOSINSTALL
NIXOS_PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

if [ "${autologin}" == "Yes" ]; then
	case "${desktop}" in
		'Gnome/Full')
		autologin="
	services.xserver.displayManager.gdm.autoLogin.enable = true;
	services.xserver.displayManager.gdm.autoLogin.user = \"${username}\";"
		;;
		'Plasma/Full')
		autologin="
	services.xserver.displayManager.sddm.autoLogin.enable = true;
	services.xserver.displayManager.sddm.autoLogin.user = \"${username}\";"
		;;
		*)
		autologin="
	services.xserver.displayManager.lightdm.autoLogin.enable = true;
	services.xserver.displayManager.lightdm.autoLogin.user = \"${username}\";"
		;;
	esac
else
	autologin=""
fi

case "${desktop}" in
	'Budgie/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.budgie.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Cinnamon/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.cinnamon.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Deepin/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.deepin.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Gnome/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.gdm.enable = true;${autologin}
services.xserver.desktopManager.gnome.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'i3/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.layout = \"${keymap}\";
services.xserver.windowManager.i3.enable = true;
services.xserver.windowManager.i3.extraPackages = with pkgs; [ dmenu i3status i3lock ];"
	;;
	'Lxqt/Full')
	nixos_desktop="
programs.nm-applet.enable = true;
services.blueman.enable = true;
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.lxqt.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Mate/Full')
	nixos_desktop="
programs.nm-applet.enable = true;
services.blueman.enable = true;
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.mate.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Pantheon/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.pantheon.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Plasma/Full')
	nixos_desktop="
services.xserver.enable = true;
services.xserver.displayManager.sddm.enable = true;${autologin}
services.xserver.desktopManager.plasma5.enable = true;
services.xserver.layout = \"${keymap}\";"
	;;
	'Xfce/Full')
	nixos_desktop="
services.blueman.enable = true;
services.xserver.enable = true;
services.xserver.displayManager.lightdm.enable = true;${autologin}
services.xserver.desktopManager.xfce.enable = true;
services.xserver.layout = \"${keymap}\";"
custom_packages="xfce.xfce4-pulseaudio-plugin ${custom_packages}"
	;;
esac

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
sudo nixos-enter << 'NIXOSCHROOT'
set -e
useradd -m '${username}'
usermod -aG wheel,networkmanager '${username}'
NIXOSCHROOT
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

initramfs_type="nixos_config"
}

chroot_Nobara()
{
prepare_bootstrap="
dnf update -y
dnf install -y bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
cat >/etc/yum.repos.d/nobara.repo <<'NOBARAREPO'
[nobara-baseos-\$releasever]
name=nobara-baseos-\$releasever
#baseurl=https://nobara-baseos.nobaraproject.org/\$releasever/
mirrorlist=https://mirrors.nobaraproject.org/baseos
type=rpm-md
skip_if_unavailable=True
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-nobara-baseos-pubkey-\$releasever-\$basearch
repo_gpgcheck=0
enabled=1
enabled_metadata=1
priority=50

[nobara-baseos-multilib-\$releasever]
name=nobara-baseos-multilib-\$releasever
#baseurl=https://nobara-baseos-multilib.nobaraproject.org/\$releasever/
mirrorlist=https://mirrors.nobaraproject.org/baseos-multilib
type=rpm-md
skip_if_unavailable=True
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-nobara-baseos-pubkey-\$releasever-\$basearch
repo_gpgcheck=0
enabled=1
enabled_metadata=1
priority=50

[nobara-appstream-\$releasever]
name=nobara-appstream-\$releasever
#baseurl=https://nobara-appstream.nobaraproject.org/\$releasever/\$basearch
mirrorlist=https://mirrors.nobaraproject.org/appstream
type=rpm-md
skip_if_unavailable=True
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-nobara-appstream-pubkey-\$basearch
repo_gpgcheck=0
enabled=1
enabled_metadata=1
priority=25

[nobara-rocm-official]
name=nobara-rocm-official
baseurl=https://repo.radeon.com/rocm/rhel9/5.6.1/main/
enabled=1
gpgcheck=1
gpgkey=https://repo.radeon.com/rocm/rocm.gpg.key
priority=50
NOBARAREPO
dnf install --nogpgcheck -y nobara-gpg-keys
dnf install --installroot=/mnt --releasever / -y @core nobara-release-workstation grubby openssl tar gstreamer1-plugins-bad-free gstreamer1-plugins-ugly-free
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
dnf install -y https://mirrors.rpmfusion.org/free/fedora/rpmfusion-free-release-\$(rpm -E %fedora).noarch.rpm https://mirrors.rpmfusion.org/nonfree/fedora/rpmfusion-nonfree-release-\$(rpm -E %fedora).noarch.rpm
dnf groupupdate -y core
dnf upgrade --refresh -y
dnf install -y kernel kernel-headers akmods dkms linux-firmware iwl100-firmware iwl1000-firmware iwl105-firmware iwl135-firmware iwl2000-firmware iwl2030-firmware iwl3160-firmware iwl5000-firmware iwl5150-firmware iwl6000g2a-firmware iwl6000g2b-firmware iwl6050-firmware iwl7260-firmware wireless-regdb glibc-locale-source ntfs-3g bash sudo ModemManager NetworkManager-bluetooth NetworkManager-tui NetworkManager-wifi wpa_supplicant bluez cryptsetup e2fsprogs ntfsprogs nano acpid curl thermald bash-completion gpg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr nss-mdns grub2-efi-x64 os-prober shim microcode_ctl sbsigntools mokutil apparmor dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-lib alsa-utils alsa-sof-firmware alsa-topology at-spi2-core avahi cups cups-browsed mesa-vulkan-drivers nss-mdns system-config-printer xorg-x11-drivers"
basic_packages="gvfs-fuse PackageKit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk breeze-icon-theme dejavu-sans-fonts google-noto-sans-fonts google-roboto-fonts gnome-backgrounds materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="desktop-backgrounds ffmpeg flatpak gamemode gamescope goverlay lutris mangohud nobara-bookmarks nobara-controller-config nobara-login nobara-login-sysctl openh264 plymouth-system-theme protonup-qt steam vkBasalt winetricks yumex"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} gdm gnome-shell nautilus gnome-terminal gnome-extensions-app gnome-software gnome-keyring gnome-keyring-pam gnome-shell-extension-appindicator gnome-shell-extension-supergfxctl-gex
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} gdm @gnome-desktop gnome-shell-extension-appindicator gnome-shell-extension-supergfxctl-gex
"
	;;
	'Nobara')
	default_session="plasma"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze kde-nobara-sddm plasma-desktop plasma-workspace-wayland plasma-discover plasma-nm bluedevil dolphin konsole pam-kwallet kde-nobara kde-nobara-extras-wallpapers nobara-kde-presets
"
	;;
	'Nobara/Full')
	default_session="plasma"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze kde-nobara-sddm @kde-desktop-environment plasma-workspace-wayland kde-nobara kde-nobara-extras-wallpapers nobara-kde-presets
"
	;;
	'Plasma')
	default_session="plasma"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze plasma-desktop plasma-workspace-wayland plasma-discover plasma-nm bluedevil dolphin konsole pam-kwallet
"
	;;
	'Plasma/Full')
	default_session="plasma"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze @kde-desktop-environment plasma-workspace-wayland
"
	;;
	'SteamDeck')
	default_session="gamescope-session-steam"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze sddm-sugar-steamOS plasma-desktop plasma-workspace-wayland plasma-discover plasma-nm bluedevil dolphin konsole pam-kwallet gamescope-session-plus gamescope-session-steam jupiter-fan-control jupiter-hw-support steamdeck-kde-presets
"
	;;
	'SteamDeck/Full')
	default_session="gamescope-session-steam"
	install_desktop="
dnf install --allowerasing -y ${desktop_base} sddm sddm-breeze sddm-sugar-steamOS @kde-desktop-environment plasma-workspace-wayland gamescope-session-plus gamescope-session-steam jupiter-fan-control jupiter-hw-support steamdeck-kde-presets
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	*)
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\ndnf install -y ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_OpenSUSE()
{
prepare_bootstrap="
zypper --non-interactive refresh
zypper --non-interactive install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
zypper --root /mnt addrepo http://download.opensuse.org/tumbleweed/repo/oss/ repo-oss
zypper --root /mnt addrepo http://download.opensuse.org/tumbleweed/repo/non-oss/ repo-non-oss
zypper --root /mnt addrepo http://download.opensuse.org/update/tumbleweed/ repo-update
zypper --root /mnt --gpg-auto-import-keys refresh
zypper --root /mnt --non-interactive install patterns-openSUSE-base attr coreutils diffutils filesystem glibc-locale glibc-i18ndata grep gzip lsof pam permissions rpm sed shadow system-group-wheel zypper
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
sed -i 's@# solver.onlyRequires = false@solver.onlyRequires = true@g' /etc/zypp/zypp.conf
zypper --non-interactive install kernel-default kernel-default-devel dkms kernel-firmware-all wireless-regdb nano ntfs-3g sudo ModemManager NetworkManager wpa_supplicant bluez cryptsetup nano e2fsprogs ntfsprogs device-mapper acpid curl thermald bash-completion gpg2 polkit xdg-user-dirs zstd fwupd-efi patchutils net-tools usb_modeswitch upower efibootmgr grub2-x86_64-efi grub2-branding-openSUSE os-prober shim ucode-amd ucode-intel sbsigntools dosfstools btrfs-progs cpio
systemctl enable bluetooth.service NetworkManager.service
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-firmware at-spi2-core avahi cups cups-filters nss-mdns pipewire pipewire-pulseaudio wireplumber system-config-printer"
basic_packages="gvfs-fuse PackageKit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme dejavu-fonts google-roboto-fonts gnome-backgrounds materia-gtk-theme papirus-icon-theme"
specific_packages="adobe-sourcecodepro-fonts cantarell-fonts plymouth-branding-openSUSE plymouth-dracut wallpaper-branding-openSUSE"
desktop_base="patterns-base-x11 ${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-budgie-budgie gnome-keyring-pam polkit-gnome gnome-terminal nemo NetworkManager-applet
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-budgie-budgie gnome-keyring-pam polkit-gnome gnome-terminal nemo NetworkManager-applet
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-cinnamon-cinnamon cinnamon-settings-daemon gnome-keyring-pam polkit-gnome gnome-terminal nemo NetworkManager-applet mint-x-icon-theme mint-y-icon-theme blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-cinnamon-cinnamon cinnamon-settings-daemon gnome-keyring-pam polkit-gnome gnome-terminal nemo NetworkManager-applet mint-x-icon-theme mint-y-icon-theme blueman
"
	;;
	'Deepin')
	default_session="deepin"
	install_desktop="
zypper --non-interactive install --auto-agree-with-licenses ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-deepin-deepin deepin-desktop-schemas-branding-openSUSE deepin-terminal deepin-file-manager deepin-polkit-agent NetworkManager-applet blueman
"
	;;
	'Deepin/Full')
	default_session="deepin"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install --auto-agree-with-licenses ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-deepin-deepin deepin-desktop-schemas-branding-openSUSE deepin-terminal deepin-file-manager deepin-polkit-agent NetworkManager-applet blueman
zypper --non-interactive remove sddm
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
systemctl disable NetworkManager.service
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-enlightenment-enlightenment terminology connman
systemctl enable connman.service
"
	;;
	'Enlightenment/Full')
	default_session="enlightenment"
	install_desktop="
systemctl disable NetworkManager.service
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-enlightenment-enlightenment terminology connman
systemctl enable connman.service
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
zypper --non-interactive install ${desktop_base} gdm-branding-openSUSE patterns-gnome-gnome gnome-session-wayland gnome-keyring-pam polkit-gnome gnome-terminal nautilus NetworkManager-applet
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} gdm-branding-openSUSE patterns-gnome-gnome gnome-session-wayland gnome-keyring-pam polkit-gnome gnome-terminal nautilus NetworkManager-applet
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE i3 dmenu i3lock i3status rxvt-unicode NetworkManager-applet blueman
"
	;;
	'Lxde')
	default_session="lxde"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-lxde-lxde lxsession lxappearance nuoveXT2-icon-theme lxterminal lxde-common lxpanel pcmanfm NetworkManager-applet blueman
"
	;;
	'Lxde/Full')
	default_session="lxde"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-lxde-lxde lxsession lxappearance nuoveXT2-icon-theme lxterminal lxde-common lxpanel pcmanfm NetworkManager-applet blueman
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-lxqt-lxqt openbox qterminal pcmanfm-qt NetworkManager-applet blueman
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-lxqt-lxqt openbox qterminal pcmanfm-qt NetworkManager-applet blueman
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-mate-mate mate-panel-branding-openSUSE mate-themes mate-terminal mate-media mate-power-manager mate-menus caja NetworkManager-applet blueman
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-mate-mate mate-panel-branding-openSUSE mate-themes mate-terminal mate-media mate-power-manager mate-menus caja NetworkManager-applet blueman
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
zypper --non-interactive install ${desktop_base} sddm patterns-kde-kde konsole NetworkManager-applet bluedevil6 plasma6-nm plasma6-pa kwalletmanager pam_kwallet dolphin discover discover-backend-packagekit kdeplasma6-addons plasma6-branding-openSUSE breeze6 breeze6-wallpapers plasma6-workspace-wallpapers
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} sddm patterns-kde-kde konsole NetworkManager-applet bluedevil6 plasma6-nm plasma6-pa kwalletmanager pam_kwallet dolphin discover discover-backend-packagekit kdeplasma6-addons plasma6-branding-openSUSE breeze6 breeze6-wallpapers plasma6-workspace-wallpapers
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-xfce-xfce adwaita-xfce-icon-theme libxfce4ui-branding-openSUSE xfce4-settings-branding-openSUSE xfce4-power-manager-plugin xfce4-power-manager-branding-openSUSE xfce4-pulseaudio-plugin xfce4-terminal thunar NetworkManager-applet blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
zypper --non-interactive install ${desktop_base} lightdm lightdm-slick-greeter-branding-openSUSE patterns-xfce-xfce adwaita-xfce-icon-theme libxfce4ui-branding-openSUSE xfce4-settings-branding-openSUSE xfce4-power-manager-plugin xfce4-power-manager-branding-openSUSE xfce4-pulseaudio-plugin xfce4-terminal thunar NetworkManager-applet blueman
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
zypper --non-interactive install xset
cp /usr/bin/xset /usr/bin/xset.orig
echo -e '#!/bin/bash\nexit 0' > /usr/bin/xset
${install_desktop}
rm /usr/bin/xset
mv /usr/bin/xset.orig /usr/bin/xset
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo -e "Defaults secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"\nroot ALL=(ALL) ALL\n@includedir /etc/sudoers.d" > /etc/sudoers
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
cat >/etc/polkit-1/rules.d/50-org.freedesktop.NetworkManager.rules <<'NETWORKMANAGER'
polkit.addRule(function(action, subject) {
    if (action.id.indexOf("org.freedesktop.NetworkManager.") == 0 && subject.isInGroup("wheel")) {
        return polkit.Result.YES;
    }
});
NETWORKMANAGER
cat >/etc/polkit-1/rules.d/51-blueman.rules <<'BLUEMAN'
polkit.addRule(function(action, subject) {
    if ((action.id == "org.blueman.network.setup" ||
         action.id == "org.blueman.dhcp.client" ||
         action.id == "org.blueman.rfkill.setstate" ||
         action.id == "org.blueman.pppd.pppconnect") &&
        subject.isInGroup("wheel")) {

        return polkit.Result.YES;
    }
});
BLUEMAN
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			sed -i 's@DISPLAYMANAGER_AUTOLOGIN=\"\"@DISPLAYMANAGER_AUTOLOGIN="${username}"@g' /etc/sysconfig/displaymanager
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			sed -i 's@DISPLAYMANAGER_AUTOLOGIN=\"\"@DISPLAYMANAGER_AUTOLOGIN="${username}"@g' /etc/sysconfig/displaymanager
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[LightDM]\nlogind-check-graphical=true\n\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			sed -i 's@DISPLAYMANAGER_AUTOLOGIN=\"\"@DISPLAYMANAGER_AUTOLOGIN="${username}"@g' /etc/sysconfig/displaymanager
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nzypper --non-interactive install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Parrot()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cpio cryptsetup curl dosfstools e2fsprogs efibootmgr fatresize gzip lsof nano openssl parted sbsigntools sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
echo "Downloading Parrot rootfs"
curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f http://mirror.parrot.sh/parrot/iso/5.3/Parrot-rootfs-5.3_amd64.tar.xz -o /root/parrot-rootfs.tar.xz || { echo -e "Parrot rootfs image download failed."; exit 1; }
tar xf /root/parrot-rootfs.tar.xz -C /mnt --strip 1
rm /root/parrot-rootfs.tar.xz
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
sed -i 's@https://deb.parrot.sh/parrot\\|https://deb.parrot.sh/direct/parrot@http://mirror.parrot.sh/parrot@g' /etc/apt/sources.list
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install --reinstall ca-certificates kbd keyboard-configuration locales parrot-core
sed -i 's@https://deb.parrot.sh/parrot\\|https://deb.parrot.sh/direct/parrot@http://mirror.parrot.sh/parrot@g' /etc/apt/sources.list.d/parrot.list
parrot-upgrade
sed -i 's@https://deb.parrot.sh/parrot\\|https://deb.parrot.sh/direct/parrot@http://mirror.parrot.sh/parrot@g' /etc/apt/sources.list.d/parrot.list
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-amd64 linux-headers-amd64 dkms firmware-linux firmware-atheros firmware-iwlwifi firmware-realtek wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-bin os-prober shim-signed amd64-microcode intel-microcode lsb-release sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover avahi-dnsconfd cups cups-browsed cups-filters libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="plymouth-themes synaptic parrot-themes parrot-wallpapers"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nemo gnome-terminal libgdk-pixbuf2.0-bin
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nautilus gnome-terminal libgdk-pixbuf2.0-bin nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop gnome-terminal blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop gnome-terminal blueman nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
systemctl enable connman.service
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Enlightenment/Full')
	default_session="enlightenment"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology nim anonsurf-gtk metasploit-framework nmap
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
systemctl enable connman.service
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome gnome-keyring libpam-gnome-keyring
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome gnome-keyring libpam-gnome-keyring nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter parrot-desktop-i3 volumeicon-alsa network-manager-gnome blueman
"
	;;
	'i3/Full')
	default_session="i3"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter parrot-desktop-i3 volumeicon-alsa network-manager-gnome blueman nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde network-manager-gnome blueman
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde network-manager-gnome blueman nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter parrot-desktop-mate mate-desktop mate-session-manager mate-power-manager mate-media blueman
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter parrot-desktop-mate mate-desktop mate-session-manager mate-power-manager mate-media blueman nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm parrot-desktop-kde plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm parrot-desktop-kde plasma-workspace-wayland kwin-wayland plasma-nm plasma-pa powerdevil bluedevil libpam-kwallet5 nim anonsurf-gtk metasploit-framework nmap
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager-plugins xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager-plugins xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman nim anonsurf-gtk metasploit-framework nmap
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/default.jpg"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/default.jpg"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/default.jpg\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Pop()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
yes | DEBIAN_FRONTEND=noninteractive apt install software-properties-common
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 63C46DF0140D738961429F4E204DD8AEC33A7AFF
add-apt-repository "deb http://apt.pop-os.org/release \$(lsb_release -cs) main" -y
add-apt-repository "deb http://apt.pop-os.org/proprietary \$(lsb_release -cs) main" -y
cat >/etc/apt/preferences.d/kernelstub <<'KERNELSTUB'
Package: kernelstub
Pin: release *
Pin-Priority: -1
KERNELSTUB
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install pop-default-settings --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed update-manager-core snapd sbsigntool mokutil dosfstools btrfs-progs cpio
echo 'autoinstall_all_kernels="y"' >> /etc/dkms/framework.conf
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

case "${desktop}" in
	'Full')
	default_session="pop-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install pop-desktop
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
if [ "${autologin}" == "Yes" ]; then
	if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
	echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Proxmox()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales bookworm /mnt http://deb.debian.org/debian
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware

deb http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian-security/ bookworm-security main contrib non-free non-free-firmware

deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
# deb-src http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
cat >/etc/apt/sources.list.d/pve-install-repo.list <<'SOURCES'
deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
SOURCES
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install proxmox-archive-keyring --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install proxmox-ve postfix open-iscsi ifenslave dkms pve-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode lsb-release sbsigntool mokutil dosfstools btrfs-progs cpio
sed -i 's/^/#/' /etc/apt/sources.list.d/pve-enterprise.list
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed libnss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="plymouth-themes synaptic"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-desktop arc-theme nemo gnome-terminal paper-icon-theme
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon cinnamon-core network-manager-gnome blueman gnome-terminal nemo
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-cinnamon-desktop network-manager-gnome blueman
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-shell gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-icon-theme gnome-keyring libpam-gnome-keyring gnome-packagekit
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 task-gnome-desktop
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde-core lxterminal pcmanfm lxde-icon-theme network-manager-gnome blueman lxappearance
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxde-desktop network-manager-gnome blueman
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxqt-core qterminal pcmanfm-qt lxqt-theme-debian network-manager-gnome blueman openbox lxqt-powermanagement lxqt-themes
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-lxqt-desktop network-manager-gnome blueman
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter mate-desktop mate-session-manager marco mate-control-center mate-notification-daemon mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja network-manager-gnome blueman mate-media mate-power-manager
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-mate-desktop blueman
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze kde-plasma-desktop plasma-workspace-wayland kwin-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5 powerdevil plasma-widgets-addons systemsettings
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm sddm-theme-breeze task-kde-desktop plasma-workspace-wayland
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xfce4 xfce4-power-manager-plugins xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter task-xfce-desktop blueman
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
[org.mate.interface]
icon-theme='Papirus'
gtk-theme='Materia'
[org.mate.Marco.general]
theme='Materia'
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml
cat > '/etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xsettings.xml' <<'XFCETHEME'
<?xml version="1.0" encoding="UTF-8"?>
<channel name="xsettings" version="1.0">
  <property name="Net" type="empty">
    <property name="IconThemeName" type="string" value="Papirus"/>
    <property name="ThemeName" type="string" value="Materia"/>
  </property>
</channel>
XFCETHEME
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG audio,sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		mkdir -p /etc/lightdm/lightdm.conf.d
		echo -e '[Seat:*]\ngreeter-hide-users=false\n' > /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			echo -e 'autologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="pve-kernel-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Qubes()
{
hostname=dom0

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
mkdir -p /etc/yum.fake.repos.d
echo -e '[local]\nname = local\nbaseurl = file:///source\nenabled=1\ngpgcheck=0\nrepo_gpgcheck=0' > /etc/yum.fake.repos.d/local.repo
dnf --disablerepo=* --enablerepo=local --setopt=reposdir=/etc/yum.fake.repos.d install -y coreutils util-linux
dnf --disablerepo=* --enablerepo=local --setopt=reposdir=/etc/yum.fake.repos.d --installroot=/mnt install -y @core dnf
mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys
dnf --disablerepo=* --enablerepo=local --setopt=reposdir=/etc/yum.fake.repos.d --installroot=/mnt install -y @"Qubes OS with Xfce" @"Qubes UI (Audio/Gui)"
umount /mnt/sys
umount /mnt/proc
umount /mnt/dev
rm -r /etc/yum.fake.repos.d
mkdir -p /mnt/var/lib/qubes/template-packages
cp /source/Packages/qubes-template-*.rpm /mnt/var/lib/qubes/template-packages/
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-*
dnf --setopt=reposdir=/etc/yum.repos.d/ update -y
dnf --setopt=reposdir=/etc/yum.repos.d/ install -y akmods bash-completion cpio dkms efibootmgr glibc-locale-source grub2-efi-x64 ntfs-3g os-prober sbsigntools
systemctl set-default graphical.target
cat >/root/anaconda-ks.cfg <<INITIALSETUP
#version=DEVEL
# Use graphical install
graphical

%packages
@^qubes-xfce
@qubes-ui

%end

# Run the Setup Agent on first boot
firstboot --enable

# Keyboard layouts
keyboard --vckeymap=${keymap} --xlayouts='${keymap}'
# System language
lang ${locale}.UTF-8

timesource --ntp-disable
# System timezone
timezone ${timezone}

#Root password
rootpw --lock
user --groups=wheel,qubes --name=${username} --password=\$(openssl passwd -6 "${userpass}") --iscrypted
INITIALSETUP
systemctl enable initial-setup.service
if [ "${install_type}" == "image" ]; then
cat >/usr/lib/udev/rules.d/01zz-linuxloops.rules <<'UDEVRULE'
ACTION!="remove", SUBSYSTEM=="block", KERNEL=="loop0*", ENV{DM_UDEV_DISABLE_DISK_RULES_FLAG}="0", ENV{UDEV_DISABLE_PERSISTENT_STORAGE_RULES_FLAG}="0"
UDEVRULE
fi
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel,qubes '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ "${autologin}" == "Yes" ]; then
	groupadd -r autologin
	usermod -aG autologin '${username}'
	mkdir -p /etc/lightdm/lightdm.conf.d
	echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=xfce' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

kernel_parameters="plymouth.ignore-serial-consoles"
xen_cmdline_extra="console=none dom0_mem=min:1024M dom0_mem=max:4096M ucode=scan smt=off gnttab_max_frames=2048 gnttab_max_maptrack_frames=4096"
initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\ndnf --setopt=reposdir=/etc/yum.repos.d/ install -y ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_RockyLinux()
{
prepare_bootstrap="
dnf update -y
dnf install -y bash bash-completion bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
dnf install --installroot=/mnt --releasever / -y @core openssl tar
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
dnf install -y epel-release
rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL*
dnf upgrade --refresh -y
dnf install -y kernel kernel-headers dkms linux-firmware iwl100-firmware iwl1000-firmware iwl105-firmware iwl135-firmware iwl2000-firmware iwl2030-firmware iwl3160-firmware iwl5000-firmware iwl5150-firmware iwl6000g2a-firmware iwl6000g2b-firmware iwl6050-firmware iwl7260-firmware wireless-regdb glibc-locale-source ntfs-3g bash sudo ModemManager NetworkManager-bluetooth NetworkManager-wifi wpa_supplicant bluez cryptsetup e2fsprogs ntfsprogs nano acpid curl thermald bash-completion gpg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr nss-mdns grub2-efi-x64 os-prober shim microcode_ctl mokutil dosfstools cpio
dnf --enablerepo=crb install -y rocky-sb-certs
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

case "${desktop}" in
	'Full')
	default_session="gnome-wayland"
	install_desktop="
dnf install -y @\"Server with GUI\"
systemctl set-default graphical
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
if [ "${autologin}" == "Yes" ]; then
	if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
	echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\ndnf install -y ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_SteamOS()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux wget xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
cat >/etc/pacman_steamos.conf <<'PACMAN-STEAMOS'
#
# /etc/pacman.conf
#
# See the pacman.conf(5) manpage for option and repository directives
 
#
# GENERAL OPTIONS
#
[options]
# The following paths are commented out with their default values listed.
# If you wish to use different paths, uncomment and update the paths.
#RootDir     = /
#DBPath      = /var/lib/pacman/
#CacheDir    = /var/cache/pacman/pkg/
#LogFile     = /var/log/pacman.log
#GPGDir      = /etc/pacman.d/gnupg/
#HookDir     = /etc/pacman.d/hooks/
HoldPkg     = pacman glibc
XferCommand = /usr/bin/curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f -o %o %u
#XferCommand = /usr/bin/wget --tries=5 --read-timeout=5 --passive-ftp -c -O %o %u
#CleanMethod = KeepInstalled
Architecture = auto
 
# Pacman won't upgrade packages listed in IgnorePkg and members of IgnoreGroup
#IgnorePkg   =
#IgnoreGroup =
 
#NoUpgrade   =
NoExtract   = etc/sddm.conf.d/steamdeck.conf etc/skel/Desktop/Return.desktop etc/xdg/autostart/jupiter-plasma-bootstrap.desktop etc/xdg/autostart/steam.desktop usr/bin/jupiter-plasma-bootstrap usr/lib/udev/rules.d/99-kwin-ignore-tablet-mode.rules usr/share/xsessions/*
 
# Misc options
#UseSyslog
#Color
#NoProgressBar
CheckSpace
#VerbosePkgLists
#ParallelDownloads = 5
 
# By default, pacman accepts packages signed by keys that its local keyring
# trusts (see pacman-key and its man page), as well as unsigned packages.
SigLevel    = Required DatabaseOptional
LocalFileSigLevel = Optional
#RemoteFileSigLevel = Required
 
# NOTE: You must run \`pacman-key --init\` before first using pacman; the local
# keyring can then be populated with the keys of all official Arch Linux
# packagers with \`pacman-key --populate archlinux\`.
 
#
# REPOSITORIES
#   - can be defined here or included from another file
#   - pacman will search repositories in the order defined here
#   - local/custom mirrors can be added here or in separate files
#   - repositories listed first will take precedence when packages
#     have identical names, regardless of version number
#   - URLs will have $repo replaced by the name of the current repo
#   - URLs will have $arch replaced by the name of the architecture
#
# Repository entries are of the format:
#       [repo-name]
#       Server = ServerName
#       Include = IncludePath
#
# The header [repo-name] is crucial - it must be present and
# uncommented to enable the repo.
#
 
# The testing repositories are disabled by default. To enable, uncomment the
# repo name header and Include lines. You can add preferred servers immediately
# after the header, and they will be used before the default mirrors.
 
#[testing-3.6]
#Include = /etc/pacman.d/mirrorlist
#SigLevel = Never
 
[core-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never
 
[extra-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never
 
#[community-testing-3.6]
#Include = /etc/pacman.d/mirrorlist
#SigLevel = Never
 
[community-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never
 
[multilib-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never

[jupiter-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never
 
[holo-3.6]
Include = /etc/pacman.d/mirrorlist
SigLevel = Never
 
# An example of a custom package repository.  See the pacman manpage for
# tips on creating your own repositories.
#[custom]
#SigLevel = Optional TrustAll
#Server = file:///home/custompkgs
PACMAN-STEAMOS
cp /etc/pacman_steamos.conf /etc/pacman_steamos_install.conf
sed -i 's@SigLevel    = Required DatabaseOptional@SigLevel    = Never@g' /etc/pacman_steamos_install.conf
sed -i 's@#RemoteFileSigLevel = Required@RemoteFileSigLevel = Optional@g' /etc/pacman_steamos_install.conf
echo 'Server = https://steamdeck-packages.steamos.cloud/archlinux-mirror/\$repo/os/\$arch' > /etc/pacman.d/mirrorlist
pacstrap -C /etc/pacman_steamos_install.conf -G /mnt base base-devel holo-keyring wget
cp /etc/pacman_steamos.conf /mnt/etc/pacman.conf
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
pacman-key --init
pacman-key --populate
pacman -Syu --noconfirm --needed linux linux-headers dkms linux-firmware sof-firmware wireless-regdb bash sudo modemmanager networkmanager wpa_supplicant bluez cryptsetup e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg polkit xdg-user-dirs zstd fwupd patchutils net-tools usb_modeswitch upower efibootmgr grub os-prober shim amd-ucode intel-ucode sbsigntools mokutil dosfstools btrfs-progs cpio
systemctl enable bluetooth.service ModemManager.service NetworkManager.service systemd-resolved.service
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-lib alsa-utils alsa-topology-conf alsa-ucm-conf at-spi2-core avahi cups nss-mdns pipewire-audio pipewire-alsa pipewire-jack pipewire-pulse wireplumber system-config-printer xorg-server"
basic_packages="gvfs udisks2 xdg-user-dirs-gtk"
basic_themes="adobe-source-code-pro-fonts adwaita-icon-theme breeze-gtk breeze-icons gnome-backgrounds materia-gtk-theme noto-fonts oxygen-icons papirus-icon-theme ttf-dejavu ttf-roboto"
specific_packages="archlinux-wallpaper dbus-broker flatpak gamescope mangohud openssh weston steam-im-modules steam-jupiter-stable steam_notif_daemon vulkan-intel lib32-vulkan-intel vulkan-radeon lib32-vulkan-radeon lib32-pipewire lib32-fontconfig ttf-liberation wqy-zenhei"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="avahi-daemon.service cups.service"
case "${desktop}" in
	'Desktop')
	default_session="plasmawayland"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm-wayland qt5-virtualkeyboard plasma-desktop plasma-wayland-session plasma-nm plasma-pa kwin ark dolphin konsole bluedevil powerdevil systemsettings kscreen discover kwallet-pam xdg-desktop-portal-kde steamdeck-kde-presets
"
	;;
	'Gamescope')
	default_session="deck-session"
	install_desktop="
pacman -S --noconfirm ${desktop_base} sddm-wayland qt5-virtualkeyboard plasma-desktop plasma-wayland-session plasma-nm plasma-pa kwin ark dolphin konsole bluedevil powerdevil systemsettings kscreen discover kwallet-pam xdg-desktop-portal-kde steamdeck-kde-presets
cat >/usr/share/wayland-sessions/deck-session.desktop <<'DECK_SESSION'
[Desktop Entry]
Encoding=UTF-8
Name=SteamOS (gamescope)
Comment=SteamOS Big Picture session
Exec=deck-session
Icon=steamicon.png
Type=Application
DesktopNames=gamescope
DECK_SESSION
mkdir -p /etc/skel/Desktop
cat >/etc/skel/Desktop/Return.desktop <<'RETURN_TO_GAMESCOPE'
[Desktop Entry]
Name=Return to Gaming Mode
Exec=return-deck-session
Icon=steamdeck-gaming-return
Terminal=false
Type=Application
StartupNotify=false
RETURN_TO_GAMESCOPE
chmod 0755 /etc/skel/Desktop/Return.desktop
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
systemctl enable ${desktop_services} dbus-broker.service sddm.service
/linuxloops/install_steamos_configs
# Temporary XDG desktop portal fix
cat >/etc/xdg/autostart/xdg-desktop-portal-fix.desktop <<'PORTAL_FIX_AUTOSTART'
[Desktop Entry]
Type=Application
Name=XDG desktop portal fix
Exec=/usr/lib/xdg-desktop-portal-fix
OnlyShowIn=KDE;
NoDisplay=true
X-KDE-autostart-phase=1
PORTAL_FIX_AUTOSTART
cat >/usr/lib/xdg-desktop-portal-fix <<'PORTAL_FIX'
#!/bin/sh
systemctl --user restart xdg-desktop-portal
PORTAL_FIX
chmod 0755 /usr/lib/xdg-desktop-portal-fix
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_steamos_configs <<INSTALL_STEAMOS_CONFIGS
#!/bin/bash
set -e
echo -e 'net.ipv4.tcp_fin_timeout=5\nnet.ipv4.tcp_mtu_probing=1\nnet.ipv6.conf.all.disable_ipv6=1\nnet.ipv6.conf.default.disable_ipv6=1\nvm.compaction_proactiveness=0\nvm.max_map_count=1048576\nvm.swappiness=1' > /etc/sysctl.d/99-steam.conf
mkdir -p /etc/skel/.cache/thumbnails
mkdir -p /etc/skel/.local/share/applications
cat >/etc/skel/.local/share/applications/deck-session.desktop <<'DECKSESSIONICON'
[Desktop Entry]
Name=SteamDeck Session
Exec=deck-session
Icon=steamdeck-gaming-return
Terminal=false
Type=Application
Categories=Game;
PrefersNonDefaultGPU=true
X-KDE-RunOnDiscreteGpu=true
DECKSESSIONICON
cat >/usr/bin/deck-session <<'DECKSESSION'
#!/bin/bash

set -e

##
## Session globals
##
export SDL_VIDEO_MINIMIZE_ON_FOCUS_LOSS=0
export WINE_CPU_TOPOLOGY=8:0,1,2,3,4,5,6,7
export STEAM_ENABLE_VOLUME_HANDLER=1
export SRT_URLOPEN_PREFER_STEAM=1
export STEAM_DISABLE_AUDIO_DEVICE_SWITCHING=1
export STEAM_GAMESCOPE_DYNAMIC_FPSLIMITER=1
export vk_xwayland_wait_ready=false
export QT_IM_MODULE=steam
export GTK_IM_MODULE=Steam
export GAMESCOPE_LIMITER_FILE=\$(mktemp /tmp/gamescope-limiter.XXXXXXXX)
export XCURSOR_THEME="breeze_cursors"
export INTEL_DEBUG=noccs
export R600_DEBUG=nodcc

pkill -9 gamescope || true
pkill -9 steam || true

ulimit -n 524288

gamescope --default-touch-mode 4 --fade-out-duration 200 --generate-drm-mode fixed --hide-cursor-delay 3000 -b -e -f -h 720 -O '*',eDP-1 -- steam -steamos3 -steampal -steamdeck -gamepadui
DECKSESSION
chmod 0755 /usr/bin/deck-session
cat >/usr/bin/return-deck-session <<'RUNGAMINGSESSION'
#!/bin/bash

echo -e '[Autologin]\nSession=deck-session' > /tmp/zz-steamos.conf

qdbus org.kde.Shutdown /Shutdown org.kde.Shutdown.logout
RUNGAMINGSESSION
chmod 0755 /usr/bin/return-deck-session
cat >/usr/bin/steamos-session-select <<'SESSIONSELECT'
#!/bin/bash

echo -e '[Autologin]\nSession=plasmawayland' > /tmp/zz-steamos.conf

pkill -9 steam
pkill -9 gamescope
SESSIONSELECT
chmod 0755 /usr/bin/steamos-session-select
cat >/usr/share/polkit-1/actions/org.valve.steamos.policy <<'POLKIT'
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE policyconfig PUBLIC
 "-//freedesktop//DTD PolicyKit Policy Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/PolicyKit/1/policyconfig.dtd">
<policyconfig>

  <vendor>Valve SteamOS</vendor>
  <vendor_url>http://www.steampowered.com</vendor_url>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-format-sdcard">
    <description>Run the steamos sdcard helper</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-format-sdcard</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-select-branch">
    <description>Run the steamos select branch helper</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-select-branch</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-set-hostname">
    <description>Set the hostname</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-set-hostname</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-set-timezone">
    <description>Set the timezone</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-set-timezone</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-priv-write">
    <description>Helper to write to a set of device nodes</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-priv-write</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-reboot-now">
    <description>Reboot system</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-reboot-now</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-poweroff-now">
    <description>Poweroff system</description>
    <icon_name>package-x-generic</icon_name> 
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-poweroff-now</annotate>
  </action>

  <action id="org.valve.policykit.steamos.pkexec.run-steamos-polkit-helpers-steamos-enable-sshd">
    <description>Enable the SSH server</description>
    <icon_name>package-x-generic</icon_name>
    <defaults>
      <allow_any>yes</allow_any>
      <allow_inactive>yes</allow_inactive>
      <allow_active>yes</allow_active>
    </defaults>
    <annotate key="org.freedesktop.policykit.exec.path">/usr/bin/steamos-polkit-helpers/steamos-enable-sshd</annotate>
  </action>

</policyconfig>
POLKIT
mkdir -p /usr/bin/steamos-polkit-helpers
cat >/usr/bin/steamos-polkit-helpers/steamos-format-sdcard <<'FORMATSDCARD'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

exec /usr/lib/hwsupport/format-sdcard.sh "\$@"
FORMATSDCARD
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-format-sdcard
mkdir -p /usr/lib/hwsupport
cat >/usr/lib/hwsupport/format-sdcard.sh <<'FORMATSDCARDSCRIPT'
#!/bin/bash

set -e

MOUNT_LOCK="/var/run/sdcard-mount.lock"
if [ -e /dev/mmcblk2 ]; then SDCARD_DEVICE="/dev/mmcblk2"; elif [ -e /dev/mmcblk1 ]; then SDCARD_DEVICE="/dev/mmcblk1"; else SDCARD_DEVICE="/dev/mmcblk0"; fi
SDCARD_PARTITION="\$SDCARD_DEVICE"p1
FORCE_FORMAT=0

while [[ \$# -gt 0 ]]; do
    case "\$1" in
        --force) FORCE_FORMAT=1; shift ;;
        *) echo "Unknown option \$1"; exit 22;;
    esac
done

if [[ ! -e "\$SDCARD_DEVICE" ]]; then
    exit 19 #ENODEV
fi

systemctl stop sdcard-mount@mmcblk0p1.service

# lock file prevents the mount service from re-mounting as it gets triggered by udev rules
on_exit() { rm -f -- "\$MOUNT_LOCK"; }
trap on_exit EXIT
echo \$\$ > "\$MOUNT_LOCK"

# Test the sdcard
# Some fake cards advertise a larger size than their actual capacity,
# which can result in data loss or other unexpected behaviour. It is
# best to try to detect these issues as early as possible.
if [[ "\$FORCE_FORMAT" == "0" ]]; then
    echo "stage=testing"
    if ! f3probe --destructive "\$SDCARD_DEVICE"; then
        # Fake sdcards tend to only behave correctly when formatted as exfat
        # The tricks they try to pull fall apart with any other filesystem and
        # it renders the card unusuable.
        #
        # Here we restore the card to exfat so that it can be used with other devices.
        # It won't be usable with the deck, and usage of the card will most likely
        # result in data loss. We return a special error code so we can surface
        # a specific error to the user.
        echo "stage=rescuing"
        echo "Bad sdcard - rescuing"
        for i in {1..3}; do # Give this a couple of tries since it fails sometimes
            echo "Create partition table: \$i"
            dd if=/dev/zero of="\$SDCARD_DEVICE" bs=512 count=1024 # see comment in similar statement below
            if ! parted --script "\$SDCARD_DEVICE" mklabel msdos mkpart primary 0% 100% ; then
                echo "Failed to create partition table: \$i"
                continue # try again
            fi

            echo "Create exfat filesystem: \$i"
            sync
            if ! mkfs.exfat "\$SDCARD_PARTITION"; then
                echo "Failed to exfat filesystem: \$i"
                continue # try again
            fi

            echo "Successfully restored device"
            break
        done

        # Return a specific error code so the UI can warn the user about this bad device
        exit 14 # EFAULT
    fi
fi

# Clear out the garbage bits generated by f3probe from the partition table sectors
# Otherwise parted may think we have existing partitions in a bogus state
dd if=/dev/zero of="\$SDCARD_DEVICE" bs=512 count=1024

# Format as EXT4 with casefolding for proton compatibility
echo "stage=formatting"
sync
parted --script "\$SDCARD_DEVICE" mklabel gpt mkpart primary 0% 100%
sync
mkfs.ext4 -m 0 -O casefold -F "\$SDCARD_PARTITION"
sync

rm "\$MOUNT_LOCK"
systemctl start sdcard-mount@mmcblk0p1.service

exit 0
FORMATSDCARDSCRIPT
chmod 0755 /usr/lib/hwsupport/format-sdcard.sh
cat >/usr/bin/steamos-polkit-helpers/steamos-select-branch <<'SELECTBRANCH'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

exec /usr/bin/steamos-select-branch "\$@"
SELECTBRANCH
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-select-branch
cat >/usr/bin/steamos-select-branch <<'SELECTBRANCHSCRIPT'
#!/bin/bash
set -e

BRANCH_PATH="/var/lib/steamos-branch"

if [[ "\$#" = 1 ]]; then
  case "\$1" in
    "-c")
      branch=\$(cat "\$BRANCH_PATH" 2> /dev/null || echo "rel")
      case "\$branch" in
        "rel" | "rc" | "beta" | "bc" | "main")
          echo "\$branch"
          exit 0
          ;;
        *)
          echo "unknown branch name in \$BRANCH_PATH: \$branch" 1>&2
          exit 1
          ;;
      esac
      ;;
    "-l")
      echo rel
      echo rc
      echo beta
      echo bc
      echo main
      exit 0
      ;;
    "rel" | "rc" | "beta" | "bc" | "main")
      echo "\$1" > "\$BRANCH_PATH"
      exit 0
      ;;
  esac
fi

echo "Usage: steamos-select-branch <-c|-l|rel|rc|beta|bc|main>" 1>&2
SELECTBRANCHSCRIPT
chmod 0755 /usr/bin/steamos-select-branch
cat >/usr/bin/steamos-polkit-helpers/steamos-set-hostname <<'SETHOSTNAME'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

hostnamectl set-hostname "$1"
SETHOSTNAME
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-set-hostname
cat >/usr/bin/steamos-polkit-helpers/steamos-set-timezone <<'SETTIMEZONE'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

timedatectl set-timezone "$1"
SETTIMEZONE
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-set-timezone
cat >//usr/bin/steamos-polkit-helpers/steamos-priv-write <<'PRIVWRITE'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

WRITE_PATH="\$1"
WRITE_VALUE="\$2"

function CommitWrite()
{
    echo "commit: \$WRITE_VALUE -> \$WRITE_PATH" | systemd-cat -t p-steamos-priv-write -p warning
    echo "\$WRITE_VALUE" > "\$WRITE_PATH"
    chmod a+w "\$WRITE_PATH"
    exit 0
}

function DeclineWrite()
{
    echo "decline: \$WRITE_VALUE -> \$WRITE_PATH" | systemd-cat -t p-steamos-priv-write -p err
    echo "\$WRITE_VALUE" > "\$WRITE_PATH"
    exit 1
}

echo "checking: \$WRITE_PATH" | systemd-cat -t p-steamos-priv-write -p warning
if [[ "\$WRITE_PATH" == /sys/class/backlight/*/brightness ]]; then
   CommitWrite
fi

DeclineWrite
PRIVWRITE
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-priv-write
cat >/usr/bin/steamos-polkit-helpers/steamos-reboot-now <<'REBOOT'
#!/bin/bash

set -e

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$(realpath \$0)" "\$@"
fi

reboot
REBOOT
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-reboot-now
cat >/usr/bin/steamos-polkit-helpers/steamos-poweroff-now <<'POWEROFF'
#!/bin/bash

set -e

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$(realpath \$0)" "\$@"
fi

poweroff
POWEROFF
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-poweroff-now
cat >/usr/bin/steamos-polkit-helpers/steamos-enable-sshd <<'ENABLESSHD'
#!/bin/bash

set -eu

if [[ \$EUID -ne 0 ]];
then
    exec pkexec --disable-internal-agent "\$0" "\$@"
fi

exec systemctl enable --now sshd
ENABLESSHD
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-enable-sshd
cat >/usr/bin/steamos-polkit-helpers/steamos-update <<'FAKESTEAMOSUPDATE'
#!/bin/bash

exit 7
FAKESTEAMOSUPDATE
chmod 0755 /usr/bin/steamos-polkit-helpers/steamos-update
cat >/usr/bin/steamos-polkit-helpers/jupiter-biosupdate <<'FAKEBIOSUPDATE'
#!/bin/bash

exit 0
FAKEBIOSUPDATE
chmod 0755 /usr/bin/steamos-polkit-helpers/jupiter-biosupdate
cat >/usr/bin/steamos-polkit-helpers/jupiter-dock-updater <<'FAKEDOCKUPDATE'
#!/bin/bash

exit 7
FAKEDOCKUPDATE
chmod 0755 /usr/bin/steamos-polkit-helpers/jupiter-dock-updater
cat >/usr/bin/gamescope-wayland-teardown-workaround <<'GAMESCOPETEARDOWN'
#!/bin/bash

set -eu

TARGETS=('/bin/bash /usr/bin/deck-session'
         '/usr/bin/kwin_x11')

for target in "\${TARGETS[@]}"; do
  for processtree in \$(pgrep -xf "\$target" || true); do
    kill -- "-\$processtree"
  done
done
GAMESCOPETEARDOWN
chmod 0755 /usr/bin/gamescope-wayland-teardown-workaround
INSTALL_STEAMOS_CONFIGS
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_steamos_configs

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
cat >/etc/polkit-1/rules.d/50-default.rules <<'POLKIT'
polkit.addAdminRule(function(action, subject) {
    return ["unix-group:wheel"];
});
POLKIT
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
mkdir -p /etc/sddm.conf.d
echo -e '[Theme]\nCurrent=breeze' > /etc/sddm.conf.d/99_linuxloops.conf
if [ "${autologin}" == "Yes" ] && [ "${desktop}" == "Desktop" ]; then
	cat >/etc/sddm.conf.d/steamos.conf <<'SDDM'
[Autologin]
Session=${default_session}
User=${username}
SDDM
	sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
elif [ "${desktop}" == "Gamescope" ]; then
	ln -s /tmp/zz-steamos.conf /etc/sddm.conf.d/zz-steamos.conf
	cat >/etc/sddm.conf.d/steamos.conf <<'SDDM'
[General]
DisplayServer=wayland

[Autologin]
Relogin=true
Session=${default_session}
User=${username}

[X11]
# Janky workaround for wayland sessions not stopping in sddm, kills
# all active sddm-helper sessions on teardown
DisplayStopCommand=/usr/bin/gamescope-wayland-teardown-workaround
SDDM
	sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
fi
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux linux-headers"
initramfs_type="initcpio"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\npacman -S --noconfirm ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Tails()
{
prepare_bootstrap="
curl -l https://archlinux.org/mirrorlist/?ip_version=4 -o /etc/pacman.d/mirrorlist
sed -i 's@#Server = https://geo.mirror.pkgbuild.com@Server = https://geo.mirror.pkgbuild.com@g' /etc/pacman.d/mirrorlist
pacman -Syu --noconfirm --needed bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cpio cryptsetup curl dosfstools e2fsprogs efibootmgr fatresize gzip lsof nano openssl parted sbsigntools sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
/linuxloops/install_script
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script <<INSTALL_SCRIPT
#!/bin/bash
set -e
echo "Downloading Tails iso"
curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f https://tails.darklab.sh/pub/tails/stable/"\$(curl -L https://tails.darklab.sh/pub/tails/stable/ | grep '<a href="tails-amd64-' | head -1 | cut -d'>' -f2 | cut -d '/' -f1)"/"\$(curl -L https://tails.darklab.sh/pub/tails/stable/ | grep '<a href="tails-amd64-' | head -1 | cut -d'>' -f2 | cut -d '/' -f1)".img -o /tails.img || { echo -e "Tails image download failed."; exit 1; }
dd if=/tails.img of="${destination_device}" bs=1M status=progress
rm /tails.img
if [ "${install_type}" == "image" ]; then
	mkdir -p /isomount
	mount "${partition_path}"1 /isomount
	mkdir -p /tmp/initramfs/scripts/init-bottom /tmp/initramfs/scripts/init-top /tmp/initramfs/usr/lib/udev/rules.d
	cp /linuxloops/install_initramfs /tmp/initramfs/linuxloops
	chmod 0755 /tmp/initramfs/linuxloops
	cat >/tmp/initramfs/scripts/init-top/udev <<'LINUXLOOPSFIXTOP'
sed -i 's@SYSTEM_PARTITION=.*@SYSTEM_PARTITION=/dev/loop0p1@g' /scripts/init-premount/partitioning
sed -i 's@PARENT_DEVICE=.*@PARENT_DEVICE=/dev/loop0@g' /scripts/init-premount/partitioning
echo "test linuxloopsfix" > /dev/kmsg
LINUXLOOPSFIXTOP
	chmod 0755 /tmp/initramfs/scripts/init-top/udev
	cat >/tmp/initramfs/scripts/init-bottom/udev <<'LINUXLOOPSFIXBOTTOM'
cat >/root/etc/udev/rules.d/99-zzzlinuxloops.rules <<'TAILSUDEV'
SUBSYSTEMS=="block", KERNEL=="loop0", ENV{ID_DRIVE_DETACHABLE}="0", SYMLINK+="TailsBootDev", SYMLINK+="bilibop"
SUBSYSTEMS=="block", KERNEL=="loop0*", ENV{UDISKS_SYSTEM}="1", GROUP="floppy"
ENV{ID_FS_LABEL}=="TailsData", ENV{UDISKS_IGNORE}="1"
TAILSUDEV
sed -i 's#loop|##g' /root/lib/live/boot/*
sed -i 's#if (\${device} =~ m{mmcblk \[0-9]+ \\\\z}xms) {#if (\${device} =~ m{mmcblk [0-9]+ \\\\z}xms or \${device} =~ m{loop [0-9]+ \\\\z}xms) {#g' \$(find /root/usr/local/share/perl | grep 'UDisks.pm' | head -1)
sed -i -e 's#method get_udisks_property (Str \$type, Defined \$object, Str \$property) {#method get_udisks_property (Str \$type, Defined \$object, Str \$property) {\nif (\$type eq "Block" and \$property eq "Drive" and \$object =~ m/loop0/) { return "/dev/loop0"; }\nif (\$type eq "Drive" and \$property eq "ConnectionBus" and \$object =~ m/loop0/) { return "sdio"; }\nif (\$type eq "Drive" and \$property eq "Optical" and \$object =~ m/loop0/) { return 0; }\nif (\$type eq "Drive" and \$property eq "Vendor" and \$object =~ m/loop0/) { return "linuxloops"; }\nif (\$type eq "Drive" and \$property eq "Model" and \$object =~ m/loop0/) { return "linuxloops"; }#g' \$(find /root/usr/local/share/perl | grep 'UDisks.pm' | head -1)
LINUXLOOPSFIXBOTTOM
	chmod 0755 /tmp/initramfs/scripts/init-bottom/udev
	(cd /tmp/initramfs && find . | cpio -o -H newc | gzip > /isomount/live/linuxloops.img)
	mkdir -p /mnt/etc/secureboot_key
	sbattach --signum 1 --detach /mnt/etc/secureboot_key/MOK.tmp /isomount/live/vmlinuz
	openssl pkcs7 -print_certs -inform der -in /mnt/etc/secureboot_key/MOK.tmp -out /mnt/etc/secureboot_key/MOK.pem
	openssl x509 -outform DER -in /mnt/etc/secureboot_key/MOK.pem -out /mnt/etc/secureboot_key/MOK.der
fi
umount /isomount
INSTALL_SCRIPT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_script

initramfs_type="iso_init"
}

chroot_Ubuntu()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales noble /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu noble main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu noble-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu noble-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode update-manager-core snapd sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed iio-sensor-proxy libnss-mdns pipewire pipewire-audio-client-libraries pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="plymouth-themes ubuntu-wallpapers fonts-ubuntu"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-lightdm-theme ubuntu-budgie-desktop budgie-desktop-environment budgie-applications-menu-applet budgie-brightness-controller-applet budgie-hotcorners-applet budgie-indicator-applet budgie-network-manager-applet budgie-rotation-lock-applet budgie-trash-applet ubuntu-budgie-themes pocillo-icon-theme nemo gnome-terminal plank gjs
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-lightdm-theme ubuntu-budgie-desktop
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon cinnamon-core gnome-terminal nemo blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon-desktop-environment
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde lxterminal pcmanfm lxde-icon-theme network-manager-gnome blueman
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lubuntu-desktop qterminal pcmanfm-qt network-manager-gnome blueman humanity-icon-theme
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lubuntu-desktop humanity-icon-theme
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-mate-desktop ubuntu-mate-themes ubuntu-mate-wallpapers mate-control-center mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja ayatana-indicator-application ayatana-indicator-datetime ayatana-indicator-notifications ayatana-indicator-power ayatana-indicator-session ayatana-indicator-sound network-manager-gnome blueman
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-mate-desktop
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kubuntu-desktop plasma-workspace-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kubuntu-desktop plasma-workspace-wayland
"
	;;
	'Studio/Full')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm ubuntustudio-desktop plasma-workspace-wayland ardour obs-studio krita gimp kdenlive digikam darktable patchance
"
	;;
	'Ubuntu')
	default_session="ubuntu-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 ubuntu-desktop-minimal gnome-terminal nautilus gnome-keyring libpam-gnome-keyring yaru-theme-gtk yaru-theme-icon yaru-theme-sound
"
	;;
	'Ubuntu/Full')
	default_session="ubuntu-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 ubuntu-desktop gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'Unity')
	default_session="unity"
	hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed iio-sensor-proxy libnss-mdns pulseaudio pulseaudio-module-bluetooth system-config-printer xserver-xorg"
	desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-unity-desktop network-manager-gnome indicator-applet indicator-application indicator-session nautilus gnome-terminal
"
	;;
	'Unity/Full')
	default_session="unity"
	hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed iio-sensor-proxy libnss-mdns pulseaudio pulseaudio-module-bluetooth system-config-printer xserver-xorg"
	desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-unity-desktop indicator-applet indicator-application indicator-session nautilus gnome-terminal
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xubuntu-desktop xfce4-goodies xubuntu-icon-theme xfce4-power-manager-plugins xfce4-pulseaudio-plugin xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman greybird-gtk-theme elementary-xfce-icon-theme
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xubuntu-desktop
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
echo -e 'APT::Install-Recommends \"0\";\nAPT::Get::Install-Recommends \"false\";' > /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install update-manager software-properties-gtk
apt list --installed | grep -w 'firefox' && yes | DEBIAN_FRONTEND=noninteractive apt purge 'firefox'
apt list --installed | grep -w 'gnome-initial-setup' && yes | DEBIAN_FRONTEND=noninteractive apt purge 'gnome-initial-setup'
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/warty-final-ubuntu.png"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/warty-final-ubuntu.png"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full'|'Ubuntu'|'Ubuntu/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full'|'Studio/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/warty-final-ubuntu.png\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Ubuntu-LTS()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
echo -e 'APT::Install-Recommends "0";\nAPT::Get::Install-Recommends "false";' > /etc/apt/apt.conf.d/99linuxloops
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed amd64-microcode intel-microcode update-manager-core snapd sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf alsa-topology-conf at-spi2-core avahi-discover cups cups-browsed cups-filters firmware-sof-signed iio-sensor-proxy libnss-mdns pipewire pipewire-audio-client-libraries pipewire-pulse wireplumber system-config-printer xserver-xorg"
basic_packages="gvfs-fuse packagekit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk-theme breeze-icon-theme fonts-dejavu fonts-noto fonts-roboto gnome-backgrounds gnome-icon-theme materia-gtk-theme oxygen-icon-theme papirus-icon-theme"
specific_packages="plymouth-themes ubuntu-wallpapers fonts-ubuntu"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-lightdm-theme ubuntu-budgie-desktop budgie-desktop-environment budgie-applications-menu-applet budgie-brightness-controller-applet budgie-hotcorners-applet budgie-indicator-applet budgie-network-manager-applet budgie-rotation-lock-applet budgie-trash-applet ubuntu-budgie-themes pocillo-icon-theme nemo gnome-terminal plank gjs
"
	;;
	'Budgie/Full')
	default_session="budgie-desktop"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter budgie-lightdm-theme ubuntu-budgie-desktop
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon cinnamon-core gnome-terminal nemo blueman
"
	;;
	'Cinnamon/Full')
	default_session="cinnamon"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter cinnamon-desktop-environment
"
	;;
	'Enlightenment')
	default_session="enlightenment"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter enlightenment terminology
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager- connman
find /usr/lib -type f -name enlightenment_system -exec chmod 4755 {} \;
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome-session gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 gnome gnome-control-center gnome-screensaver gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter i3 i3lock i3status dmenu rxvt-unicode volumeicon-alsa network-manager-gnome blueman
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde lxterminal pcmanfm lxde-icon-theme network-manager-gnome blueman
"
	;;
	'Lxde/Full')
	default_session="LXDE"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lxde
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lubuntu-desktop qterminal pcmanfm-qt network-manager-gnome blueman humanity-icon-theme
"
	;;
	'Lxqt/Full')
	default_session="lxqt"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter lubuntu-desktop humanity-icon-theme
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-mate-desktop ubuntu-mate-themes ubuntu-mate-wallpapers mate-control-center mate-applets mate-indicator-applet mate-applet-brisk-menu mate-themes mate-icon-theme mate-terminal caja ayatana-indicator-application ayatana-indicator-datetime ayatana-indicator-notifications ayatana-indicator-power ayatana-indicator-session ayatana-indicator-sound network-manager-gnome blueman
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter ubuntu-mate-desktop
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kubuntu-desktop plasma-workspace-wayland dolphin plasma-discover konsole plasma-nm plasma-pa bluedevil libpam-kwallet5
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm kubuntu-desktop plasma-workspace-wayland
"
	;;
	'Studio/Full')
	default_session="plasmawayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} sddm ubuntustudio-desktop plasma-workspace-wayland ardour obs-studio krita gimp kdenlive digikam darktable
chmod 0644 /etc/grub.d/09_lowlatency
chmod 0755 /etc/grub.d/10_linux
"
	;;
	'Ubuntu')
	default_session="ubuntu-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 ubuntu-desktop-minimal gnome-terminal nautilus gnome-keyring libpam-gnome-keyring yaru-theme-gtk yaru-theme-icon yaru-theme-sound
"
	;;
	'Ubuntu/Full')
	default_session="ubuntu-wayland"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} gdm3 ubuntu-desktop gnome-terminal nautilus gnome-keyring libpam-gnome-keyring
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xubuntu-desktop xfce4-goodies xubuntu-icon-theme xfce4-power-manager-plugins xfce4-pulseaudio-plugin xfce4-terminal thunar xfce4-notifyd network-manager-gnome blueman greybird-gtk-theme elementary-xfce-icon-theme
"
	;;
	'Xfce/Full')
	default_session="xfce"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install network-manager-gnome blueman
rm -f /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install ${desktop_base} lightdm slick-greeter xubuntu-desktop
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
echo -e 'APT::Install-Recommends \"0\";\nAPT::Get::Install-Recommends \"false\";' > /etc/apt/apt.conf.d/99linuxloops
yes | DEBIAN_FRONTEND=noninteractive apt install update-manager software-properties-gtk
apt list --installed | grep -w 'firefox' && yes | DEBIAN_FRONTEND=noninteractive apt purge 'firefox'
apt list --installed | grep -w 'gnome-initial-setup' && yes | DEBIAN_FRONTEND=noninteractive apt purge 'gnome-initial-setup'
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_linuxloops.gschema.override <<'DCONF'
[org.gnome.desktop.background:Budgie]
picture-uri="file:///usr/share/backgrounds/warty-final-ubuntu.png"
[org.gnome.desktop.interface:Budgie]
gtk-theme="Arc"
icon-theme="Papirus"
[org.cinnamon.desktop.background]
picture-uri="file:///usr/share/backgrounds/warty-final-ubuntu.png"
[org.cinnamon.desktop.interface]
gtk-theme="Materia"
icon-theme="Papirus"
[org.cinnamon.desktop.wm.preferences]
theme="Materia"
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/xdg/autostart
cat >/etc/xdg/autostart/budgie-nemo.desktop <<'NEMODESKTOP'
[Desktop Entry]
Type=Application
Name=Nemo
Comment=Start Nemo desktop at log in
Exec=nemo-desktop
OnlyShowIn=Budgie;
AutostartCondition=GSettings org.nemo.desktop show-desktop-icons
X-GNOME-AutoRestart=true
NoDisplay=true
NEMODESKTOP
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full'|'Ubuntu'|'Ubuntu/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full'|'Studio/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		echo -e '[Greeter]\nbackground = /usr/share/backgrounds/warty-final-ubuntu.png\ndraw-user-backgrounds = true' > /etc/lightdm/slick-greeter.conf
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Void()
{
prepare_bootstrap="
xbps-install -Syu xbps
xbps-install -Syu
xbps-install -y bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr gzip lsof nano openssl sudo strace tar util-linux xz zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
yes | xbps-install -Sy -r /mnt -R https://repo-default.voidlinux.org/current base-system
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
xbps-install -Syu
xbps-install -y linux linux-headers dkms linux-firmware wireless-regdb bash sudo ModemManager NetworkManager wpa_supplicant bluez cryptsetup e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg polkit xdg-user-dirs zstd fwupd patch net-tools usb-modeswitch upower efibootmgr grub-x86_64-efi os-prober sbsigntool mokutil dosfstools btrfs-progs cpio
ln -s /etc/sv/bluetoothd /etc/sv/dbus /etc/sv/dhcpcd /etc/sv/named /etc/sv/NetworkManager /etc/sv/polkitd /etc/sv/uuidd /etc/runit/runsvdir/default/
cat >>/etc/rc.conf <<SETTINGS
KEYMAP="${keymap}"
TIMEZONE="${timezone}"
SETTINGS
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

hardware_support="alsa-utils alsa-ucm-conf at-spi2-core avahi-discover cups cups-filters sof-firmware nss-mdns pulseaudio system-config-printer xorg"
basic_packages="gvfs PackageKit udisks2 xdg-user-dirs-gtk"
basic_themes="adwaita-icon-theme breeze-gtk breeze-icons dejavu-fonts-ttf noto-fonts-ttf fonts-roboto-ttf gnome-backgrounds oxygen-icons5 papirus-icon-theme"
specific_packages="font-adobe-source-code-pro plymouth"
desktop_base="${hardware_support} ${basic_packages} ${basic_themes} ${specific_packages}"
desktop_services="/etc/sv/avahi-daemon /etc/sv/cupsd /etc/sv/cups-browsed"
case "${desktop}" in
	'Budgie')
	default_session="budgie-desktop"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter budgie-desktop nautilus gnome-terminal network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Cinnamon')
	default_session="cinnamon"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter cinnamon nemo gnome-terminal network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Gnome')
	default_session="gnome-wayland"
	install_desktop="
xbps-install -y ${desktop_base} gdm gnome-core nautilus gnome-terminal
ln -s /etc/sv/gdm  /etc/runit/runsvdir/default/
"
	;;
	'Gnome/Full')
	default_session="gnome-wayland"
	install_desktop="
xbps-install -y ${desktop_base} gdm gnome
ln -s /etc/sv/gdm /etc/runit/runsvdir/default/
"
	;;
	'i3')
	default_session="i3"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter i3 i3status i3lock dmenu rxvt-unicode volumeicon network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxde')
	default_session="LXDE"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter lxde network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Lxqt')
	default_session="lxqt"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter lxqt network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Mate')
	default_session="mate"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter mate network-manager-applet blueman mate-terminal mate-power-manager mate-applets
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Mate/Full')
	default_session="mate"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter mate mate-extra network-manager-applet blueman mate-terminal mate-power-manager mate-applets
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
	'Plasma')
	default_session="plasmawayland"
	install_desktop="
xbps-install -y ${desktop_base} sddm kde5 dolphin konsole
ln -s /etc/sv/sddm /etc/runit/runsvdir/default/
"
	;;
	'Plasma/Full')
	default_session="plasmawayland"
	install_desktop="
xbps-install -y ${desktop_base} sddm kde5 kde5-baseapps
ln -s /etc/sv/sddm /etc/runit/runsvdir/default/
"
	;;
	'Xfce')
	default_session="xfce"
	install_desktop="
xbps-install -y ${desktop_base} lightdm lightdm-gtk3-greeter xfce4 xfce4-notifyd xfce4-pulseaudio-plugin network-manager-applet blueman
ln -s /etc/sv/lightdm /etc/runit/runsvdir/default/
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
ln -s ${desktop_services} /etc/runit/runsvdir/default/
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG wheel '${username}'
echo "%wheel      ALL=(ALL) ALL" > /etc/sudoers.d/90-wheel
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Gnome'|'Gnome/Full')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Plasma'|'Plasma/Full')
		if [ "${autologin}" == "Yes" ]; then
			mkdir -p /etc/sddm.conf.d
			echo -e '[Autologin]\nUser=${username}\nSession=${default_session}' >> /etc/sddm.conf.d/99-linuxloops.conf
			sudo -u '${username}' bash << 'DISABLE_KWALLET'
mkdir -p \$HOME/.config
echo -e '[Wallet]\nEnabled=false' > \$HOME/.config/kwalletrc
DISABLE_KWALLET
		fi
	;;
	*)
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

initramfs_type="dracut"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nxbps-install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

chroot_Zorin()
{
prepare_bootstrap="
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install bash bash-completion btrfs-progs bzip2 ca-certificates coreutils cryptsetup curl dosfstools e2fsprogs efibootmgr fdisk gzip lsof nano openssl sudo strace tar util-linux xz-utils zstd
"

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot <<PREPARE_CHROOT
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install debootstrap
debootstrap --arch=amd64 --include=ca-certificates,kbd,keyboard-configuration,locales jammy /mnt http://archive.ubuntu.com/ubuntu
PREPARE_CHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/prepare_chroot

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init <<CHROOT_INIT
#!/bin/bash
set -e
cat >/etc/apt/sources.list <<'SOURCESLIST'
deb http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-updates main restricted universe multiverse

deb http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
# deb-src http://archive.ubuntu.com/ubuntu jammy-security main restricted universe multiverse
SOURCESLIST
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt dist-upgrade
yes | DEBIAN_FRONTEND=noninteractive apt install gnupg
cat >/etc/apt/sources.list.d/zorin.list <<'ZORINLIST'
deb https://packages.zorinos.com/stable jammy main
# deb-src https://packages.zorinos.com/stable jammy main

deb https://packages.zorinos.com/patches jammy main
# deb-src https://packages.zorinos.com/patches jammy main

deb https://packages.zorinos.com/apps jammy main
# deb-src https://packages.zorinos.com/apps jammy main

deb https://packages.zorinos.com/drivers jammy main restricted
# deb-src https://packages.zorinos.com/drivers jammy main restricted
ZORINLIST
echo -e 'deb http://ppa.launchpad.net/zorinos/apps/ubuntu jammy main\n# deb-src http://ppa.launchpad.net/zorinos/apps/ubuntu jammy main' > /etc/apt/sources.list.d/zorinos-ubuntu-apps-jammy.list
echo -e 'deb http://ppa.launchpad.net/zorinos/drivers/ubuntu jammy main\n# deb-src http://ppa.launchpad.net/zorinos/drivers/ubuntu jammy main' > /etc/apt/sources.list.d/zorinos-ubuntu-drivers-jammy.list
echo -e 'deb http://ppa.launchpad.net/zorinos/patches/ubuntu jammy main\n# deb-src http://ppa.launchpad.net/zorinos/patches/ubuntu jammy main' > /etc/apt/sources.list.d/zorinos-ubuntu-patches-jammy.list
echo -e 'deb http://ppa.launchpad.net/zorinos/stable/ubuntu jammy main\n# deb-src http://ppa.launchpad.net/zorinos/stable/ubuntu jammy main' > /etc/apt/sources.list.d/zorinos-ubuntu-stable-jammy.list
cat >/etc/apt/preferences.d/zorin-os-patches.pref <<'ZORINPRIORITY'
Explanation: OS patches for Zorin OS.
Explanation: We need this pin because our patched build can lag a few hours behind Ubuntu's updates,
Explanation: and during those few hours packages can be overwritten with unpatched ones.
Package: *
Pin: release o=LP-PPA-zorinos-patches
Pin-Priority: 999
ZORINPRIORITY
cat >/etc/apt/preferences.d/zorinos-patches.pref <<'ZORINPRIORITY2'
Explanation: OS patches for Zorin OS.
Explanation: We need this pin because our patched build can lag a few hours behind Ubuntu's updates,
Explanation: and during those few hours packages can be overwritten with unpatched ones.
Package: *
Pin: release o=Zorin OS,l=Zorin OS Patches
Pin-Priority: 999
ZORINPRIORITY2
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 30FCF8F64F71B61C
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 40E0F448B35AB199
echo -e 'Dpkg::Options {\n  "--force-confnew";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt update --allow-insecure-repositories
yes | DEBIAN_FRONTEND=noninteractive apt install zorin-os-overlay --allow-unauthenticated
yes | DEBIAN_FRONTEND=noninteractive apt update
yes | DEBIAN_FRONTEND=noninteractive apt install -o APT::Immediate-Configure=false --reinstall \$(apt list --installed | cut -d'/' -f1 | sed '1d' | sed -z 's@\n@ @g')
yes | DEBIAN_FRONTEND=noninteractive dpkg --configure -a
echo -e 'Dpkg::Options {\n  "--force-confdef";\n};' > /etc/apt/apt.conf.d/71debconf
yes | DEBIAN_FRONTEND=noninteractive apt install linux-generic linux-headers-generic dkms linux-firmware wireless-regdb bash sudo modemmanager network-manager wpasupplicant bluez cryptsetup-initramfs e2fsprogs ntfs-3g nano acpid curl thermald bash-completion gnupg-utils policykit-1 xdg-user-dirs zstd fwupd fwupd-signed patchutils net-tools usb-modeswitch upower efibootmgr grub-efi grub-efi-amd64-signed os-prober shim-signed update-manager-core snapd sbsigntool mokutil dosfstools btrfs-progs cpio
CHROOT_INIT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/chroot_init

case "${desktop}" in
	'Core')
	default_session="zorin"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install zorin-os-desktop
yes | DEBIAN_FRONTEND=noninteractive apt purge ubuntu-session
"
	;;
	'Core/Windows_apps_support')
	default_session="zorin"
	install_desktop="
dpkg --add-architecture i386
yes | DEBIAN_FRONTEND=noninteractive apt install zorin-os-desktop zorin-windows-app-support winbind
yes | DEBIAN_FRONTEND=noninteractive apt purge ubuntu-session
"
	;;
	'Lite')
	default_session="zorin-os-lite"
	install_desktop="
yes | DEBIAN_FRONTEND=noninteractive apt install zorin-os-lite-desktop
yes | DEBIAN_FRONTEND=noninteractive apt purge gdm3 ibus ubuntu-session xfce4-indicator-plugin
"
	;;
	'Lite/Windows_apps_support')
	default_session="zorin-os-lite"
	install_desktop="
dpkg --add-architecture i386
yes | DEBIAN_FRONTEND=noninteractive apt install zorin-os-lite-desktop zorin-windows-app-support winbind
yes | DEBIAN_FRONTEND=noninteractive apt purge gdm3 ibus ubuntu-session xfce4-indicator-plugin
"
	;;
esac
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop <<INSTALL_DESKTOP
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
${install_desktop}
INSTALL_DESKTOP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_desktop

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user <<INSTALL_USER
#!/bin/bash
set -e
useradd -s /bin/bash -m '${username}'
usermod -aG sudo '${username}'
INSTALL_USER
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_user

cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig <<INSTALL_DMCONFIG
#!/bin/bash
set -e
if [ "${desktop}" == "None" ]; then exit 0; fi
if [ ! -f /usr/share/xsessions/${default_session}.desktop ] && [ ! -f /usr/share/wayland-sessions/${default_session}.desktop ]; then echo "Default session ${default_session} not found."; exit 1; fi
case "${desktop}" in
	'Core'|'Core/Windows_apps_support')
		if [ "${autologin}" == "Yes" ]; then
			if [ -d /etc/gdm3 ]; then gdm_folder="gdm3"; else gdm_folder="gdm"; fi
			echo -e '[daemon]\nAutomaticLoginEnable=True\nAutomaticLogin=${username}\nDefaultSession=${default_session}' >> /etc/\${gdm_folder}/custom.conf
		fi
	;;
	'Lite'|'Lite/Windows_apps_support')
		if [ "${autologin}" == "Yes" ]; then
			groupadd -r autologin
			usermod -aG autologin '${username}'
			mkdir -p /etc/lightdm/lightdm.conf.d
			echo -e '[Seat:*]\nautologin-user=${username}\nautologin-session=${default_session}' >> /etc/lightdm/lightdm.conf.d/99-linuxloops.conf
		fi
	;;
esac
INSTALL_DMCONFIG
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_dmconfig

surface_remove="linux-generic-* linux-headers-* linux-image-* linux-modules-*"
initramfs_type="initramfstools"
if [ ! -z "${custom_packages}" ]; then
	echo -e "#!/bin/bash\nset -e\nyes | DEBIAN_FRONTEND=noninteractive apt install ${custom_packages}" > "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_packages
fi
if [ ! -z "${custom_script}" ]; then
	cp "${custom_script}" "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_custom_script
fi
}

generate_bootstrap_init()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/bootstrap_init <<INITCHROOT
#!/bin/bash
set -e
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:/usr/lib64:/usr/lib/x86_64-linux-gnu:/usr/lib:/lib64:/lib/x86_64-linux-gnu:/lib
${prepare_bootstrap}
if [ -x /linuxloops/partition_script ]; then /linuxloops/partition_script; fi
if [ -x /linuxloops/setup_and_mount_rootfs ]; then /linuxloops/setup_and_mount_rootfs; fi
if [ -x /linuxloops/mount_efi ]; then /linuxloops/mount_efi; fi
if [ -x /linuxloops/prepare_chroot ]; then /linuxloops/prepare_chroot; fi
if [ -x /linuxloops/enter_chroot ]; then /linuxloops/enter_chroot; fi
if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then /linuxloops/create_swap; fi
if [ -x /linuxloops/efi_entry ]; then /linuxloops/efi_entry; fi
INITCHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/bootstrap_init
}

generate_partition_script()
{
if [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/partition_script <<PARTITIONDEVICE
#!/bin/bash
set -e
if [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ]; then
	(echo "g"; echo "n"; echo "2"; echo ""; echo "+64M"; echo "n"; echo "3"; echo ""; echo "+4G"; echo "n"; echo "4"; echo ""; echo "+64M"; echo "n"; echo "5"; echo ""; echo "+4G"; echo "n"; echo "6"; echo ""; echo "+1K"; echo "n"; echo "7"; echo ""; echo "+1G"; echo "n"; echo "8"; echo ""; echo "+16M"; echo "n"; echo "9"; echo ""; echo "+1K"; echo "n"; echo "10"; echo ""; echo "+1K"; echo "n"; echo "11"; echo ""; echo "+8M"; echo "n"; echo "12"; echo ""; echo "+64M"; echo "n"; echo "1"; echo ""; echo "+$((install_sizeMB-9434-3))M"; echo "t"; echo "1"; echo "0FC63DAF-8483-4772-8E79-3D69D8477DE4"; echo "t"; echo "2"; echo "FE3A2A5D-4F32-41A7-B725-ACCC3285A309"; echo "t"; echo "3"; echo "3CB8E202-3B7E-47DD-8A3C-7FF2A13CFCEC"; echo "t"; echo "4"; echo "FE3A2A5D-4F32-41A7-B725-ACCC3285A309"; echo "t"; echo "5"; echo "3CB8E202-3B7E-47DD-8A3C-7FF2A13CFCEC"; echo "t"; echo "6"; echo "FE3A2A5D-4F32-41A7-B725-ACCC3285A309"; echo "t"; echo "7"; echo "3CB8E202-3B7E-47DD-8A3C-7FF2A13CFCEC"; echo "t"; echo "8"; echo "0FC63DAF-8483-4772-8E79-3D69D8477DE4"; echo "t"; echo "9"; echo "2E0A753D-9E48-43B0-8337-B15192CB1B5E"; echo "t"; echo "10"; echo "2E0A753D-9E48-43B0-8337-B15192CB1B5E"; echo "t"; echo "11"; echo "CAB6E88E-ABF3-4102-A07A-D4BB9BE3C1D3"; echo "t"; echo "12"; echo "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"; echo "x"; echo "n"; echo "1"; echo "STATE"; echo "n"; echo "2"; echo "KERN-A"; echo "n"; echo "3"; echo "ROOT-A"; echo "n"; echo "4"; echo "KERN-B"; echo "n"; echo "5"; echo "ROOT-B"; echo "n"; echo "6"; echo "KERN-C"; echo "n"; echo "7"; echo "ROOT-C"; echo "n"; echo "8"; echo "OEM"; echo "n"; echo "9"; echo "reserved"; echo "n"; echo "10"; echo "reserved"; echo "n"; echo "11"; echo "RWFW"; echo "n"; echo "12"; echo "EFI-SYSTEM"; echo "r"; sleep 5; echo "w") | fdisk -w always -W always "${destination_device}"
elif [ "${distro}" == "BlissOS" ]; then
	(echo "g"; echo "n"; echo "1"; echo ""; echo "+512M"; echo "n"; echo "2"; echo ""; echo "+$((install_sizeMB-512-3))M"; echo "t"; echo "1"; echo "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"; echo "t"; echo "2"; echo "0FC63DAF-8483-4772-8E79-3D69D8477DE4"; echo "x"; echo "n"; echo "1"; echo "EFI"; echo "n"; echo "2"; echo "ROOT"; echo "r"; sleep 5; echo "w") | fdisk -w always -W always "${destination_device}"
else
	(echo "g"; echo "n"; echo "1"; echo ""; echo "+512M"; echo "n"; echo "2"; echo ""; echo "+1536M"; echo "n"; echo "3"; echo ""; echo "+$((install_sizeMB-2048-3))M"; echo "t"; echo "1"; echo "C12A7328-F81F-11D2-BA4B-00A0C93EC93B"; echo "t"; echo "2"; echo "BC13C2FF-59E6-4262-A352-B275FD6F7172"; echo "t"; echo "3"; echo "0FC63DAF-8483-4772-8E79-3D69D8477DE4"; echo "x"; echo "n"; echo "1"; echo "EFI"; echo "n"; echo "2"; echo "BOOT"; echo "n"; echo "3"; echo "ROOT"; echo "r"; sleep 5; echo "w") | fdisk -w always -W always "${destination_device}"
fi
#sync
PARTITIONDEVICE
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/partition_script
}

generate_setup_and_mount_rootfs()
{
if [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/setup_and_mount_rootfs <<SETUPFILESYSTEMS
#!/bin/bash
set -e
if [ "${encryption}" == "Yes" ]; then
	echo -n "${userpass}" | cryptsetup --type luks2 --cipher aes-xts-plain64 --hash sha256 --key-size 256 --pbkdf argon2id luksFormat "${root_partition}" -
	echo -n "${userpass}" | cryptsetup --type luks2 --cipher aes-xts-plain64 --hash sha256 --key-size 256 luksOpen "${root_partition}" luks-"\$(blkid -s UUID -o value "${root_partition}")" -
	if [ "${fstype}" == "btrfs" ]; then
		mkfs.btrfs -K -L "ROOT" /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")"
		mount /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" /mnt
		btrfs subvolume create /mnt/@
		btrfs subvolume create /mnt/@home
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then btrfs subvolume create /mnt/@swap; fi
		umount /mnt
		mount -o subvol=@,compress=zstd,autodefrag /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" /mnt
	else
		mkfs.ext4 -E nodiscard -F -L "ROOT" /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")"
		if tune2fs -l /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")"; fi
		if tune2fs -l /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")"; fi
		if tune2fs -l /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")"; fi
		mount /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" /mnt
	fi
else
	if [ "${fstype}" == "btrfs" ]; then
		mkfs.btrfs -K -L "ROOT" "${root_partition}"
		mount "${root_partition}" /mnt
		btrfs subvolume create /mnt/@
		btrfs subvolume create /mnt/@home
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then btrfs subvolume create /mnt/@swap; fi
		umount /mnt
		mount -o subvol=@,compress=zstd,autodefrag "${root_partition}" /mnt
	else
		mkfs.ext4 -E nodiscard -F -L "ROOT" "${root_partition}"
		if tune2fs -l "${root_partition}" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir "${root_partition}"; fi
		if tune2fs -l "${root_partition}" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed "${root_partition}"; fi
		if tune2fs -l "${root_partition}" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file "${root_partition}"; fi		
		mount "${root_partition}" /mnt
	fi
fi
if [ "${fstype}" == "btrfs" ]; then
	if [ "${encryption}" == "Yes" ]; then
		mkdir /mnt/home
		mount -o subvol=@home,compress=zstd,autodefrag /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" /mnt/home
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
			mkdir -p /mnt/var/swap
			mount -o subvol=@swap /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" /mnt/var/swap
		fi
	else
		mkdir /mnt/home
		mount -o subvol=@home,compress=zstd,autodefrag "${root_partition}" /mnt/home
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
			mkdir -p /mnt/var/swap
			mount -o subvol=@swap "${root_partition}" /mnt/var/swap
		fi
	fi
fi
SETUPFILESYSTEMS
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/setup_and_mount_rootfs
}

generate_mount_efi()
{
if [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/mount_efi <<SETUPFILESYSTEMS
#!/bin/bash
set -e
if [ "${distro}" == "BlissOS" ]; then
	mkfs.fat -F 32 -n 'EFI' "${efi_partition}"
	mkdir -p /mnt/boot/efi
	mount "${efi_partition}" /mnt/boot/efi
elif [ "${distro}" == "NixOS" ] && [ "${install_type}" == "image" ]; then
	mkfs.ext4 -E nodiscard -F -L "BOOT" "${boot_partition}"
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir "${boot_partition}"; fi
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed "${boot_partition}"; fi
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file "${boot_partition}"; fi
	losetup --show -fP "${boot_partition}" > /linuxloops/boot_loop
	mkdir -p /mnt/boot
	mount \$(cat /linuxloops/boot_loop) /mnt/boot
	mkfs.fat -F 32 -n 'EFI' "${efi_partition}"
	losetup --show -fP "${efi_partition}" > /linuxloops/efi_loop
	mkdir -p /mnt/boot/efi
	mount \$(cat /linuxloops/efi_loop) /mnt/boot/efi
else
	mkfs.ext4 -E nodiscard -F -L "BOOT" "${boot_partition}"
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w large_dir; then tune2fs -O ^large_dir "${boot_partition}"; fi
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w metadata_csum_seed; then tune2fs -O ^metadata_csum_seed "${boot_partition}"; fi
	if tune2fs -l "${boot_partition}" | grep 'Filesystem features' | grep -q -w orphan_file; then tune2fs -O ^orphan_file "${boot_partition}"; fi
	mkdir -p /mnt/boot
	mount "${boot_partition}" /mnt/boot
	mkfs.fat -F 32 -n 'EFI' "${efi_partition}"
	mkdir -p /mnt/boot/efi
	mount "${efi_partition}" /mnt/boot/efi
fi
SETUPFILESYSTEMS
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/mount_efi
}

generare_enter_chroot()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "NixOS" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/enter_chroot <<ENTERCHROOT
#!/bin/bash
set -e
mount -t proc none /mnt/proc
mount -t sysfs none /mnt/sys
mount -t devtmpfs none /mnt/dev
mount -t devpts none /mnt/dev/pts
mount -t tmpfs -o mode=1777 none /mnt/dev/shm
mount -t tmpfs none /mnt/run
mount -t tmpfs -o mode=1777 none /mnt/tmp
mkdir -p /mnt/linuxloops
mount --bind /linuxloops /mnt/linuxloops
if [ "${desktop}" == "Enlightenment" ]; then
	dns_manager="connman/resolv.conf"
elif [ "${distro}" == "Elementary" ] || [ "${distro}" == "Fedora" ] || [ "${distro}" == "Linuxmint" ] || [ "${distro}" == "Neon" ] || [ "${distro}" == "Nobara" ] || [ "${distro}" == "Pop" ] || [ "${distro}" == "Qubes" ] || [ "${distro}" == "SteamOS" ] || [ "${distro}" == "Ubuntu" ] || [ "${distro}" == "Ubuntu-LTS" ] || [ "${distro}" == "Zorin" ]; then
	dns_manager="systemd/resolve/stub-resolv.conf"
else
	dns_manager="NetworkManager/resolv.conf"
fi
rm -f /mnt/etc/resolv.conf
mkdir -p \$(dirname /run/"\${dns_manager}") \$(dirname /mnt/run/"\${dns_manager}")
touch /mnt/run/"\${dns_manager}"
ln -s  /mnt/run/"\${dns_manager}" /run/"\${dns_manager}"
ln -s /run/"\${dns_manager}" /mnt/etc/resolv.conf
cp /etc/resolv.conf /mnt/etc/resolv.conf
chroot /mnt /linuxloops/chroot_init
if [ -f /linuxloops/install_desktop ]; then chroot /mnt /linuxloops/install_desktop; fi
if [ -f /linuxloops/install_live ]; then chroot /mnt /linuxloops/install_live; fi
if [ -f /linuxloops/install_user ]; then chroot /mnt /linuxloops/install_user; fi
if [ -f /linuxloops/install_dmconfig ]; then chroot /mnt /linuxloops/install_dmconfig; fi
if [ -f /linuxloops/install_settings ]; then chroot /mnt /linuxloops/install_settings; fi
if [ -f /linuxloops/install_secureboot ]; then chroot /mnt /linuxloops/install_secureboot; fi
if [ -f /linuxloops/install_surface ]; then chroot /mnt /linuxloops/install_surface; fi
if [ -f /linuxloops/install_nvidia ]; then chroot /mnt /linuxloops/install_nvidia; fi
if [ -f /linuxloops/install_fstab ]; then chroot /mnt /linuxloops/install_fstab; fi
if [ -f /linuxloops/install_initramfs ]; then chroot /mnt /linuxloops/install_initramfs; fi
if [ -f /linuxloops/install_bootloader ]; then chroot /mnt /linuxloops/install_bootloader; fi
if [ -f /linuxloops/install_custom_packages ]; then chroot /mnt /linuxloops/install_custom_packages; fi
if [ -f /linuxloops/install_custom_script ]; then chroot /mnt /linuxloops/install_custom_script; fi
if [ -f /linuxloops/cleanup ]; then chroot /mnt /linuxloops/cleanup; fi
if [ -f /linuxloops/selinux_fix ]; then chroot /mnt /linuxloops/selinux_fix; fi
ENTERCHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/enter_chroot
}

generate_install_settings()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "NixOS" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_settings <<APPLYSETTINGS
#!/bin/bash
set -e
if [ ! -f /etc/locale.gen ]; then echo "${locale}.UTF-8 UTF-8" > /etc/locale.gen; else sed -i 's@#${locale}.UTF-8 UTF-8\|# ${locale}.UTF-8 UTF-8@${locale}.UTF-8 UTF-8@g' /etc/locale.gen; fi
localedef -i ${locale} -f UTF-8 ${locale}.UTF-8
echo "LANG=${locale}.UTF-8" > /etc/locale.conf
echo "LANG=${locale}.UTF-8" > /etc/default/locale
echo -e "KEYMAP=${keymap}" > /etc/vconsole.conf
cat >/etc/default/keyboard <<'DEBIANKEYBOARD'
XKBMODEL="pc105"
XKBLAYOUT="${keymap}"
XKBVARIANT=""
XKBOPTIONS=""
BACKSPACE="guess"
DEBIANKEYBOARD
mkdir -p /etc/X11/xorg.conf.d
cat >/etc/X11/xorg.conf.d/00-keyboard.conf <<'XKEYBOARD'
Section "InputClass"
        Identifier "system-keyboard"
        MatchIsKeyboard "on"
        Option "XkbLayout" "${keymap}"
EndSection
XKEYBOARD
ln -sf /usr/share/zoneinfo/"${timezone}" /etc/localtime
if [ "${distro}" == "Gentoo" ]; then
	eselect locale set ${locale}.UTF-8
	echo -e 'keymap="${keymap}"\nextended_keymaps=""' > /etc/conf.d/keymaps
	echo -e '${timezone}' > /etc/timezone
fi
dbus-uuidgen > /etc/machine-id
mkdir -p /etc/network
echo -e "auto lo\niface lo inet loopback" > /etc/network/interfaces
echo "${hostname}" > /etc/hostname
if [ "${distro}" == "Proxmox" ]; then
	echo -e "127.0.0.1 localhost localhost.localdomain\n\n::1 ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\nff02::3 ip6-allhosts" > /etc/hosts
elif [ "${distro}" == "Qubes" ]; then
	echo -e "127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4\n::1         localhost localhost.localdomain localhost6 localhost6.localdomain6" > /etc/hosts
else
	echo -e "127.0.0.1 localhost localhost.localdomain\n127.0.1.1 ${hostname}\n\n::1 ip6-localhost ip6-loopback\nfe00::0 ip6-localnet\nff00::0 ip6-mcastprefix\nff02::1 ip6-allnodes\nff02::2 ip6-allrouters\nff02::3 ip6-allhosts" > /etc/hosts
fi
if [ -d /etc/netplan ]; then echo -e 'network:\n    version: 2\n    renderer: NetworkManager\n    ethernets:\n        zz-all-en:\n            match:\n                name: "en*"\n            dhcp4: true\n        zz-all-eth:\n            match:\n                name: "eth*"\n            dhcp4: true' > /etc/netplan/01-netcfg.yaml; chmod 0600 /etc/netplan/01-netcfg.yaml; fi
if [ -d /etc/NetworkManager/conf.d ]; then echo -e '[connection]\nwifi.powersave = 2' > /etc/NetworkManager/conf.d/zz-wifi-powersave-disable.conf; fi
mkdir -p /etc/modprobe.d
echo 'blacklist pcspkr' > /etc/modprobe.d/pcspkr.conf
APPLYSETTINGS
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_settings
}

generate_install_secureboot()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Qubes" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_secureboot <<SECUREBOOT
#!/bin/bash
set -e
mkdir -p \${1}/etc/secureboot_key
if [ "${distro}" == "AlmaLinux" ] || [ "${distro}" == "RockyLinux" ]; then
	cp /usr/share/pki/sb-certs/secureboot-kernel-x86_64.cer \${1}/etc/secureboot_key/MOK.der
elif [ "${distro}" == "OpenSUSE" ]; then
	cp /usr/share/efi/x86_64/grub.der \${1}/etc/secureboot_key/MOK.der
else
	openssl req -newkey rsa:4096 -nodes -keyout \${1}/etc/secureboot_key/MOK.key -new -x509 -sha256 -days 36500 -subj "/CN=Linuxloops Machine Owner Key/" -out \${1}/etc/secureboot_key/MOK.crt
	openssl x509 -outform DER -in \${1}/etc/secureboot_key/MOK.crt -out \${1}/etc/secureboot_key/MOK.der
	chmod 0640 \${1}/etc/secureboot_key/*
	cp \${1}/etc/secureboot_key/MOK.der \${1}/boot/efi/${distro}.der
	if [ "${distro}" == "NixOS" ]; then
		exit 0
	elif [ "${distro}" == "Fedora" ] || [ "${distro}" == "Nobara" ]; then
		chown root:akmods /etc/secureboot_key/*
		mkdir -p /etc/pki/akmods/certs /etc/pki/akmods/private
		rm -rf /etc/pki/akmods/certs/public_key.der /etc/pki/akmods/private/private_key.priv
		ln -s /etc/secureboot_key/MOK.der /etc/pki/akmods/certs/public_key.der
		ln -s /etc/secureboot_key/MOK.key /etc/pki/akmods/private/private_key.priv
	elif [ "${distro}" == "Debian" ] || [ "${distro}" == "Devuan" ] || [ "${distro}" == "Elementary" ] || [ "${distro}" == "Kali" ] || [ "${distro}" == "LMDE" ] || [ "${distro}" == "Linuxmint" ] || [ "${distro}" == "MX" ] || [ "${distro}" == "Neon" ] || [ "${distro}" == "Parrot" ] || [ "${distro}" == "Pop" ] || [ "${distro}" == "Ubuntu" ] || [ "${distro}" == "Ubuntu-LTS" ] || [ "${distro}" == "Zorin" ]; then
		mkdir -p /var/lib/shim-signed/mok
		rm -rf /var/lib/shim-signed/mok/MOK.der /var/lib/shim-signed/mok/MOK.priv
		ln -s /etc/secureboot_key/MOK.der /var/lib/shim-signed/mok/MOK.der
		ln -s /etc/secureboot_key/MOK.key /var/lib/shim-signed/mok/MOK.priv
	fi
	mkdir -p /var/lib/dkms
	rm -rf /var/lib/dkms/mok.pub /var/lib/dkms/mok.key
	ln -s /etc/secureboot_key/MOK.der /var/lib/dkms/mok.pub
	ln -s /etc/secureboot_key/MOK.key /var/lib/dkms/mok.key

fi
SECUREBOOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_secureboot
}

generate_install_surface()
{
if [ ! "${surface}" == "Yes" ]; then return; fi
if [ "${distro}" == "Debian" ] || [ "${distro}" == "Elementary" ] || [ "${distro}" == "Kali" ] || [ "${distro}" == "Linuxmint" ] || [ "${distro}" == "LMDE" ] || [ "${distro}" == "MX" ] || [ "${distro}" == "Neon" ] || [ "${distro}" == "Pop" ] || [ "${distro}" == "Proxmox" ] || [ "${distro}" == "Ubuntu" ] || [ "${distro}" == "Ubuntu-LTS" ] || [ "${distro}" == "Zorin" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_surface <<SURFACEAPT
#!/bin/bash
set -e
curl https://raw.githubusercontent.com/linux-surface/linux-surface/master/pkg/keys/surface.asc | gpg --dearmor | dd of=/etc/apt/trusted.gpg.d/linux-surface.gpg
echo "deb [arch=amd64] https://pkg.surfacelinux.com/debian release main" > /etc/apt/sources.list.d/linux-surface.list
apt update
yes | DEBIAN_FRONTEND=noninteractive apt purge ${surface_remove}
#yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-surface linux-headers-surface iptsd libwacom-surface surface-control surface-dtx-daemon git build-essential cmake meson ninja-build pkg-config libgnutls28-dev python3-pip python3-yaml python3-ply python3-jinja2 qtbase5-dev libqt5core5a libqt5gui5 libqt5widgets5 qttools5-dev-tools libtiff-dev libevent-dev gstreamer1.0-tools libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev v4l2loopback-dkms
yes | DEBIAN_FRONTEND=noninteractive apt install linux-image-surface linux-headers-surface iptsd libwacom-surface surface-control surface-dtx-daemon git build-essential cmake meson ninja-build pkg-config libgnutls28-dev python3-pip python3-yaml python3-ply python3-jinja2 qtbase5-dev libqt5core5a libqt5gui5 libqt5widgets5 qttools5-dev-tools libtiff-dev libevent-dev gstreamer1.0-tools libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
curl -L https://github.com/umlaeute/v4l2loopback/archive/v0.13.1.tar.gz | tar xz -C /usr/src
dkms add -m v4l2loopback -v 0.13.1
ls /usr/lib/modules/*/modules.builtin | sed 's@/usr/lib/modules/@@g' | sed 's@/modules.builtin@@g' | xargs -n1 /usr/lib/dkms/dkms_autoinstaller start
git clone https://git.libcamera.org/libcamera/libcamera.git /tmp/libcamera
cd /tmp/libcamera
meson build -Dpipelines=uvcvideo,ipu3 -Dprefix=/usr -Dgstreamer=enabled -Dv4l2=true
ninja -C build
ninja -C build install
cd /
usermod -aG video '${username}'
SURFACEAPT
elif [ "${distro}" == "Arch" ] || [ "${distro}" == "Manjaro" ] || [ "${distro}" == "SteamOS" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_surface <<SURFACEPACMAN
#!/bin/bash
set -e
curl -s https://raw.githubusercontent.com/linux-surface/linux-surface/master/pkg/keys/surface.asc | pacman-key --add -
pacman-key --finger 56C464BAAC421453
pacman-key --lsign-key 56C464BAAC421453
cat >>/etc/pacman.conf <<'SURFACEREPO'
[linux-surface]
Server = https://pkg.surfacelinux.com/arch/
SURFACEREPO
if [ "${distro}" == "SteamOS" ]; then echo 'SigLevel = Never' >> /etc/pacman.conf; fi
pacman -Syu
# deepin-anything-arch package depends on linux
if [ "${desktop}" != "Deepin" ] && [ "${desktop}" != "Deepin/Full" ]; then pacman -R --noconfirm ${surface_remove}; fi
pacman -S --noconfirm linux-surface linux-surface-headers iptsd libcamera libcamera-tools gst-plugin-libcamera base-devel git fakeroot v4l2loopback-dkms
usermod -aG video '${username}'
SURFACEPACMAN
elif [ "${distro}" == "Fedora" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_surface <<SURFACEDNF
#!/bin/bash
set -e
dnf install -y 'dnf-command(versionlock)'
dnf versionlock add kernel\*
rm -rf /boot/.vmlinuz-* /boot/vmlinuz-* /boot/initramfs-* /boot/symvers-* /boot/System.map-* /usr/lib/modules/* /usr/src/kernels/*
dnf config-manager --add-repo=https://pkg.surfacelinux.com/fedora/linux-surface.repo
dnf update -y
dnf install -y --allowerasing kernel-surface kernel-surface-devel iptsd libwacom-surface surface-control surface-dtx-daemon libcamera libcamera-tools libcamera-qcam libcamera-gstreamer libcamera-ipa pipewire-plugin-libcamera
curl -L https://github.com/umlaeute/v4l2loopback/archive/v0.13.1.tar.gz | tar xz -C /usr/src
dkms add -m v4l2loopback -v 0.13.1
ls /usr/lib/modules/*/modules.builtin | sed 's@/usr/lib/modules/@@g' | sed 's@/modules.builtin@@g' | xargs -n1 /usr/lib/dkms/dkms_autoinstaller start
usermod -aG video '${username}'
SURFACEDNF
elif [ "${distro}" == "Nobara" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_surface <<SURFACEDNF
#!/bin/bash
set -e
dnf-3 config-manager --add-repo=https://pkg.surfacelinux.com/fedora/linux-surface.repo
dnf update -y
dnf install -y --allowerasing iptsd libwacom-surface surface-control surface-dtx-daemon libcamera libcamera-tools libcamera-qcam libcamera-gstreamer libcamera-ipa pipewire-plugin-libcamera v4l2loopback
usermod -aG video '${username}'
SURFACEDNF
fi
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_surface
if [ ! -z "${kernel_parameters}" ]; then kernel_parameters="acpi_enforce_resources=lax ${kernel_parameters}"; else kernel_parameters="acpi_enforce_resources=lax"; fi
}

generate_install_nvidia()
{
if [ ! "${nvidia}" == "Yes" ]; then return; fi
if [ "${distro}" == "Arch" ] || [ "${distro}" == "Artix" ] || [ "${distro}" == "Manjaro" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
pacman -S --noconfirm nvidia-dkms
INSTALLNVIDIA
elif [ "${distro}" == "Debian" ] || [ "${distro}" == "Devuan" ] || [ "${distro}" == "Kali" ] || [ "${distro}" == "LMDE" ] || [ "${distro}" == "MX" ] || [ "${distro}" == "Parrot" ] || [ "${distro}" == "Proxmox" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install nvidia-driver
INSTALLNVIDIA
elif [ "${distro}" == "Elementary" ] || [ "${distro}" == "Linuxmint" ] || [ "${distro}" == "Neon" ] || [ "${distro}" == "Ubuntu" ] || [ "${distro}" == "Ubuntu-LTS" ] || [ "${distro}" == "Zorin" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install \$(apt search nvidia | grep nvidia-driver | grep -v '\-bin' | grep -v '\-open' | grep -v '\-server' | tail -1 | grep -o -P '(nvidia-driver-).*' | cut -d' ' -f1 | cut -d '/' -f1)
INSTALLNVIDIA
elif [ "${distro}" == "Fedora" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
dnf install -y akmod-nvidia
INSTALLNVIDIA
elif [ "${distro}" == "Gentoo" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
emerge -uN x11-drivers/nvidia-drivers
INSTALLNVIDIA
elif [ "${distro}" == "NixOS" ]; then
	nixos_nvidia="
hardware.opengl.enable = true;
services.xserver.videoDrivers = [ \"nvidia\" ];
"
elif [ "${distro}" == "Nobara" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
dnf-3 install -y nvidia-driver
INSTALLNVIDIA
elif [ "${distro}" == "OpenSUSE" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
zypper --non-interactive addrepo https://download.nvidia.com/opensuse/tumbleweed NVIDIA
zypper --non-interactive --gpg-auto-import-keys refresh
zypper --non-interactive install --auto-agree-with-licenses nvidia-glG06 nvidia-utils-G06 x11-video-nvidiaG06
INSTALLNVIDIA
elif [ "${distro}" == "Pop" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
yes | DEBIAN_FRONTEND=noninteractive apt install system76-driver-nvidia
INSTALLNVIDIA
elif [ "${distro}" == "SteamOS" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
pacman -S --noconfirm nvidia-dkms lib32-nvidia-utils
INSTALLNVIDIA
elif [ "${distro}" == "Void" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA
#!/bin/bash
set -e
xbps-install -y void-repo-nonfree
xbps-install -Syu
xbps-install -y nvidia
INSTALLNVIDIA
fi
if [ -f "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia ]; then
	cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia <<INSTALLNVIDIA

if [ -d /etc/systemd ]; then
	mkdir -p /etc/systemd/system-shutdown
	cat >/etc/systemd/system-shutdown/nvidia.shutdown <<'SHUTDOWNFIX'
#!/bin/sh
for MODULE in nvidia_drm nvidia_modeset nvidia_uvm nvidia; do
	if lsmod | grep "\$MODULE" &> /dev/null; then rmmod \$MODULE; fi
done
SHUTDOWNFIX
	chmod 0755 /etc/systemd/system-shutdown/nvidia.shutdown
fi
INSTALLNVIDIA
	chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_nvidia
fi
if [ ! -z "${kernel_parameters}" ]; then kernel_parameters="module_blacklist=nouveau nvidia-drm.modeset=1 ibt=off ${kernel_parameters}"; else kernel_parameters="module_blacklist=nouveau nvidia-drm.modeset=1 ibt=off"; fi
}

generate_install_fstab()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
if [ "${distro}" == "NixOS" ]; then
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_fstab <<GENERATEFSTAB
#!/bin/bash
set -e
if [ "${encryption}" == "Yes" ]; then
	if [ "${fstype}" == "btrfs" ]; then
		fstab="
boot.initrd.luks.devices = {
	luks-\$(blkid -s UUID -o value "${root_partition}") = {
		device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	};
};

fileSystems.\"/\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}"))\";
	fsType = \"btrfs\";
	options = [ \"subvol=@\" \"compress=zstd\" ];
};

fileSystems.\"/home\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}"))\";
	fsType = \"btrfs\";
	options = [ \"subvol=@home\" \"compress=zstd\" ];
};
"
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
			fstab="\${fstab}

fileSystems.\"/var/swap\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}"))\";
	fsType = \"btrfs\";
	options = [ \"subvol=@swap\" ];
};
"
		fi
	else
		fstab="
boot.initrd.luks.devices = {
	luks-\$(blkid -s UUID -o value "${root_partition}") = {
		device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	};
};

fileSystems.\"/\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}"))\";
	fsType = \"ext4\";
};
"
	fi
else
	if [ "${fstype}" == "btrfs" ]; then
		fstab="
fileSystems.\"/\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	fsType = \"btrfs\";
	options = [ \"subvol=@\" \"compress=zstd\" ];
};

fileSystems.\"/home\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	fsType = \"btrfs\";
	options = [ \"subvol=@home\" \"compress=zstd\" ];
};
"
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
			fstab="\${fstab}

fileSystems.\"/var/swap\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	fsType = \"btrfs\";
	options = [ \"subvol=@swap\" ];
};
"
		fi
	else
		fstab="
fileSystems.\"/\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}")\";
	fsType = \"ext4\";
};
"
	fi
fi
fstab="\${fstab}

fileSystems.\"/boot\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${boot_partition}")\";
	fsType = \"ext4\";
};

fileSystems.\"/boot/efi\" = {
	device = \"/dev/disk/by-uuid/\$(blkid -s UUID -o value "${efi_partition}")\";
	fsType = \"vfat\";
};
"
if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
fstab="\${fstab}

swapDevices =
[
  {
	device = \"/var/swap/swapfile\";
  }
];
"
fi
echo "\${fstab}" > /linuxloops/fstab
GENERATEFSTAB
else
	cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_fstab <<GENERATEFSTAB
#!/bin/bash
set -e
if [ "${live}" == "Yes" ]; then rootfs_mount_flags="x-systemd.growfs"; fi
rm -f /etc/fstab
touch /etc/fstab
chmod 0644 /etc/fstab
if [ "${encryption}" == "Yes" ]; then
	if [ "${fstype}" == "btrfs" ]; then
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}")) / btrfs subvol=@,compress=zstd,\${rootfs_mount_flags} 0 0" >> /etc/fstab
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}")) /home btrfs subvol=@home,compress=zstd 0 0" >> /etc/fstab
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}")) /var/swap btrfs subvol=@swap 0 0" >> /etc/fstab; fi
	else
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value /dev/mapper/luks-\$(blkid -s UUID -o value "${root_partition}")) / ext4 errors=remount-ro,\${rootfs_mount_flags} 0 1" >> /etc/fstab
	fi
else
	if [ "${fstype}" == "btrfs" ]; then
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}") / btrfs subvol=@,compress=zstd,\${rootfs_mount_flags} 0 0" >> /etc/fstab
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}") /home btrfs subvol=@home,compress=zstd 0 0" >> /etc/fstab
		if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}") /var/swap btrfs subvol=@swap 0 0" >> /etc/fstab; fi
	else
		echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}") / ext4 errors=remount-ro,\${rootfs_mount_flags} 0 1" >> /etc/fstab
	fi
fi
echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${boot_partition}") /boot ext4 defaults 0 2" >> /etc/fstab
echo -e "/dev/disk/by-uuid/\$(blkid -s UUID -o value "${efi_partition}") /boot/efi vfat defaults 0 2" >> /etc/fstab
if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then echo -e "/var/swap/swapfile none swap sw 0 0" >> /etc/fstab; fi
GENERATEFSTAB
fi
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_fstab
}

add_linuxloops_pre()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
#!/bin/sh
export PATH=/sbin:/bin:/usr/sbin:/usr/bin

mkdir -p /dev /proc /sys /run
mount -n -t devtmpfs devtmpfs /dev  -o nosuid,mode=0755
mount -n -t proc     proc     /proc -o nosuid,noexec,nodev
mount -n -t sysfs    sysfs    /sys  -o nosuid,noexec,nodev
mount -n -t tmpfs    tmpfs    /run  -o nosuid,nodev,mode=0755

echo "linuxloops: boot sequence started." > /dev/kmsg
echo "linuxloops: img_uuid=$img_uuid" > /dev/kmsg
echo "linuxloops: img_path=$img_path" > /dev/kmsg

INITSCRIPT
}

add_linuxloops_recovery()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
recovery_shell()
{
	printk_levels="$(cat /proc/sys/kernel/printk)"
	echo 0 0 0 0 > /proc/sys/kernel/printk
	echo -e "\n\nYou are in the recovery shell, you can notably use the included tools to obtain data on your partitions ("blkid" or "lsblk") or to perform an fscheck ("e2fsck" or "ntfsfix").\nOnce you are done with your modifications, type \"exit\" to reboot the computer.\n\n"
	sh
	reboot -f
}

INITSCRIPT
}

add_linuxloops_udev_start()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
if [ -z "$img_uuid" ] || [ -z "$img_path" ]; then echo "linuxloops: invalid GRUB configuration." > /dev/kmsg; recovery_shell; fi

if [ -x /sbin/udevd ]; then
	UDEVD=/sbin/udevd
	UDEVD_BIN="udevd"
elif [ -x /lib/udev/udevd ]; then
	UDEVD=/lib/udev/udevd
	UDEVD_BIN="udevd"
elif [ -x /lib/systemd/systemd-udevd ]; then
	UDEVD=/lib/systemd/systemd-udevd
	UDEVD_BIN="systemd-udevd"
elif [ -x /usr/lib/systemd/systemd-udevd ]; then
	UDEVD=/usr/lib/systemd/systemd-udevd
	UDEVD_BIN="systemd-udevd"
elif [ -x /usr/lib64/systemd/systemd-udevd ]; then
	UDEVD=/usr/lib64/systemd/systemd-udevd
	UDEVD_BIN="systemd-udevd"
else
	echo "linuxloops: Cannot find udevd nor systemd-udevd." > /dev/kmsg
	recovery_shell
fi

$UDEVD --daemon --resolve-names=never >/linuxloops_udev.log 2>&1
udevadm trigger --action=add --type=subsystems
udevadm trigger --action=add --type=devices
udevadm settle

INITSCRIPT
}

add_linuxloops_main()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
if [ ! -z "$img_uuid" ] && [ ! -z "$img_path" ]; then
	if [ ! -b /dev/disk/by-partuuid/"$img_uuid" ]; then echo "linuxloops: Boot partition was not found." > /dev/kmsg; recovery_shell; fi
	mkdir /linuxloops_root || { echo "linuxloops: Root directory cannot be created." > /dev/kmsg; recovery_shell; }
	if [ ! -z "$linuxloops_debug" ]; then recovery_shell; fi

	fstype=$(blkid -s TYPE -o value /dev/disk/by-partuuid/"$img_uuid")
	if [ "$fstype" = "ntfs" ]; then
		ntfs-3g /dev/disk/by-partuuid/"$img_uuid" /linuxloops_root || { echo "linuxloops: The boot partition could not be mounted." > /dev/kmsg; recovery_shell; }
	else
		mount -n -t "$fstype" /dev/disk/by-partuuid/"$img_uuid" /linuxloops_root || { echo "linuxloops: The boot partition could not be mounted." > /dev/kmsg; recovery_shell; }
	fi

	if [ -f /linuxloops_root/"$img_path" ]; then
		modprobe loop || { echo "linuxloops: Loop module is not available." > /dev/kmsg; recovery_shell; }
		if [ ! -b /dev/loop0 ]; then mknod -m 660 /dev/loop0 b 7 0 || { echo "linuxloops: The loop device could not be created." > /dev/kmsg; recovery_shell; }; fi
		losetup --direct-io=off -P /dev/loop0 /linuxloops_root"$img_path" || { echo "linuxloops: The loop device could not be configured." > /dev/kmsg; recovery_shell; }
		#losetup -P /dev/loop0 /linuxloops_root"$img_path" || { echo "linuxloops: The loop device could not be configured." > /dev/kmsg; recovery_shell; }
	else
		echo "linuxloops: The rootfs image file was not found, it might be due to an incorrect GRUB config or unsupported configuration." > /dev/kmsg
		recovery_shell
	fi

	udevadm trigger --action=add --type=subsystems
	udevadm trigger --action=add --type=devices
	udevadm settle
fi

INITSCRIPT
}

add_linuxloops_udev_end()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
udevadm control --exit
udevadm info --cleanup-db

timer=0
while ps | grep -q '[u]devd'; do
	echo "linuxloops: udevd is not yet killed, sleeping 1s" > /dev/kmsg
	if [ $timer -eq 3 ]; then echo "linuxloops: udevd could not be killed, continuing anyway..." > /dev/kmsg; break; fi
	sleep 1
	timer=$((timer+1))
done

INITSCRIPT
}

add_linuxloops_post()
{
touch "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
cat >>"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<'INITSCRIPT'
if [ -z "$linuxloops_init" ]; then
	if [ -x /init ]; then
		linuxloops_init="/init"
	elif [ -x /sbin/init ]; then
		linuxloops_init="/sbin/init"
	else
		echo "linuxloops: No init system found." > /dev/kmsg
		recovery_shell
	fi
fi

echo "linuxloops: boot sequence finished." > /dev/kmsg

umount /run
umount /sys
umount /proc
umount /dev > /dev/null 2>&1 || umount -l /dev > /dev/null 2>&1 || echo "linuxloops: /dev was not properly unmounted" > /dev/kmsg

#sh

exec "$linuxloops_init"
INITSCRIPT
}

generate_initcpio()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<INITCPIOSTART
#!/bin/bash
set -e
if [ "${encryption}" == "Yes" ]; then
	sed -i 's@ block filesystems fsck)@ block encrypt filesystems fsck linuxloops)@g' /etc/mkinitcpio.conf
else
	sed -i 's@ block filesystems fsck)@ block filesystems fsck linuxloops)@g' /etc/mkinitcpio.conf
fi
rm -rf /boot/linuxloops
mkdir -p /boot/linuxloops/initcpio-hook
cat >/boot/linuxloops/initcpio-hook/linuxloops <<'INSTALLHOOK'
#!/bin/bash

build() {
	add_module "8250_dw"
	add_module "aes"
	add_module "atkbd"
	add_module "btrfs"
	add_module "cbc"
	add_module "dm_crypt"
	add_module "exfat"
	add_module "ext4"
	add_module "fuse"
	add_module "i8042"
	add_module "intel_lpss"
	add_module "intel_lpss_pci"
	add_module "loop"
	add_module "nvme"
	add_module "quota_v1"
	add_module "quota_v2"
	add_module "serio"
	add_module "sha256"
	add_module "surface_aggregator"
	add_module "surface_aggregator_registry"
	add_module "surface_hid"
	add_module "surface_hid_core"
	add_module "usbhid"
	add_module "xhci_pci"

	add_binary "bash"
	add_binary "blkid"
	add_binary "cryptsetup"
	add_binary "cut"
	add_binary "e2fsck"
	add_binary "find"
	add_binary "grep"
	add_binary "losetup"
	add_binary "lsblk"
	add_binary "ntfs-3g"
	add_binary "ntfsfix"
	add_binary "ps"
	add_binary "setfont"
	add_binary "setsid"

	cp "/boot/linuxloops/linuxloops" "\$BUILDROOT/linuxloops"

	for i in \$(find /usr/lib/udev/rules.d/*-linuxloops.rules 2>/dev/null); do
		cp "\${i}" "\$BUILDROOT\$i"
	done

	if ls /boot/vmlinuz-* >/dev/null 2>&1 && [ -f /etc/secureboot_key/MOK.key ] && [ -f /etc/secureboot_key/MOK.crt ] && [ ! -z "\$(command -v sbsign)" ] && [ ! -z "\$(command -v sbverify)" ]; then
		for i in /boot/vmlinuz-*; do
			if ! sbverify --list \$i | grep -q 'CN=Linuxloops Machine Owner Key'; then
				sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output \$i \$i
			fi
		done
	fi
}

help() {
    cat <<HELPEOF
Installs the linuxloops hook.
HELPEOF
}
INSTALLHOOK
chmod 0755 /boot/linuxloops/initcpio-hook/linuxloops
ln -s /boot/linuxloops/initcpio-hook/linuxloops /etc/initcpio/install/linuxloops
cat >/boot/linuxloops/linuxloops <<'LINUXLOOPSBINARY'
INITCPIOSTART
add_linuxloops_pre
add_linuxloops_recovery
add_linuxloops_udev_start
add_linuxloops_main
add_linuxloops_udev_end
add_linuxloops_post
echo -e "LINUXLOOPSBINARY" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "chmod 0755 /boot/linuxloops/linuxloops" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "(cd /boot/linuxloops && find . | cpio -o -H newc | gzip > /boot/linuxloops/linuxloops-recovery.img)" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
if [ "${distro}" != "BlendOS" ]; then echo -e "mkinitcpio -P" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs; fi
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
}

generate_initramfstools()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<INITRAMFSTOOLSSTART
#!/bin/bash
set -e
rm -rf /boot/linuxloops
mkdir -p /boot/linuxloops/initramfstools-hook
cat >/boot/linuxloops/initramfstools-hook/linuxloops <<'INSTALLHOOK'
#!/bin/bash
PREREQ=""
prereqs()
{
   echo "\$PREREQ"
}

case \$1 in
prereqs)
   prereqs
   exit 0
   ;;
esac

. /usr/share/initramfs-tools/hook-functions
# Begin real processing below this line

	rm -f "\$DESTDIR/bin/losetup" "\$DESTDIR/sbin/losetup"

	manual_add_modules "8250_dw"
	manual_add_modules "aes"
	manual_add_modules "atkbd"
	manual_add_modules "btrfs"
	manual_add_modules "cbc"
	manual_add_modules "dm-crypt"
	manual_add_modules "exfat"
	manual_add_modules "ext4"
	manual_add_modules "fuse"
	manual_add_modules "i8042"
	manual_add_modules "intel_lpss"
	manual_add_modules "intel_lpss_pci"
	manual_add_modules "loop"
	manual_add_modules "nvme"
	manual_add_modules "quota_v1"
	manual_add_modules "quota_v2"
	manual_add_modules "serio"
	manual_add_modules "sha256"
	manual_add_modules "surface_aggregator"
	manual_add_modules "surface_aggregator_registry"
	manual_add_modules "surface_hid"
	manual_add_modules "surface_hid_core"
	manual_add_modules "usbhid"
	manual_add_modules "xhci_pci"

	copy_exec "\$(command -v bash)"
	copy_exec "\$(command -v blkid)"
	copy_exec "\$(command -v cryptsetup)"
	copy_exec "\$(command -v cut)"
	copy_exec "\$(command -v e2fsck)"
	copy_exec "\$(command -v find)"
	copy_exec "\$(command -v grep)"
	copy_exec "\$(command -v losetup)"
	copy_exec "\$(command -v lsblk)"
	copy_exec "\$(command -v ntfs-3g)"
	copy_exec "\$(command -v ntfsfix)"
	copy_exec "\$(command -v ps)"
	copy_exec "\$(command -v setfont)"
	copy_exec "\$(command -v setsid)"

	cp "/boot/linuxloops/linuxloops" "\$DESTDIR/linuxloops"

	for i in \$(find /usr/lib/udev/rules.d/*-linuxloops.rules 2>/dev/null); do
		cp "\${i}" "\$DESTDIR\$i"
	done

	if ls /boot/vmlinuz-* >/dev/null 2>&1 && [ -f /etc/secureboot_key/MOK.key ] && [ -f /etc/secureboot_key/MOK.crt ] && [ ! -z "\$(command -v sbsign)" ] && [ ! -z "\$(command -v sbverify)" ]; then
		for i in /boot/vmlinuz-*; do
			if ! sbverify --list \$i | grep -q 'CN=Linuxloops Machine Owner Key'; then
				sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output \$i \$i
			fi
		done
	fi
INSTALLHOOK
chmod 0755 /boot/linuxloops/initramfstools-hook/linuxloops
ln -s /boot/linuxloops/initramfstools-hook/linuxloops /etc/initramfs-tools/hooks/linuxloops
cat >/boot/linuxloops/linuxloops <<'LINUXLOOPSBINARY'
INITRAMFSTOOLSSTART
add_linuxloops_pre
add_linuxloops_recovery
add_linuxloops_udev_start
add_linuxloops_main
add_linuxloops_udev_end
add_linuxloops_post
echo -e "LINUXLOOPSBINARY" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "chmod 0755 /boot/linuxloops/linuxloops" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "(cd /boot/linuxloops && find . | cpio -o -H newc | gzip > /boot/linuxloops/linuxloops-recovery.img)" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "DEBIAN_FRONTEND=noninteractive dpkg-reconfigure keyboard-configuration" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "update-initramfs -u -k all" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
}

generate_dracut()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<INITDRACUTSTART
#!/bin/bash
set -e
rm -rf /boot/linuxloops
mkdir -p /boot/linuxloops/dracut-hook
cat >/boot/linuxloops/dracut-hook/module-setup.sh <<'INSTALLHOOK'
#!/bin/bash

check() {
	return 0
}

installkernel() {
	instmods "8250_dw"
	instmods "aes"
	instmods "atkbd"
	instmods "btrfs"
	instmods "cbc"
	instmods "dm-crypt"
	instmods "exfat"
	instmods "ext4"
	instmods "fuse"
	instmods "i8042"
	instmods "intel_lpss"
	instmods "intel_lpss_pci"
	instmods "loop"
	instmods "nvme"
	instmods "quota_v1"
	instmods "quota_v2"
	instmods "serio"
	instmods "sha256"
	instmods "surface_aggregator"
	instmods "surface_aggregator_registry"
	instmods "surface_hid"
	instmods "surface_hid_core"
	instmods "usbhid"
	instmods "xhci_pci"
}

install() {
	inst "\$(command -v bash)" "/usr/bin/bash"
	inst "\$(command -v blkid)" "/usr/sbin/blkid"
	inst "\$(command -v cryptsetup)" "/usr/sbin/cryptsetup"
	inst "\$(command -v cut)" "/usr/sbin/cut"
	inst "\$(command -v e2fsck)" "/usr/sbin/e2fsck"
	inst "\$(command -v find)" "/usr/bin/find"
	inst "\$(command -v grep)" "/usr/sbin/grep"
	inst "\$(command -v losetup)" "/usr/sbin/losetup"
	inst "\$(command -v lsblk)" "/usr/sbin/lsblk"
	inst "\$(command -v ntfs-3g)" "/usr/sbin/ntfs-3g"
	inst "\$(command -v ntfsfix)" "/usr/sbin/ntfsfix"
	inst "\$(command -v ps)" "/usr/bin/ps"
	inst "\$(command -v setfont)" "/usr/bin/setfont"
	inst "\$(command -v setsid)" "/usr/sbin/setsid"

	cp "/boot/linuxloops/linuxloops" "\${initdir}/linuxloops"
	
	for i in \$(find /usr/lib/udev/rules.d/*-linuxloops.rules 2>/dev/null); do
		cp "\${i}" "\${initdir}\$i"
	done

	if ls /boot/vmlinuz-* >/dev/null 2>&1 && [ -f /etc/secureboot_key/MOK.key ] && [ -f /etc/secureboot_key/MOK.crt ] && [ ! -z "\$(command -v sbsign)" ] && [ ! -z "\$(command -v sbverify)" ]; then
		for i in /boot/vmlinuz-*; do
			if ! sbverify --list \$i | grep -q 'CN=Linuxloops Machine Owner Key'; then
				sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output \$i \$i
			fi
		done
	fi
}
INSTALLHOOK
chmod 0755 /boot/linuxloops/dracut-hook/module-setup.sh
mkdir -p /usr/lib/dracut/modules.d/99linuxloops
ln -s /boot/linuxloops/dracut-hook/module-setup.sh /usr/lib/dracut/modules.d/99linuxloops/module-setup.sh
cat >/boot/linuxloops/linuxloops <<'LINUXLOOPSBINARY'
INITDRACUTSTART
add_linuxloops_pre
add_linuxloops_recovery
add_linuxloops_udev_start
add_linuxloops_main
add_linuxloops_udev_end
add_linuxloops_post
echo -e "LINUXLOOPSBINARY" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "chmod 0755 /boot/linuxloops/linuxloops" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "(cd /boot/linuxloops && find . | cpio -o -H newc | gzip > /boot/linuxloops/linuxloops-recovery.img)" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "if grep -q '^hostonly=' /etc/dracut.conf; then sed -i '@^hostonly=@d' /etc/dracut.conf; fi; echo 'hostonly=\"yes\"' >> /etc/dracut.conf" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
echo -e "dracut --regenerate-all --force" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
}

generate_nixos_config()
{
if [ "${install_type}" == "image" ]; then cmdline="\\\${linuxloops_args}"; fi
if [ -z "${cmdline}" ]; then cmdline="quiet"; else cmdline="${cmdline} quiet"; fi
if [ ! -z "${kernel_parameters}" ]; then cmdline="${cmdline} ${kernel_parameters}"; fi
cmdline=$(echo -n "\"${cmdline}\"" | sed 's@ @" "@g')
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs <<INITNIXOS
#!/bin/bash
set -e
mkdir -p /mnt/etc/nixos
cat >/mnt/etc/nixos/configuration.nix <<'NIXOSCONFIGURATION'
# Edit this configuration file to define what should be installed on
# your system.  Help is available in the configuration.nix(5) man page
# and in the NixOS manual (accessible by running ‘nixos-help’).

{ config, pkgs, ... }:

{
imports = [ ./linuxloops.nix ];

boot.kernelParams = [ ${cmdline} ];
boot.loader = {
	efi = {
		canTouchEfiVariables = false;
		efiSysMountPoint = "/boot/efi";
	};
	grub = {
		configurationLimit = 3;
		device = "nodev";
		efiInstallAsRemovable = true;
		efiSupport = true;
		enable = true;
		extraGrubInstallArgs = [ "--modules=all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo" ];
		fsIdentifier = "uuid";
		useOSProber = false;
	};
};

console.earlySetup = true;
console.keyMap = "${keymap}";
i18n.defaultLocale = "${locale}.UTF-8";
time.timeZone = "${timezone}";

boot.kernelPackages = pkgs.linuxPackages_latest;
hardware.cpu.intel.updateMicrocode = true;
hardware.cpu.amd.updateMicrocode = true;
hardware.enableAllFirmware = true;

hardware.bluetooth.enable = true;
hardware.sensor.iio.enable = true;
hardware.pulseaudio.enable = false;
networking.hostName = "${hostname}";
networking.networkmanager.enable = true;

services.avahi.enable = true;
services.avahi.nssmdns = true;
services.logrotate.checkConfig = false;
services.pipewire = {
  enable = true;
  alsa.enable = true;
  alsa.support32Bit = true;
  pulse.enable = true;
};
services.printing.enable = true;

environment.systemPackages = with pkgs; [ ntfs3g openssl sbsigntool ${custom_packages} ];

${nixos_desktop}
${nixos_nvidia}

$(cat "${custom_script}" 2>/dev/null)

nixpkgs.config.allowUnfree = true;

# This value determines the NixOS release from which the default
# settings for stateful data, like file locations and database versions
# on your system were taken. It‘s perfectly fine and recommended to leave
# this value at the release version of the first install of this system.
# Before changing this value read the documentation for this option
# (e.g. man configuration.nix or on https://nixos.org/nixos/options.html).
system.stateVersion = "23.11"; # Did you read the comment?
}
NIXOSCONFIGURATION
echo -e '# Do not modify this file which contains the linuxloops configuration.\n# Please make changes to /etc/nixos/configuration.nix instead.\n{ config, lib, pkgs, modulesPath, ... }:\n\n{' > /mnt/etc/nixos/linuxloops.nix
cat /linuxloops/fstab >>/mnt/etc/nixos/linuxloops.nix
cat >>/mnt/etc/nixos/linuxloops.nix <<'NIXOSLINUXLOOPS'
#https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/profiles/all-hardware.nix
boot.initrd.availableKernelModules = [ "3w-9xxx" "3w-xxxx" "8250_dw" "aes" "ahci" "aic79xx" "aic7xxx" "arcmsr" "ata_piix" "atkbd" "btrfs" "cbc" "dm_crypt" "ehci_hcd" "encrypted_keys" "exfat" "ext4" "fuse" "hv_storvsc" "i8042" "intel_lpss" "intel_lpss_pci" "loop" "mmc_block" "mptspi" "nvme" "ohci1394" "pata_ali" "pata_amd" "pata_artop" "pata_atiixp" "pata_efar" "pata_hpt366" "pata_hpt37x" "pata_hpt3x2n" "pata_hpt3x3" "pata_it8213" "pata_it821x" "pata_jmicron" "pata_marvell" "pata_mpiix" "pata_netcell" "pata_ns87410" "pata_oldpiix" "pata_pcmcia" "pata_pdc2027x" "pata_qdi" "pata_rz1000" "pata_serverworks" "pata_sil680" "pata_sis" "pata_sl82c105" "pata_triflex" "pata_via" "pata_winbond" "quota_v1" "quota_v2" "sata_inic162x" "sata_nv" "sata_promise" "sata_qstor" "sata_sil" "sata_sil24" "sata_sis" "sata_svw" "sata_sx4" "sata_uli" "sata_via" "sata_vsc" "sbp2" "sd_mod" "sdhci_acpi" "sdhci_pci" "serio" "sha256" "sr_mod" "surface_aggregator" "surface_aggregator_registry" "surface_hid" "surface_hid_core" "uas" "uhci_hcd" "usbhid" "usb_storage" "virtio_net" "virtio_pci" "virtio_mmio" "virtio_blk" "virtio_scsi" "virtio_balloon" "virtio_console" "vmxnet3" "vsock" "vmw_balloon" "vmw_vmci" "vmwgfx" "vmw_vsock_vmci_transport" "xhci_pci" ];

boot.initrd.compressor="gzip";
boot.initrd.extraUtilsCommands = ''
copy_bin_and_libs "\${pkgs.bash}/bin/bash"
copy_bin_and_libs "\${pkgs.util-linux}/bin/blkid"
copy_bin_and_libs "\${pkgs.cryptsetup}/bin/cryptsetup"
copy_bin_and_libs "\${pkgs.coreutils}/bin/cut"
copy_bin_and_libs "\${pkgs.e2fsprogs}/bin/e2fsck"
copy_bin_and_libs "\${pkgs.findutils}/bin/find"
copy_bin_and_libs "\${pkgs.gnugrep}/bin/grep"
copy_bin_and_libs "\${pkgs.util-linux}/bin/losetup"
copy_bin_and_libs "\${pkgs.util-linux}/bin/lsblk"
copy_bin_and_libs "\${pkgs.ntfs3g}/bin/ntfs-3g"
copy_bin_and_libs "\${pkgs.ntfs3g}/bin/ntfsfix"
copy_bin_and_libs "\${pkgs.procps}/bin/ps"
copy_bin_and_libs "\${pkgs.kbd}/bin/setfont"
copy_bin_and_libs "\${pkgs.util-linux}/bin/setsid"
'';

boot.loader.grub.extraInstallCommands = ''
	if \${pkgs.coreutils}/bin/ls /boot/kernels/*-linux-*Image >/dev/null 2>&1 && [ -f /etc/secureboot_key/MOK.key ] && [ -f /etc/secureboot_key/MOK.crt ] && [ -x \${pkgs.sbsigntool}/bin/sbsign ] && [ -x \${pkgs.sbsigntool}/bin/sbverify ]; then
		for i in /boot/kernels/*-linux-*Image; do
			if ! \${pkgs.sbsigntool}/bin/sbverify --list \$i | \${pkgs.gnugrep}/bin/grep -q 'CN=Linuxloops Machine Owner Key'; then
				\${pkgs.sbsigntool}/bin/sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output \$i \$i
			fi
		done
	fi
	\${pkgs.coreutils}/bin/mkdir -p /boot/efi/EFI/nixos
	\${pkgs.coreutils}/bin/cp /boot/efi/EFI/BOOT/BOOTX64.EFI /boot/efi/EFI/nixos/grubx64.efi
'';

boot.initrd.preLVMCommands = ''
INITNIXOS
add_linuxloops_recovery
add_linuxloops_main
echo -e "'';\n}\nNIXOSLINUXLOOPS\n" >> "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_initramfs
}

generate_iso_init()
{
add_linuxloops_pre
add_linuxloops_recovery
add_linuxloops_udev_start
add_linuxloops_main
add_linuxloops_udev_end
add_linuxloops_post
}

generate_install_initramfs()
{
if [ "${initramfs_type}" == "initcpio" ] || [ "${initramfs_type}" == "initramfstools" ] || [ "${initramfs_type}" == "dracut" ] || [ "${initramfs_type}" == "nixos_config" ] || [ "${initramfs_type}" == "iso_init" ]; then
	generate_"${initramfs_type}"
fi
}

generate_install_bootloader()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "NixOS" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_bootloader <<INSTALLEFI
#!/bin/bash
set -e
if [ "${install_type}" == "image" ]; then cmdline="\\\\\\\${linuxloops_args}"; fi
if [ "${initramfs_type}" == "initcpio" ]; then
	if [ "${encryption}" == "Yes" ]; then if [ ! -z "\${cmdline}" ]; then cmdline="\${cmdline} "; fi; cmdline="\${cmdline}cryptdevice=UUID=\$(blkid -s UUID -o value "${root_partition}"):luks-\$(blkid -s UUID -o value "${root_partition}") rd.luks.uuid=\$(blkid -s UUID -o value "${root_partition}")"; fi
elif [ "${initramfs_type}" == "initramfstools" ]; then
	if [ "${encryption}" == "Yes" ]; then if [ ! -z "\${cmdline}" ]; then cmdline="\${cmdline} "; fi; cmdline="\${cmdline}cryptopts=target=luks-\$(blkid -s UUID -o value "${root_partition}"),source=/dev/disk/by-uuid/\$(blkid -s UUID -o value "${root_partition}"),luks"; fi
elif [ "${initramfs_type}" == "dracut" ]; then
	if [ "${encryption}" == "Yes" ]; then if [ ! -z "\${cmdline}" ]; then cmdline="\${cmdline} "; fi; cmdline="\${cmdline}rd.luks.uuid=\$(blkid -s UUID -o value "${root_partition}")"; fi
fi
cmdline_extra="quiet splash ${kernel_parameters}"
cat >/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
#!/bin/bash
set -e
cat >/etc/default/grub <<'GRUBDEFAULTS'
GRUB_DISTRIBUTOR="\$(if [ "${distro}" == "MX" ]; then echo "MX"; elif [ "${distro}" == "Parrot" ]; then echo "Parrot OS"; elif [ "${distro}" == "SteamOS" ]; then echo "SteamOS"; elif [ "${distro}" == "Proxmox" ]; then echo "Proxmox Virtual Environment"; elif [ -f /etc/system-release ]; then echo "\\\$(sed 's, release .*$,,g' /etc/system-release)"; elif [ ! -z "\$(command -v lsb_release)" ]; then echo "\\\$(lsb_release -is 2> /dev/null || echo "${distro}")"; else echo "${distro}"; fi)"
GRUB_CMDLINE_LINUX="\${cmdline}"
GRUB_CMDLINE_LINUX_DEFAULT="\${cmdline_extra}"
GRUB_CMDLINE_XEN=""
GRUB_CMDLINE_XEN_DEFAULT="${xen_cmdline_extra}"
GRUB_TIMEOUT_STYLE=menu
GRUB_TIMEOUT=5
GRUB_THEME=${grub_theme}
GRUB_DISABLE_OS_PROBER=true
GRUB_ENABLE_BLSCFG=false
GRUBDEFAULTS
if [ "${live}" == "Yes" ]; then echo -e "GRUB_DISABLE_SUBMENU=true\nGRUB_DISABLE_RECOVERY=true" >> /etc/default/grub; fi
if [ -d "/etc/default/grub.d" ]; then for cfgfile in /etc/default/grub.d/*.cfg; do echo '' > \\\${cfgfile}; done; fi
for i in \\\$(find /etc/grub.d | grep debian_theme); do chmod 0644 \\\$i; done
for i in \\\$(find /etc/grub.d | grep fallback_counting); do chmod 0644 \\\$i; done
for i in \\\$(find /etc/grub.d | grep menu_auto_hide); do chmod 0644 \\\$i; done
for i in \\\$(find /etc/grub.d | grep menu_show_once); do chmod 0644 \\\$i; done
for i in \\\$(find /etc/grub.d | grep reset_boot_success); do chmod 0644 \\\$i; done
REINSTALLBOOTLOADER
if [ "${install_type}" == "image" ]; then
	cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
for i in \\\$(find /etc/grub.d | grep uefi-firmware); do chmod 0644 \\\$i; done
REINSTALLBOOTLOADER
fi
cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
rm -rf /boot/efi/EFI
REINSTALLBOOTLOADER
if [ -d /boot/grub2 ]; then
	cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
grub2-mkconfig -o /boot/grub2/grub.cfg
REINSTALLBOOTLOADER
	if [ "${distro}" == "OpenSUSE" ]; then
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
shim-install --no-nvram
REINSTALLBOOTLOADER
	elif [ "${distro}" == "Qubes" ]; then
cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
dnf --setopt=reposdir=/etc/yum.repos.d/ reinstall -y shim-* grub2-efi-* grub2-common
mkdir -p /boot/efi/EFI/BOOT
cp -r /boot/efi/EFI/qubes/* /boot/efi/EFI/BOOT/
mv /boot/efi/EFI/BOOT/grubx64.efi /boot/efi/EFI/BOOT/BOOTX64.EFI
REINSTALLBOOTLOADER
	else
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
dnf reinstall -y shim-* grub2-efi-* grub2-common
REINSTALLBOOTLOADER
	fi
	cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
find /boot/efi -name "*.rpmsave" -type f -delete
REINSTALLBOOTLOADER
	if [ "${distro}" == "AlmaLinux" ] || [ "${distro}" == "OpenSUSE" ] || [ "${distro}" == "RockyLinux" ]; then
		chmod 0755 /boot/linuxloops/reinstall-bootloader
		/boot/linuxloops/reinstall-bootloader
		if [ -z "\$(find /boot/efi/EFI/BOOT/BOOTX64.EFI 2> /dev/null)" ]; then echo "Warning: The bootloader is not installed in the removable path."; fi
		if [ -z "\$(find /boot/efi/EFI/"${bootloader_id}"/"${bootloader_name}" 2> /dev/null)" ]; then echo "The bootloader is not correctly installed"; exit 1; fi
		exit 0
	fi
else
	if [ ! -z \$(command -v debconf-set-selections) ]; then
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
echo "grub-efi-amd64 grub2/update_nvram boolean false" | debconf-set-selections
echo "grub-efi-amd64 grub-efi/install_devices multiselect /dev/disk/by-uuid/\$(blkid -s UUID -o value "${efi_partition}")" | debconf-set-selections
REINSTALLBOOTLOADER
		if [ "${distro}" != "Proxmox" ]; then
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
dpkg-divert --divert /usr/sbin/grub-install.real --rename /usr/sbin/grub-install
REINSTALLBOOTLOADER
		fi
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
cat >/usr/sbin/grub-install <<'GRUBINSTALL'
#!/bin/sh
grub-install.real "\\\$@" --bootloader-id="${bootloader_id}"
grub-install.real "\\\$@" --removable
find /boot/efi -type f -iname fbx64.efi -exec rm {} \;
find /boot/efi -type f -iname bootx64.csv -exec rm {} \;
GRUBINSTALL
chmod 0755 /usr/sbin/grub-install
grub-install --target=x86_64-efi --efi-directory=/boot/efi
REINSTALLBOOTLOADER
	elif [ "${distro}" == "Arch" ] || [ "${distro}" == "Artix" ] || [ "${distro}" == "BlendOS" ] || [ "${distro}" == "Manjaro" ] || [ "${distro}" == "SteamOS" ]; then
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
pacman -Syu --noconfirm git fakeroot
git clone https://aur.archlinux.org/shim-signed.git /tmp/shim-signed
chown -R 'nobody':'nobody' /tmp/shim-signed
su -s /bin/bash nobody -c "cd /tmp/shim-signed && makepkg -s"
yes | pacman -U /tmp/shim-signed/*.pkg.tar.*
mkdir -p /etc/pacman.d/hooks
cat >/etc/pacman.d/hooks/99-secureboot-grub.hook <<PACMANHOOK
[Trigger]
Operation = Install
Operation = Upgrade
Type = File
Target = usr/lib/grub/*

[Action]
Description = Installing GRUB with grub-install
Depends = grub
When = PostTransaction
Exec = /bin/sh -c secureboot-install
PACMANHOOK
cat >/usr/sbin/secureboot-install <<'SECUREBOOTINSTALL'
#!/bin/bash
set -e
grub-install --target=x86_64-efi --efi-directory=/boot/efi --no-nvram --sbat=/usr/share/grub/sbat.csv --modules="all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo" --bootloader-id="${bootloader_id}"
mkdir -p /boot/efi/EFI/BOOT
cp /boot/efi/EFI/"${bootloader_id}"/grubx64.efi /boot/efi/EFI/BOOT/grubx64.efi
cp /usr/share/shim-signed/shimx64.efi /boot/efi/EFI/BOOT/BOOTX64.EFI
cp /usr/share/shim-signed/shimx64.efi /boot/efi/EFI/"${bootloader_id}"/shimx64.efi
cp /usr/share/shim-signed/mmx64.efi /boot/efi/EFI/BOOT/mmx64.efi
cp /usr/share/shim-signed/mmx64.efi /boot/efi/EFI/"${bootloader_id}"/mmx64.efi
if [ ! -z "\\\$(command -v sbverify)" ] && [ ! -z "\\\$(command -v sbattach)" ] && [ ! -z "\\\$(command -v sbsign)" ]; then
	for grubefi in \\\$(find /boot/efi -iname "grubx64.efi"); do
		for sig in \\\$(sbverify --list \\\$grubefi | grep '^signature' | sed 's@signature @@g' | sort -r); do sbattach --signum \\\$sig --remove \\\$grubefi; done
		sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output \\\$grubefi \\\$grubefi
	done
fi
SECUREBOOTINSTALL
chmod 0755 /usr/sbin/secureboot-install
secureboot-install
REINSTALLBOOTLOADER
	elif [ "${distro}" == "Gentoo" ]; then
		cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
cat >/usr/share/grub/sbat.csv <<'GRUBSBAT'
sbat,1,SBAT Version,sbat,1,https://github.com/rhboot/shim/blob/main/SBAT.md
grub,1,Free Software Foundation,grub,2,https://www.gnu.org/software/grub/
GRUBSBAT
grub-install --target=x86_64-efi --efi-directory=/boot/efi --no-nvram --sbat=/usr/share/grub/sbat.csv --modules="all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo"
grub-install --target=x86_64-efi --efi-directory=/boot/efi --no-nvram --removable --sbat=/usr/share/grub/sbat.csv --modules="all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo"
if [ -f /usr/share/shim/BOOTX64.EFI ]; then
	mv /boot/efi/EFI/BOOT/BOOTX64.EFI /boot/efi/EFI/BOOT/grubx64.efi
	cp /usr/share/shim/BOOTX64.EFI /boot/efi/EFI/BOOT/BOOTX64.EFI
	cp /usr/share/shim/BOOTX64.EFI /boot/efi/EFI/"${bootloader_id}"/shimx64.efi
	cp /usr/share/shim/mmx64.efi /boot/efi/EFI/BOOT/mmx64.efi
	cp /usr/share/shim/mmx64.efi /boot/efi/EFI/"${bootloader_id}"/mmx64.efi
fi
REINSTALLBOOTLOADER
	else
cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
grub-install --target=x86_64-efi --efi-directory=/boot/efi --no-nvram --modules="all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo"
grub-install --target=x86_64-efi --efi-directory=/boot/efi --no-nvram --removable --modules="all_video boot btrfs cat chain configfile echo efifwsetup efinet ext2 fat font gettext gfxmenu gfxterm gfxterm_background gzio halt help hfsplus iso9660 jpeg keystatus linux loadenv loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd normal ntfs part_apple part_msdos part_gpt password_pbkdf2 png probe reboot regexp search search_fs_uuid search_fs_file search_label sleep smbios squash4 terminal test true video xfs zfs zfscrypt zfsinfo"
REINSTALLBOOTLOADER
	fi
cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
mkdir -p /boot/grub
grub-mkconfig -o /boot/grub/grub.cfg
REINSTALLBOOTLOADER
fi
cat >>/boot/linuxloops/reinstall-bootloader <<REINSTALLBOOTLOADER
if [ ! -z "\\\$(command -v sbverify)" ] && [ ! -z "\\\$(command -v sbsign)" ] && [ -f /etc/secureboot_key/MOK.key ] && [ -f /etc/secureboot_key/MOK.crt ]; then
	for grubefi in \\\$(find /boot/efi -iname "grubx64.efi"); do
			for sig in \\\$(sbverify --list "\\\$grubefi" | grep '^signature' | sed 's@signature @@g' | sort -r); do sbattach --signum "\\\$sig" --remove "\\\$grubefi"; done
			sbsign --key /etc/secureboot_key/MOK.key --cert /etc/secureboot_key/MOK.crt --output "\\\$grubefi" "\\\$grubefi"
	done
fi
REINSTALLBOOTLOADER
chmod 0755 /boot/linuxloops/reinstall-bootloader
/boot/linuxloops/reinstall-bootloader
if [ -z "\$(find /boot/efi/EFI/BOOT/BOOTX64.EFI 2> /dev/null)" ]; then echo "Warning: The bootloader is not installed in the removable path."; fi
if [ -z "\$(find /boot/efi/EFI/"${bootloader_id}"/"${bootloader_name}" 2> /dev/null)" ]; then echo "The bootloader is not correctly installed"; exit 1; fi
INSTALLEFI
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_bootloader
}

generate_install_live()
{
if [ ! "${live}" == "Yes" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_live <<INSTALLLIVE
#!/bin/bash
set -e
echo "live ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
cat >/usr/bin/linuxloops <<'LIVELAUNCHER'
#!/bin/bash
set -e
sudo curl -L https://raw.githubusercontent.com/sebanc/linuxloops/main/linuxloops -o /usr/bin/linuxloops.real || zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Please make sure you have internet connectivity before running this program.\n" 2>/dev/null
sudo chmod 0755 /usr/bin/linuxloops.real
sudo bash /usr/bin/linuxloops.real "\${@}"
LIVELAUNCHER
chmod 0755 /usr/bin/linuxloops
mkdir -p /etc/skel/Desktop
cat >/etc/skel/Desktop/linuxloops.desktop <<'LIVEDESKTOPICON'
[Desktop Entry]
Name=Linuxloops installer
Exec=linuxloops
Icon=system-software-install
Terminal=true
Type=Application
StartupNotify=false
LIVEDESKTOPICON
chmod 0755 /etc/skel/Desktop/linuxloops.desktop
mkdir -p /etc/skel/.local/share/applications
cat >/etc/skel/.local/share/applications/linuxloops.desktop <<'LIVEMENUICON'
[Desktop Entry]
Name=Linuxloops installer
Exec=linuxloops
Icon=system-software-install
Terminal=true
Type=Application
Categories=System;Filesystem;
LIVEMENUICON
mkdir -p /usr/share/glib-2.0/schemas
cat >/usr/share/glib-2.0/schemas/zz_noscreenlock.gschema.override <<'DCONF'
[org.cinnamon.desktop.screensaver]
lock-delay=0
lock-enabled=false
DCONF
if [ ! -z "\$(command -v glib-compile-schemas)" ]; then glib-compile-schemas /usr/share/glib-2.0/schemas/; fi
mkdir -p /etc/repart.d
echo -e '[Partition]\nType=linux-generic' > /etc/repart.d/50-root.conf
cat >/etc/systemd/system/live-configuration.service <<'LIVE_CONFIGURATION_SERVICE'
[Unit]
Description=Apply linuxloops live configuration
DefaultDependencies=no
After=systemd-remount-fs.service
Before=systemd-modules-load.service

[Service]
Type=oneshot
ExecStart=/bin/bash -c "/usr/bin/live-configuration"

[Install]
WantedBy=local-fs-pre.target
LIVE_CONFIGURATION_SERVICE
systemctl enable live-configuration.service
mkdir -p /boot/linuxloops
cat >/usr/bin/live-configuration <<'LIVE_CONFIGURATION_SCRIPT'
#!/bin/bash
variant=""
if grep -qi 'variant_wifi' /proc/cmdline; then variant="wifi"; fi
if grep -qi 'variant_nvidia' /proc/cmdline; then variant="nvidia"; fi

for i in \$(ls /etc/modprobe.d/{broadcom,nvidia}*.conf) \$(ls /etc/modules-load.d/{broadcom,nvidia}*.conf); do
	conf=\${i%.*}
	rm -f \${conf}.disabled
	mv \${conf}.conf \${conf}.disabled
done

if [ "\${variant}" == "wifi" ]; then
	for i in \$(ls /etc/modprobe.d/broadcom*.disabled) \$(ls /etc/modules-load.d/broadcom*.disabled); do
		conf=\${i%.*}
		mv \${conf}.disabled \${conf}.conf
	done
	echo -e "blacklist nvidia" > /etc/modprobe.d/live-configuration.conf
elif [ "\${variant}" == "nvidia" ]; then
	for i in \$(ls /etc/modprobe.d/nvidia*.disabled) \$(ls /etc/modules-load.d/nvidia*.disabled); do
		conf=\${i%.*}
		mv \${conf}.disabled \${conf}.conf
	done
	echo -e "blacklist wl" > /etc/modprobe.d/live-configuration.conf
else
	echo -e "blacklist nvidia\nblacklist wl" > /etc/modprobe.d/live-configuration.conf
fi
LIVE_CONFIGURATION_SCRIPT
chmod 0755 /usr/bin/live-configuration
sed 's@"\\\${OS}"@"\${OS} (with additional wifi drivers)"@g' /etc/grub.d/10_linux > /etc/grub.d/10_linux_wifi
sed -i 's@\\\${GRUB_CMDLINE_LINUX}@\${GRUB_CMDLINE_LINUX} variant_wifi@g' /etc/grub.d/10_linux_wifi
chmod 0755 /etc/grub.d/10_linux_wifi
sed 's@"\\\${OS}"@"\${OS} (with nvidia proprietary gpu drivers)"@g' /etc/grub.d/10_linux > /etc/grub.d/10_linux_nvidia
sed -i 's@\\\${GRUB_CMDLINE_LINUX}@\${GRUB_CMDLINE_LINUX} module_blacklist=nouveau nvidia-drm.modeset=1 ibt=off variant_nvidia@g' /etc/grub.d/10_linux_nvidia
chmod 0755 /etc/grub.d/10_linux_nvidia
mkdir -p /etc/systemd/system-shutdown
cat >/etc/systemd/system-shutdown/nvidia.shutdown <<'NVIDIA_SHUTDOWNFIX'
#!/bin/sh
for MODULE in nvidia_drm nvidia_modeset nvidia_uvm nvidia; do
	if lsmod | grep "\$MODULE" &> /dev/null; then rmmod \$MODULE; fi
done
NVIDIA_SHUTDOWNFIX
chmod 0755 /etc/systemd/system-shutdown/nvidia.shutdown
yes | DEBIAN_FRONTEND=noninteractive apt install nvidia-driver broadcom-sta-dkms firmware-b43-installer breeze-gtk-theme- breeze-icon-theme- oxygen-icon-theme-
rm -rf /lib/firmware/bnx2x /lib/firmware/dpaa2 /lib/firmware/liquidio /lib/firmware/mellanox /lib/firmware/mrvl/prestera /lib/firmware/netronome /lib/firmware/qcom /lib/firmware/qed /lib/firmware/ti-connectivity
INSTALLLIVE
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_live
}

generate_cleanup()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/cleanup <<CLEANUP
#!/bin/bash
set -e
if [ ! -z "\$(command -v apt)" ]; then
	rm -f /etc/apt/apt.conf.d/99linuxloops
	yes | DEBIAN_FRONTEND=noninteractive apt autoremove
	apt clean
elif [ ! -z "\$(command -v dnf)" ]; then
	if [ "${distro}" == "Qubes" ]; then
		dnf --setopt=reposdir=/etc/yum.repos.d/ autoremove -y
		dnf --setopt=reposdir=/etc/yum.repos.d/ clean all
	else
		dnf autoremove -y
		dnf clean all
	fi
elif [ ! -z "\$(command -v emerge)" ]; then
	emerge --depclean
	eclean distfiles
	eclean packages
elif [ ! -z "\$(command -v zypper)" ]; then
	sed -i 's@solver.onlyRequires = true@# solver.onlyRequires = false@g' /etc/zypp/zypp.conf
	zypper clean
fi
rm -f /usr/share/xsessions/lightdm-xsession.desktop /usr/share/xsessions/Xsession.desktop
CLEANUP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/cleanup
}

generate_selinux_fix()
{
if [ "${distro}" != "AlmaLinux" ] && [ "${distro}" != "Fedora" ] && [ "${distro}" != "RockyLinux" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/selinux_fix <<SELINUXFIX
#!/bin/bash
set -e
echo "Please wait while selinux permissions are being applied..."
touch /.autorelabel
if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then
	mkdir -p /var/swap
	truncate -s 0 /var/swap/swapfile
	setfiles -c /etc/selinux/targeted/policy/policy.* /etc/selinux/targeted/contexts/files/file_contexts /
	chcon -h system_u:object_r:swapfile_t:s0 /var/swap/swapfile
else
	setfiles -c /etc/selinux/targeted/policy/policy.* /etc/selinux/targeted/contexts/files/file_contexts /
fi
SELINUXFIX
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/selinux_fix
}

generate_create_swap()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/create_swap <<CREATESWAP
#!/bin/bash
set -e
echo "Please wait while the swap file is being generated..."
mkdir -p /mnt/var/swap
truncate -s 0 /mnt/var/swap/swapfile
if [ "${fstype}" == "btrfs" ]; then chattr +C /mnt/var/swap/swapfile; fi
fallocate -l "${swap_size}"G /mnt/var/swap/swapfile
chmod 0600 /mnt/var/swap/swapfile
mkswap /mnt/var/swap/swapfile
CREATESWAP
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/create_swap
}

generate_efi_entry()
{
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/efi_entry <<EFIENTRY
#!/bin/bash
set -e
if ! mountpoint -q /sys/firmware/efi/efivars; then exit 0; fi
if [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then
	if [ "${install_type}" == "disk" ] && [ -f /sys/block/\$(echo "${destination}" | sed 's@/dev/@@g')/removable ] && [ "\$(cat /sys/block/\$(echo "${destination}" | sed 's@/dev/@@g')/removable)" -eq 0 ] && [ ! -z \$(command -v efibootmgr) ]; then
		echo "Creating EFI boot manager entry..."
		if [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ]; then
			efibootmgr -c -d "${destination}" -p 12 -L "${distro}" -l "\efi\\${bootloader_id}\\${bootloader_name}"
		else
			efibootmgr -c -d "${destination}" -p 1 -L "${distro}" -l "\efi\\${bootloader_id}\\${bootloader_name}"
		fi
	fi
else
	if [ "${install_type}" == "disk" ] && [ -f /sys/block/\$(echo "${destination}" | sed 's@/dev/@@g')/removable ] && [ "\$(cat /sys/block/\$(echo "${destination}" | sed 's@/dev/@@g')/removable)" -eq 0 ] && [ ! -z \$(command -v efibootmgr) ]; then
		echo "Creating EFI boot manager entry..."
		efibootmgr -c -d "${destination}" -p 1 -L "${distro}" -l "\efi\\${bootloader_id}\\${bootloader_name}"
	fi
fi
EFIENTRY
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/efi_entry
}

generare_install_userpw()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_userpw <<INSTALLUSERPW
#!/bin/bash
set -e
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:/usr/lib64:/usr/lib/x86_64-linux-gnu:/usr/lib:/lib64:/lib/x86_64-linux-gnu:/lib
cat >/mnt/tmp/set_userpw <<'SETUSERPW'
#!/bin/bash
set -e
echo -e '${userpass}\n${userpass}' | passwd '${username}'
if [ "${distro}" == "Proxmox" ]; then echo -e '${userpass}\n${userpass}' | passwd root; fi
SETUSERPW
chmod 0755 /mnt/tmp/set_userpw
if [ "${distro}" == "BlendOS" ]; then
	cat >>/mnt/tmp/set_userpw <<BLENDOS_AKSHARA
akshara update
cp /.update_rootfs/etc/mkinitcpio.conf.d/* /etc/mkinitcpio.conf.d/
cp /.update_rootfs/etc/mkinitcpio.d/* /etc/mkinitcpio.d/
rm -rf /lib/modules
cp -r /.update_rootfs/lib/modules /lib/
mkinitcpio -P
BLENDOS_AKSHARA
fi
if [ "${distro}" == "NixOS" ]; then
	sed -i '1d' /mnt/tmp/set_userpw
	sudo -u temp bash << 'NIXOSSETPW'
. /home/temp/.nix-profile/etc/profile.d/nix.sh
sudo nixos-enter << 'NIXOSCHROOT'
set -e
/tmp/set_userpw
NIXOSCHROOT
NIXOSSETPW
else
	chroot /mnt /tmp/set_userpw
fi
rm /mnt/tmp/set_userpw
INSTALLUSERPW
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_userpw
}

generate_exit_chroot()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
cat >"${linuxloopsdir}"/chroot/bootstrap/linuxloops/exit_chroot <<EXITCHROOT
#!/bin/bash
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib/x86_64-linux-gnu:/usr/local/lib:/usr/lib64:/usr/lib/x86_64-linux-gnu:/usr/lib:/lib64:/lib/x86_64-linux-gnu:/lib
for ROOT in \$(find /proc/*/root 2>/dev/null); do
	LINK="\$(readlink -f \${ROOT})"
	if echo "\${LINK}" | grep -q /mnt; then
		PID=\$(basename \$(dirname "\${ROOT}"))
		kill -9 \${PID}
	fi
done
sleep 5
if mountpoint -q /mnt/linuxloops; then umount /mnt/linuxloops; fi
rm -rf /mnt/linuxloops
if mountpoint -q /mnt/tmp; then umount /mnt/tmp; fi
if mountpoint -q /mnt/run; then umount /mnt/run; fi
if mountpoint -q /mnt/dev/shm; then umount /mnt/dev/shm; fi
if mountpoint -q /mnt/dev/pts; then umount /mnt/dev/pts; fi
if mountpoint -q /mnt/dev; then umount /mnt/dev; fi
if mountpoint -q /mnt/sys; then umount /mnt/sys; fi
if mountpoint -q /mnt/proc; then umount /mnt/proc; fi
if mountpoint -q /mnt/var/swap; then umount /mnt/var/swap; fi
if mountpoint -q /mnt/home; then umount /mnt/home; fi
if mountpoint -q /mnt/boot/efi; then umount /mnt/boot/efi; fi
if [ -f /linuxloops/efi_loop ]; then losetup -d \$(cat /linuxloops/efi_loop); fi
if mountpoint -q /mnt/boot; then umount /mnt/boot; fi
if [ -f /linuxloops/boot_loop ]; then losetup -d \$(cat /linuxloops/boot_loop); fi
if mountpoint -q /mnt; then umount /mnt; fi
if [ -b /dev/mapper/luks-"\$(blkid -s UUID -o value "${root_partition}")" ]; then cryptsetup luksClose luks-"\$(blkid -s UUID -o value "${root_partition}")"; fi
EXITCHROOT
chmod 0755 "${linuxloopsdir}"/chroot/bootstrap/linuxloops/exit_chroot
}

end_bootstrap()
{
for ROOT in $(find /proc/*/root 2>/dev/null); do
	LINK="$(readlink -f ${ROOT})"
	if echo "${LINK}" | grep -q "${linuxloopsdir}"/chroot; then
		PID=$(basename $(dirname "${ROOT}"))
		kill -9 ${PID}
	fi
done
sleep 5
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/data; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/data; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/efi; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/efi; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/iso; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/iso; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/roota; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/roota; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/rootc; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/rootc; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount/tmp; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount/tmp; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/isomount; then umount "${linuxloopsdir}"/chroot/bootstrap/isomount; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/linuxloops; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/linuxloops; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/tmp; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/tmp; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/run; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/run; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/dev/shm; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/dev/shm; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/dev/pts; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/dev/pts; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/dev; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/dev; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/sys; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/sys; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/proc; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/proc; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/var/swap; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/var/swap; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/home; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/home; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/boot/efi; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/boot/efi; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt/boot; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt/boot; fi
#umount "${linuxloopsdir}"/chroot/bootstrap/mnt twice (bind mount + real mount)
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/mnt; then umount "${linuxloopsdir}"/chroot/bootstrap/mnt; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/tmp; then umount "${linuxloopsdir}"/chroot/bootstrap/tmp; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/run; then umount "${linuxloopsdir}"/chroot/bootstrap/run; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/dev/shm; then umount "${linuxloopsdir}"/chroot/bootstrap/dev/shm; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/dev/pts; then umount "${linuxloopsdir}"/chroot/bootstrap/dev/pts; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/dev; then umount "${linuxloopsdir}"/chroot/bootstrap/dev; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/sys/firmware/efi/efivars; then umount "${linuxloopsdir}"/chroot/bootstrap/sys/firmware/efi/efivars; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/sys; then umount "${linuxloopsdir}"/chroot/bootstrap/sys; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap/proc; then umount "${linuxloopsdir}"/chroot/bootstrap/proc; fi
if mountpoint -q "${linuxloopsdir}"/chroot/bootstrap; then umount "${linuxloopsdir}"/chroot/bootstrap; fi
if mountpoint -q "${linuxloopsdir}"/chroot; then umount "${linuxloopsdir}"/chroot; fi
rm -rf "${linuxloopsdir}"/chroot
}

exit_with_error()
{
if [ ! -z "${zenity}" ]; then
	zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text "${1}\nInstallation failed." 2>/dev/null
else
	echo -e "${1}\nInstallation failed."
fi
exit 1
}

download_bootstrap()
{
if [ "${1}" == "iso" ]; then
	echo "Downloading ${distro} iso image from ${2}"
	curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f "${2}" -o "${linuxloopsdir}"/"${distro}".iso || { losetup -d "${destination_device}"; exit_with_error "Download of iso image from ${2} failed."; }
	if [ ! -z "${4}" ]; then
		mkdir -p "${linuxloopsdir}"/iso/rootfs "${linuxloopsdir}"/iso/level1 "${linuxloopsdir}"/iso/level2
		mount "${linuxloopsdir}"/"${distro}".iso "${linuxloopsdir}"/iso/level2
		mount "${linuxloopsdir}"/iso/level2"${3}" "${linuxloopsdir}"/iso/level1
		mount "${linuxloopsdir}"/iso/level1"${4}" "${linuxloopsdir}"/iso/rootfs
		cp -aT "${linuxloopsdir}"/iso/rootfs "${linuxloopsdir}"/chroot/bootstrap
		if [ "${distro}" == "Qubes" ]; then
			mkdir -p "${linuxloopsdir}"/chroot/bootstrap/source
			cp -a "${linuxloopsdir}"/iso/level2/Packages "${linuxloopsdir}"/chroot/bootstrap/source/
			cp -a "${linuxloopsdir}"/iso/level2/repodata "${linuxloopsdir}"/chroot/bootstrap/source/
		fi
		umount "${linuxloopsdir}"/iso/rootfs
		umount "${linuxloopsdir}"/iso/level1
		umount "${linuxloopsdir}"/iso/level2
	elif  [ ! -z "${3}" ]; then
		mkdir -p "${linuxloopsdir}"/iso/rootfs "${linuxloopsdir}"/iso/level1
		mount "${linuxloopsdir}"/"${distro}".iso "${linuxloopsdir}"/iso/level1
		mount "${linuxloopsdir}"/iso/level1"${3}" "${linuxloopsdir}"/iso/rootfs
		cp -aT "${linuxloopsdir}"/iso/rootfs "${linuxloopsdir}"/chroot/bootstrap
		umount "${linuxloopsdir}"/iso/rootfs
		umount "${linuxloopsdir}"/iso/level1
	else
		mkdir -p "${linuxloopsdir}"/iso/rootfs
		mount "${linuxloopsdir}"/"${distro}".iso "${linuxloopsdir}"/iso/rootfs
		cp -aT "${linuxloopsdir}"/iso/rootfs "${linuxloopsdir}"/chroot/bootstrap
		umount "${linuxloopsdir}"/iso/rootfs	
	fi
	rm "${linuxloopsdir}"/"${distro}".iso
	return 0
elif [ "${1}" == "lxc" ]; then
	if [ ! -f "${linuxloopsdir}"/"${2}"-rootfs.tar.xz ] || [ -z $(curl -LIs https://jenkins.linuxcontainers.org/job/image-"${2}"/lastStableBuild/architecture=amd64,release="${3}",variant="${4}"/artifact/rootfs.tar.xz | grep -Po '^content-length: \d+' | cut -d' ' -f2 | tail -1) ] || ([ ! -z $(curl -LIs https://jenkins.linuxcontainers.org/job/image-"${2}"/lastStableBuild/architecture=amd64,release="${3}",variant="${4}"/artifact/rootfs.tar.xz | grep -Po '^content-length: \d+' | cut -d' ' -f2 | tail -1) ] && [ $(curl -LIs https://jenkins.linuxcontainers.org/job/image-"${2}"/lastStableBuild/architecture=amd64,release="${3}",variant="${4}"/artifact/rootfs.tar.xz | grep -Po '^content-length: \d+' | cut -d' ' -f2 | tail -1) -ne $(du -b "${linuxloopsdir}"/"${2}"-rootfs.tar.xz | cut -d'	' -f1) ]); then
		echo "Downloading ${2} lxc image from https://jenkins.linuxcontainers.org/job/image-${2}/lastStableBuild/architecture=amd64,release=${3},variant=${4}/artifact/rootfs.tar.xz"
		rm -f "${linuxloopsdir}"/"${2}"-rootfs.tar.xz
		curl --progress-bar --connect-timeout 60 --retry 10 --retry-delay 1 -L -C - -f https://jenkins.linuxcontainers.org/job/image-"${2}"/lastStableBuild/architecture=amd64,release="${3}",variant="${4}"/artifact/rootfs.tar.xz -o "${linuxloopsdir}"/"${2}"-rootfs.tar.xz || { losetup -d "${destination_device}"; exit_with_error "Download of ${2} lxc image from https://jenkins.linuxcontainers.org/job/image-${2}/lastStableBuild/architecture=amd64,release=${3},variant=${4}/artifact/rootfs.tar.xz failed."; }
	fi
	if tar xf "${linuxloopsdir}"/"${2}"-rootfs.tar.xz -C "${linuxloopsdir}"/chroot/bootstrap; then return 0; fi
	rm -f "${linuxloopsdir}"/"${2}"-rootfs.tar.xz
fi
losetup -d "${destination_device}"
exit_with_error "Download of bootstrap image failed."
}

init_bootstrap()
{
return_value=0
download_bootstrap $bootstrap
mount --bind "${linuxloopsdir}"/chroot "${linuxloopsdir}"/chroot
mount --make-slave "${linuxloopsdir}"/chroot
mount --bind "${linuxloopsdir}"/chroot/bootstrap "${linuxloopsdir}"/chroot/bootstrap
mount --make-slave "${linuxloopsdir}"/chroot/bootstrap
mount --bind "${linuxloopsdir}"/chroot "${linuxloopsdir}"/chroot/bootstrap/mnt
mount -t proc none "${linuxloopsdir}"/chroot/bootstrap/proc
mount -t sysfs none "${linuxloopsdir}"/chroot/bootstrap/sys
if mountpoint -q /sys/firmware/efi/efivars; then mount --bind /sys/firmware/efi/efivars "${linuxloopsdir}"/chroot/bootstrap/sys/firmware/efi/efivars; fi
mount -t devtmpfs none "${linuxloopsdir}"/chroot/bootstrap/dev
mount -t devpts none "${linuxloopsdir}"/chroot/bootstrap/dev/pts
mount -t tmpfs -o mode=1777 none "${linuxloopsdir}"/chroot/bootstrap/dev/shm
mount -t tmpfs none "${linuxloopsdir}"/chroot/bootstrap/run
mount -t tmpfs -o mode=1777 none "${linuxloopsdir}"/chroot/bootstrap/tmp
cp /etc/hostname "${linuxloopsdir}"/chroot/bootstrap/etc/hostname
cp /etc/hosts "${linuxloopsdir}"/chroot/bootstrap/etc/hosts
rm -f "${linuxloopsdir}"/chroot/bootstrap/etc/resolv.conf
cp /etc/resolv.conf "${linuxloopsdir}"/chroot/bootstrap/etc/resolv.conf
chroot_$(echo "${distro}" | sed 's@[ !]@@g') || (return_value=1 && return)
generate_bootstrap_init
generate_partition_script
generate_setup_and_mount_rootfs
generate_mount_efi
generare_enter_chroot
generate_install_settings
generate_install_secureboot
generate_install_surface
generate_install_nvidia
generate_install_fstab
generate_install_initramfs
generate_install_bootloader
generate_cleanup
generate_selinux_fix
generate_install_live
generate_create_swap
generate_efi_entry
generate_exit_chroot
chroot "${linuxloopsdir}"/chroot/bootstrap /linuxloops/bootstrap_init || return_value=1
if [ "${return_value}" -eq 0 ]; then
	generare_install_userpw
	if [ -x "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_userpw ]; then
		chroot "${linuxloopsdir}"/chroot/bootstrap /linuxloops/install_userpw || return_value=1
		rm -f "${linuxloopsdir}"/chroot/bootstrap/linuxloops/install_userpw "${linuxloopsdir}"/chroot/bootstrap/mnt/tmp/set_userpw
	fi
	if [ "${install_type}" == "image" ] && [ -f "${linuxloopsdir}"/chroot/bootstrap/mnt/etc/secureboot_key/MOK.der ]; then
		cp "${linuxloopsdir}"/chroot/bootstrap/mnt/etc/secureboot_key/MOK.der "${fullpath}".der
		chown ${SUDO_UID}:${SUDO_UID} "${fullpath}".der
	fi
fi
if [ -x "${linuxloopsdir}"/chroot/bootstrap/linuxloops/exit_chroot ]; then chroot "${linuxloopsdir}"/chroot/bootstrap /linuxloops/exit_chroot || return_value=1; fi
end_bootstrap
}

start_install()
{
if mountpoint -q "${linuxloopsdir}"/chroot; then echo "Linuxloops chroot directory is already mounted, please reboot your computer before trying again..."; exit 1; fi
rm -rf "${linuxloopsdir}"/chroot
mkdir -p "${linuxloopsdir}"/chroot/bootstrap/linuxloops
if [ "${install_type}" == "disk" ]; then
	for i in ls "${fullpath}"?*; do
		umount ${i} > /dev/null 2>&1
		ret="${?}"
		if [ ! "${ret}" -eq 0 ] && [ ! "${ret}" -eq 32 ]; then exit_with_error "Automatic unmounting of partitions failed with error ${ret}. Please unmount all device partitions manually and try again."; fi
	done
	destination_device="${fullpath}"
	if (expr match "${fullpath}" ".*[0-9]$" >/dev/null); then
		partition_path="${destination_device}"p
	else
		partition_path="${destination_device}"
	fi
	
else
	echo "Creating image file ${fullpath}..."
	rm -f "${fullpath}" "${fullpath}".der "${fullpath}".grub.txt
	echo -n > "${fullpath}"
	if [ "x$(df -T "${fullpath}" | tail -1 | cut -d' ' -f2)" == "xbtrfs" ]; then chattr +C "${fullpath}"; chattr -c "${fullpath}"; fi
	if [ "${live}" == "Yes" ]; then
		dd if=/dev/zero of="${fullpath}" bs=1M count=${install_sizeMB} status=progress
	else
		dd if=/dev/zero of="${fullpath}" bs=1M count=0 seek=${install_sizeMB} status=none
	fi
	chown ${SUDO_UID}:${SUDO_UID} "${fullpath}"
	destination_device="$(losetup --show -fP "${fullpath}")" || exit_with_error "losetup command failed."
	partition_path="${destination_device}"p
fi
efi_partition="${partition_path}"1
if [ "${distro}" == "BlissOS" ]; then
	root_partition="${partition_path}"2
else
	boot_partition="${partition_path}"2
	root_partition="${partition_path}"3
fi
init_bootstrap
if [ "${install_type}" == "image" ]; then losetup -d "${destination_device}"; fi
return "${return_value}"
}

grub_config()
{
if [ ! -z "${wsl}" ]; then
	img_uuid=$(sudo -u ${SUDO_USER} /mnt/c/Windows/System32/mountvol.exe $(echo ${fullpath:5:1} | tr a-z A-Z): /L | cut -d'{' -f2 | cut -d'}' -f1)
else
	img_uuid=$(blkid -s PARTUUID -o value "$(df "${fullpath}" --output=source | sed 1d)")
fi
img_path=$(if [ $(findmnt -n -o TARGET -T ${fullpath}) == "/" ]; then echo "$(realpath ${fullpath})"; else echo "$(realpath ${fullpath})" | sed "s#$(findmnt -n -o TARGET -T ${fullpath})##g"; fi)
if [ "$(df -T "${fullpath}" | tail -1 | cut -d' ' -f2)" == "btrfs" ] && [ ! -z $(command -v btrfs) ]; then img_subvol="$(btrfs subvolume show $(findmnt -n -o TARGET -T ${fullpath}) | grep Name: | sed 's@\t\| @@g' | cut -d':' -f2)"; fi
if [ ! -z "${img_subvol}" ]; then img_path="/${img_subvol}${img_path}"; fi
if [ -z "${wsl}" ] && ([ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "debian" ] || [ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "ubuntu" ] || [ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "linuxmint" ] || [ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "fedora" ] || [ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "zorin" ]); then remove_tpm="\n	rmmod tpm"; fi
if [ "${distro}" == "BlissOS" ]; then
config="menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \"\${img_path}\"
	loopback loop \"\${img_path}\"
	for bliss in (loop,2)/android-*; do set root=\$bliss; done
	linux \$root/kernel rdinit=/linuxloops img_uuid=\${img_uuid} img_path=\${img_path} root=/dev/ram0
	initrd \$root/initrd.img (loop,2)/linuxloops.img
}
"
elif [ "${distro}" == "Brunch" ]; then
config="submenu '${distro}' {
menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \${img_path}
	loopback loop \${img_path}
	source (loop,12)/efi/boot/settings.cfg
	if [ -z \${verbose} ] -o [ \${verbose} -eq 0 ]; then
		linux (loop,7)\${kernel} boot=local noresume noswap loglevel=7 options=\${options} chromeos_bootsplash=\${chromeos_bootsplash} \${cmdline_params} \\
			cros_secure cros_debug img_uuid=\${img_uuid} img_path=\${img_path} \\
			console= vt.global_cursor_default=0 brunch_bootsplash=\${brunch_bootsplash} quiet
	else
		linux (loop,7)\${kernel} boot=local noresume noswap loglevel=7 options=\${options} chromeos_bootsplash=\${chromeos_bootsplash} \${cmdline_params} \\
			cros_secure cros_debug img_uuid=\${img_uuid} img_path=\${img_path}
	fi
	initrd (loop,7)/lib/firmware/amd-ucode.img (loop,7)/lib/firmware/intel-ucode.img (loop,7)/initramfs.img
}
menuentry '${distro} settings' --class '$(echo ${distro} | tr [:upper:] [:lower:])-settings' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \${img_path}
	loopback loop \${img_path}
	source (loop,12)/efi/boot/settings.cfg
	linux (loop,7)/kernel boot=local noresume noswap loglevel=7 options= chromeos_bootsplash= edit_brunch_config=1 \\
		cros_secure cros_debug img_uuid=\${img_uuid} img_path=\${img_path}
	initrd (loop,7)/lib/firmware/amd-ucode.img (loop,7)/lib/firmware/intel-ucode.img (loop,7)/initramfs.img
}
}
"
elif [ "${distro}" == "ChromeOS-Flex" ]; then
config="menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \${img_path}
	loopback loop \${img_path}
	if [ -f (loop,7)/bootimage.cfg ]; then source (loop,7)/bootimage.cfg; fi
	if [ -z \"\${bootimage}\" ]; then bootimage=A; fi
	linux (loop,12)/syslinux/vmlinuz.\${bootimage} img_uuid=\${img_uuid} img_path=\${img_path} bootimage=\${bootimage} loop.max_part=16 ro quiet splash boot=local noresume noswap loglevel=7 console= cros_efi kvm-intel.vmentry_l1d_flush=always loadpin.enabled=0 loadpin.enforce=0 rootfstype=ramfs ${dev_mode}
	initrd (loop,7)/initramfs.img (loop,7)/firmwares.img (loop,7)/modules.img
}
"
elif [ "${distro}" == "NixOS" ]; then
config="menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \"\${img_path}\"
	loopback loop \"\${img_path}\"
	linuxloops_args=\"img_path=\${img_path} img_uuid=\${img_uuid}\"
	export linuxloops_args
	if [ -f (loop,2)/grub2/grub.cfg ]; then
		configfile (loop,2)/grub2/grub.cfg
	else
		configfile (loop,2)/grub/grub.cfg
	fi
}
"
elif [ "${distro}" == "Tails" ]; then
config="menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \"\${img_path}\"
	loopback loop \"\${img_path}\"
	probe --set rootuuid --fs-uuid (loop,1)
	linux (loop,1)/live/vmlinuz rdinit=/linuxloops img_uuid=\${img_uuid} img_path=\${img_path} boot=live config live-media=/dev/loop0p1 nopersistence noprompt timezone=Etc/UTC splash noautologin module=Tails slab_nomerge slub_debug=FZ mce=0 vsyscall=none init_on_free=1 mds=full,nosmt page_alloc.shuffle=1 randomize_kstack_offset=on FSUUID=\${rootuuid} quiet splash
	initrd (loop,1)/live/initrd.img (loop,1)/live/linuxloops.img
}
"
else
config="menuentry '${distro}' --class '$(echo ${distro} | tr [:upper:] [:lower:])' {${remove_tpm}
	img_path=\"${img_path}\"
	img_uuid=\"${img_uuid}\"
	search --no-floppy --set=root --file \"\${img_path}\"
	loopback loop \"\${img_path}\"
	linuxloops_args=\"rdinit=/linuxloops img_path=\${img_path} img_uuid=\${img_uuid}\"
	export linuxloops_args
	if [ -f (loop,2)/grub2/grub.cfg ]; then
		configfile (loop,2)/grub2/grub.cfg
	else
		configfile (loop,2)/grub/grub.cfg
	fi
}
"
fi
echo -e "${config}" > "${fullpath}".grub.txt
chown ${SUDO_UID}:${SUDO_UID} "${fullpath}".grub.txt
if [ -f ./usb_bootloader.img ]; then
	usbboot_loop=$(losetup --show -fP ./usb_bootloader.img)
	mount "${usbboot_loop}"p1 "${linuxloopsdir}"/chroot
	echo -e "set timeout=5\n"> "${linuxloopsdir}"/chroot/efi/boot/grub.cfg
	echo -e "${config}" >> "${linuxloopsdir}"/chroot/efi/boot/grub.cfg
	umount "${linuxloopsdir}"/chroot
	losetup -d ${usbboot_loop}
	finalise="The grub config to boot ${distro} has been installed in the usb_bootloader.img file. Write this file to a usb flashdrive with Rufus, dd or any other image writing tool and boot from it."
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${finalise}" --ok-label="Exit" 2>/dev/null
	else
		echo -e "${finalise}"
	fi
elif [ ! -z "${wsl}" ]; then
	grubinstall="The ${distro} dual boot disk image has been created and the config needed to boot ${distro} from Grub2Win has been generated in the file:\n$(echo ${fullpath:5:1} | tr a-z A-Z):\\\\$(echo ${fullpath:7} | sed 's@\/@\\\\@g').grub.txt\n\nNow, install Grub2Win and launch it, click on \"Manage Boot Menu\" -> \"Add a new entry\" -> set \"Type\" as \"Create user section\", open the file $(echo ${fullpath:5:1} | tr a-z A-Z):\\\\$(echo ${fullpath:7} | sed 's@\/@\\\\@g').grub.txt and copy its content in the Grub2Win notepad window, save and close the Grub2Win notepad window then click \"Apply\" and \"OK\"."
	finalise="Please note that ${distro} will not be bootable and / or stable if you do not perform the below actions (Refer to Windows online resources if needed):\n- Ensure that bitlocker is disabled on the drive which contains the ${distro} image or disable it.\n- Disable fast startup.\n- Disable hibernation.\n\nOnce done, reboot your computer and select ${distro} from the Grub2Win menu."
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${grubinstall}" --ok-label="Next" 2>/dev/null
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${finalise}" --ok-label="Exit" 2>/dev/null
	else
		echo -e "${grubinstall}"
		echo -e ""
		echo -e "${finalise}"
	fi
elif [ ! -z "${brunch}" ]; then
	grubinstall="The grub config needed to boot ${distro} has been generated in the file \"${fullpath}.grub.txt\".\n\n ****************************************************************************************** \n${config}\n ****************************************************************************************** \n\nNow copy the above grub config, run \"sudo edit-brunch-config -g\" and paste it (lines between stars) at the end of the file.\n\nOnce done, press CTRL+X and then ENTER to save, reboot your computer and start ${distro}"
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${grubinstall}" --ok-label="Exit" 2>/dev/null
	else
		echo -e "${grubinstall}"
	fi
elif [ ! -z "${chromeos}" ]; then
	source=$(blkid --match-token LABEL=EFI-SYSTEM | head -1 | cut -d':' -f1)
	mkdir -p /mnt/stateful_partition/unencrypted/linuxloops_config/tmp
	mount "${source}" /mnt/stateful_partition/unencrypted/linuxloops_config/tmp
	rm -r /mnt/stateful_partition/unencrypted/linuxloops_config/tmp/*
	curl -L https://github.com/sebanc/linuxloops/raw/main/bootloaders/chromebook_boot.tar.gz -o /home/chronos/user/Downloads/chromebook_boot.tar.gz
	tar zxf /home/chronos/user/Downloads/chromebook_boot.tar.gz -C /mnt/stateful_partition/unencrypted/linuxloops_config/tmp
	rm -f /home/chronos/user/Downloads/chromebook_boot.tar.gz
	echo -e "set timeout=5\n"> /mnt/stateful_partition/unencrypted/linuxloops_config/tmp/efi/boot/grub.cfg
	echo -e "${config}" >> /mnt/stateful_partition/unencrypted/linuxloops_config/tmp/efi/boot/grub.cfg
	umount /mnt/stateful_partition/unencrypted/linuxloops_config/tmp
	grubinstall="The grub config needed to boot ${distro} has been added to your boot partition 12, if not already done, refer to MrChromebox instructions to allow booting from legacy hdd boot (through RW_LEGACY firmware or ALT firmware), then reboot your computer and press CTRL+L to start ${distro}."
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${grubinstall}" --ok-label="Exit" 2>/dev/null
	else
		echo -e "${grubinstall}"
	fi
else
	if [ "$(grep -o '^ID=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "fedora" ]; then grub="grub2"; else grub="grub"; fi
	grubinstall="The grub config needed to boot ${distro} has been generated in the file \"${fullpath}.grub.txt\".\n\nIf you have a linux distro installed which uses grub as bootloader, open another terminal and run the below command to generate the grub config automatically:\nsudo cat /etc/grub.d/40_custom ${fullpath}.grub.txt | sudo tee /etc/grub.d/99_linuxloops_$(echo ${distro} | tr [:upper:] [:lower:]); sudo chmod 0755 /etc/grub.d/99_linuxloops_$(echo ${distro} | tr [:upper:] [:lower:]); sudo ${grub}-mkconfig -o $(if cat /etc/os-release | grep 'VARIANT_ID=' | grep -q 'silverblue\|kinoite'; then echo /etc/grub2.cfg; else echo /boot/${grub}/grub.cfg; fi)\n\nOtherwise, add this grub config (lines between stars) manually to another grub bootloader:\n\n ****************************************************************************************** \n${config}\n ****************************************************************************************** \n\nOnce the above actions are completed, you can reboot your computer and start ${distro}."
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="${grubinstall}" --ok-label="Exit" 2>/dev/null
	else
		echo -e "${grubinstall}"
	fi
fi
}

set_credentials()
{
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then return; fi
if [ "${declarative}" == "Yes" ] && [ ! -z "${username}" ] && [ ! -z "${userpass}" ]; then
	if echo "${username}" | grep -q '^[a-z][-a-z0-9]*\$'; then echo -e "Username contains unsupported characters.\n\n"; exit 1; fi
	if echo "${userpass}" | grep -q '[^a-zA-Z0-9!@#&$£%µ^+-\*/=~¨]'; then echo -e "Password contains unsupported characters.\n\n"; exit 1; fi
elif [ "${test_distro}" == "Yes" ]; then
	username="test"
	userpass="test"
elif [ "${live}" == "Yes" ]; then
	username="live"
	userpass="linuxloops"
else
	if [ "${encryption}" == "Yes" ]; then
		encrypted_text="You have requested encryption, please input your username and the encryption password.\nYour user account password will be set as the encryption password but you can change it later."
		password_text="encryption password"
	else
		encrypted_text="Please input your username and user account password."
		password_text="user account password"
	fi
	if [ ! -z "${zenity}" ]; then
		until false; do
			form=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --forms --text="${encrypted_text}" --add-entry="Input your username" --add-password="Input your ${password_text}" --add-password="Confirm your ${password_text}" --ok-label="Next" 2>/dev/null)
			username="$(echo ${form} | cut -d'|' -f1)"
			userpass="$(echo ${form} | cut -d'|' -f2)"
			verifuserpass="$(echo ${form} | cut -d'|' -f3)"
			if [ -z "${form}" ]; then exit 1; fi
			if [ -z "${username}" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Please define your username.\n" 2>/dev/null; continue; fi
			if [ -z "${userpass}" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Please define a password.\n" 2>/dev/null; continue; fi
			if echo "${username}" | grep -q '^[a-z][-a-z0-9]*\$'; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Username contains unsupported characters.\n" 2>/dev/null; continue; fi
			if echo "${userpass}" | grep -q '[^a-zA-Z0-9!@#&$£%µ^+-\*/=~¨]'; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Password contains unsupported characters.\n" 2>/dev/null; continue; fi
			if [ "${userpass}" != "${verifuserpass}" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Passwords do not match, try again.\n" 2>/dev/null; continue; fi
			break
		done
		if [ "$(echo ${desktop} | cut -d '/' -f1)" != "None" ]; then
			autologin=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to enable autologin ?" --column "Enable autologin" "No" "Yes" --ok-label="Next" 2>/dev/null)
			if [ -z "${autologin}" ]; then exit 1; fi
		fi
	else
		echo -e "${encrypted_text}"
		until false; do
			read -p "Please enter your username: " username
			if [ -z "${username}" ]; then echo -e "Please define your username.\n\n"; continue; fi
			if echo "${username}" | grep -q '^[a-z][-a-z0-9]*\$'; then echo -e "Username contains unsupported characters.\n\n"; continue; fi
			break
		done
		until false; do
			read -s -p "Input your ${password_text}: " userpass
			echo ""
			read -s -p "Verify your ${password_text}: " verifuserpass
			echo ""
			if [ -z "${userpass}" ]; then echo -e "Please define a password.\n\n"; continue; fi
			if echo "${userpass}" | grep -q '[^a-zA-Z0-9!@#&$£%µ^+-\*/=~¨]'; then echo -e "Password contains unsupported characters.\n\n"; continue; fi
			if [ "${userpass}" != "${verifuserpass}" ]; then echo -e "Passwords do not match, try again.\n\n"; continue; fi
			break
		done
	fi
fi
}

list_array()
{
if [ "${1}" == "available_distros" ]; then for distro in "${available_distros[@]}"; do echo -e "\"${distro}\""; done; fi
if [ "${1}" == "available_desktops" ]; then for desktop in "${available_desktops[@]}"; do echo -e "\"${desktop}\""; done ; fi
if [ "${1}" == "available_locales" ]; then for i in "${!available_locales[@]}"; do if [ "${available_locales[$i]}" == "TRUE" ] || [ "${available_locales[$i]}" == "FALSE" ]; then echo "${available_locales[$i+1]}"; fi; done; fi
if [ "${1}" == "available_keymaps" ]; then for i in "${!available_keymaps[@]}"; do if [ "${available_keymaps[$i]}" == "TRUE" ] || [ "${available_keymaps[$i]}" == "FALSE" ]; then echo "${available_keymaps[$i+1]}"; fi; done; fi
if [ "${1}" == "available_timezones" ]; then for i in "${!available_timezones[@]}"; do if [ "${available_timezones[$i]}" == "TRUE" ] || [ "${available_timezones[$i]}" == "FALSE" ]; then echo "${available_timezones[$i+1]}"; fi; done; fi
if [ "${1}" == "btrfs_supported" ]; then for distro in "${btrfs_supported[@]}"; do echo -e "\"${distro}\""; done; fi
if [ "${1}" == "nvidia_supported" ]; then for distro in "${nvidia_supported[@]}"; do echo -e "\"${distro}\""; done; fi
if [ "${1}" == "surface_supported" ]; then for distro in "${surface_supported[@]}"; do echo -e "\"${distro}\""; done; fi
if [ "${1}" == "all" ]; then
	for distro in "${available_distros[@]}"; do
		echo -en "\"${distro}\" distribution:\n\tAvailable desktops:"
		list_desktops "${distro}"
		for desktop in "${available_desktops[@]}"; do
			echo -en " \"${desktop}\""
		done
		echo -en "\n\tInstall on btrfs filesystem possible: "
		if [[ ! " ${btrfs_supported[*]} " =~ " ${distro} " ]]; then echo -en "No"; else echo -en "Yes"; fi
		echo -en "\n\tNvidia proprietary driver installation possible: "
		if [[ ! " ${nvidia_supported[*]} " =~ " ${distro} " ]]; then echo -en "No"; else echo -en "Yes"; fi
		echo -en "\n\tSurface patches installation possible: "
		if [[ ! " ${surface_supported[*]} " =~ " ${distro} " ]]; then echo -en "No"; else echo -en "Yes"; fi
		echo -e '\n'
	done
fi
}

check_home_space()
{
case "${distro}" in
	'BlissOS')
		available_space_needed=3
	;;
	'Brunch')
		available_space_needed=7
	;;
	'ChromeOS-Flex')
		available_space_needed=7
	;;
	'Qubes')
		available_space_needed=7
	;;
	'Tails')
		available_space_needed=4
	;;
	*)
		available_space_needed=1
	;;
esac
if [ $(( ($(df -k --output=avail ${HOME} | sed 1d) / 1024 / 1024) - ${available_space_needed} )) -lt 0 ]; then
	if [ ! -z "${zenity}" ]; then
		sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text "To install ${distro} you need ${available_space_needed} GB of available space in your home directory but you only have $(($(df -k --output=avail ${HOME} | sed 1d) / 1024 / 1024)) GB." 2>/dev/null
	else
		echo -e "To install ${distro} you need ${available_space_needed} GB of available space in your home directory but you only have $(($(df -k --output=avail ${HOME} | sed 1d) / 1024 / 1024)) GB."
	fi
	exit 1
fi
}

possible_image_size()
{
if [ -f "${destination}" ]; then freed_space=$(( $(du "${destination}" | cut -d'	' -f1) / 1024 / 1024 )); else freed_space=0; fi
if [ "$(df --output=source -- ${linuxloopsdir} | sed 1d)" == "$(df --output=source -- $(echo $(realpath ${destination}) | sed 's![^/]*$!!') | sed 1d)" ]; then bootstrap_space=${available_space_needed}; else bootstrap_space=0; fi
maximum_image_size=$(( ($(df -k --output=avail $(echo $(realpath ${destination}) | sed 's![^/]*$!!') | sed 1d) / 1024 / 1024) + ${freed_space} - ${bootstrap_space} ))
}

zenity_installer()
{
if ! sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="Welcome to the LinuxLoops installer." --ok-label="Next" 2>/dev/null; then exit 0; fi
distro=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Which distribution do you want to install ?" --column "Distribution" "${available_distros[@]}" --ok-label="Next" 2>/dev/null)
if [ -z "${distro}" ]; then exit 0; fi
check_home_space
list_desktops ${distro}
desktop=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Which desktop environment do you want to install ?" --column "Desktop environment" "${available_desktops[@]}" --ok-label="Next" 2>/dev/null)
if [ -z "${desktop}" ]; then exit 0; fi
if [ -z "${wsl}" ]; then install_type=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to install ${distro} on a disk or in an image file ?" --column "Choose install type" "disk" "image" --ok-label="Next" 2>/dev/null); else install_type="image"; fi
if [ "${install_type}" == "disk" ] && [ ! -d /sys/firmware/efi ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text "Disk installs are possible when booted in UEFI mode." 2>/dev/null; exit 1; fi
if [ -z "${install_type}" ]; then exit 1; fi
if [ "${install_type}" == "disk" ]; then
	local t
	local test
	local device
	local size
	t=0
	for i in $(lsblk -drnbpf -o NAME,SIZE); do
		if [ $((t % 2)) == 0 ]; then device=${i}; fi
		if [ $((t % 2)) == 1 ]; then
			size=$((i / 1024 /1024 / 1024))
			if [ ! -z "${device}" ] && [ ! -z "${size}" ] && [ $((size - 14)) -ge 0 ] && ! echo "${device}" | grep -q "/dev/loop" && ! echo ${device} | grep -q $(basename $(realpath "/sys/class/block/$(lsblk -oMOUNTPOINT,PKNAME -rn | grep '/ ' | cut -d' ' -f2)/..")); then
				if [ "${device}" != "/dev/$(lsblk --inverse $(realpath $(df ${0} | grep '^/' | cut -d' ' -f1)) -io NAME | cut -d'-' -f2 | tail -1)" ] && [ -z "$(grep -o 'img_uuid=[^ ,]\+' /proc/cmdline | cut -d'=' -f2)" ] || ([ ! -z "$(grep -o 'img_uuid=[^ ,]\+' /proc/cmdline | cut -d'=' -f2)" ] && [ "${device}" != "/dev/$(lsblk -ndo pkname $(blkid --match-token PARTUUID=$(grep -o 'img_uuid=[^ ,]\+' /proc/cmdline | cut -d'=' -f2) | cut -d':' -f1))" ]); then test="${test} radio ${device} ${size}"; fi
			fi
		fi
		t=$((t + 1))
	done
	destination=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --radiolist --text "Select the drive that you want to use for installation." --column "Select" --column "Device" --column "Size (in GB)" ${test} --ok-label="Next" 2>/dev/null)
	if [ -z "${destination}" ]; then exit 1; fi
	fullpath="${destination}"
	install_size=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --scale --text "This device has $(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 /1024 / 1024) )) GB available.\n How much would you like to allocate for ${distro} ?\n" --min-value=14 --max-value=$(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 /1024 / 1024) )) --value=$(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 /1024 / 1024) )) --step 1 --ok-label="Next" 2>/dev/null)
	if [ -z "${install_size}" ]; then exit 1; fi
	if [ "${install_size}" -eq $(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 /1024 / 1024) )) ]; then install_sizeMB=$(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 /1024) )); else install_sizeMB=$((install_size*1024)); fi
else
	until false; do
		local path
		if [ ! -z "${wsl}" ]; then
			path=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer - Select the path to store the ${distro} disk image" --file-selection --save --file-filter=*.img --filename="/mnt/c/Users/$(echo $(/mnt/c/Windows/System32/cmd.exe /c echo %username% 2> /dev/null) | sed 's/[^a-zA-Z0-9]//g')/${distro}.img" 2>/dev/null)
		elif [ ! -z "${chromeos}" ] || [ ! -z "${brunch}" ]; then
			path=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer - Select the path to store the ${distro} disk image" --file-selection --save --file-filter=*.img --filename="/mnt/stateful_partition/unencrypted/${distro}.img" 2>/dev/null)
		else
			path=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer - Select the path to store the ${distro} disk image" --file-selection --save --file-filter=*.img --filename="$(eval echo ~${SUDO_USER})/${distro}.img" 2>/dev/null)
		fi
		if [ -z "${path}" ]; then exit 1; else destination="${path}"; fi
		if [ "$(echo -n ${destination} | tail -c 4)" != ".img" ]; then destination="${destination}.img"; fi
		if [[ "${destination}" == *"/"* ]] && ([ -z "$(realpath ${destination} 2> /dev/null)" ] || [ ! -d "$(echo $(realpath ${destination}) | sed 's@[^/]*$@@')" ]); then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Desination path does not exist, please provide an existing path." 2>/dev/null; continue; fi
		if [ "$(lsblk $(df -h --output=source $(echo $(realpath ${destination}) | sed 's![^/]*$!!') | tail -1) -no TYPE)" == "crypt" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Linuxloops disk images cannot be booted from an encrypted partition." 2>/dev/null; continue; fi
		if [[ ! ${destination} == *"/"* ]]; then path="${PWD}/"; else path="$(realpath ${destination})"; path="$(echo ${path} | sed 's@[^/]*$@@')"; fi
		fullpath="${path}$(basename ${destination})"
		if [ ! -z "${wsl}" ] && [ ! -z "${path##/mnt/*/*}" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="The ${distro} disk image has to be installed outside of the WSL VM, please specify a path such as /mnt/\&lt;drive letter\&gt;/..." 2>/dev/null; continue; fi
		if ([ ! -z "${chromeos}" ] || [ ! -z "${brunch}" ]) && [ ! -z "${path##/mnt/stateful_partition/unencrypted/*}" ]; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="The ${distro} disk image has to be installed in the unencrypted data partition, please specify a path such as /mnt/stateful_partition/unencrypted/..." 2>/dev/null; continue; fi
		possible_image_size
		if [ $(( ${maximum_image_size} - 14 )) -lt 0 ]; then
			sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="Not enough space to create image file, the minimum size is 14 GB. Verify that the path you have selected points to a partition with more than 14 GB available." 2>/dev/null
			continue
		elif [ $(( ${maximum_image_size} - 14 )) -eq 0 ]; then
			sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="Exactly 14GB is available on this drive, the installer will proceed with the creation of a 14GB image." --ok-label="Next" 2>/dev/null
			install_size=14
		else
			install_size=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --scale --text "This partition has ${maximum_image_size} GB available.\n How much would you like to allocate for ${distro} ?\n" --min-value=14 --max-value=${maximum_image_size} --value=14 --step 1 2>/dev/null)
		fi
		break
	done
	if [ -z "${install_size}" ]; then exit 1; fi
	install_sizeMB=$((install_size*1024))
fi
if [ "${distro}" != "BlissOS" ] && [ "${distro}" != "Brunch" ] && [ "${distro}" != "ChromeOS-Flex" ] && [ "${distro}" != "Tails" ]; then
	locale=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --radiolist --text "Please select your locale (language / formats)." --column "Select" --column "Locale" --column "Description" "${available_locales[@]}" --ok-label="Next" 2>/dev/null)
	if [ -z "${locale}" ]; then exit 1; fi
	keymap=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --radiolist --text "Please select your keyboard layout." --column "Select" --column "Keymap" --column "Description" "${available_keymaps[@]}" --ok-label="Next" 2>/dev/null)
	if [ -z "${keymap}" ]; then exit 1; fi
	timezone=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --radiolist --text "Please select your timezone." --column "Select" --column "Timezone" "${available_timezones[@]}" --ok-label="Next" 2>/dev/null)
	if [ -z "${timezone}" ]; then exit 1; fi
	if [[ " ${btrfs_supported[*]} " =~ " ${distro} " ]]; then fstype=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Which filesystem format would you like for the rootfs partition ?" --column "Filesystem" "ext4" "btrfs" --ok-label="Next" 2>/dev/null); else fstype="ext4"; fi
	if [ -z "${fstype}" ]; then exit 1; fi
	encryption=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want the image to be encrypted ?\nThis is highly recommended if you intend to keep sensitive data." --column "Encryption" "Yes" "No" --ok-label="Next" 2>/dev/null)
	if [ -z "${encryption}" ]; then exit 1; fi
	swap_size=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --scale --text "Please select here the swap size (swap is not mandatory, if you do not know what swap is you can select 0).\n" --min-value=0 --max-value=$(( ${install_size} - 12 )) --value=0 --step 1 2>/dev/null)
	if [ -z "${swap_size}" ]; then exit 1; fi
	if [[ " ${nvidia_supported[*]} " =~ " ${distro} " ]]; then nvidia=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to automatically install the nvidia proprietary drivers ?" --column "Install nvidia driver" "No" "Yes" --ok-label="Next" 2>/dev/null); else nvidia="No"; fi
	if [ -z "${nvidia}" ]; then exit 1; fi
	if [[ " ${surface_supported[*]} " =~ " ${distro} " ]]; then surface=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to automatically install the surface device patches from https://github.com/linux-surface ?\n(enable this only if you have a Microsoft Surface device)" --column "Apply Surface patches" "No" "Yes" --ok-label="Next" 2>/dev/null); else surface="No"; fi
	if [ -z "${surface}" ]; then exit 1; fi
	customize=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to customize the install ?" --column "Customize install" "No" "Yes" --ok-label="Next" 2>/dev/null)
	if [ -z "${customize}" ]; then exit 1; fi
	if [ "${customize}" == "Yes" ]; then
		custom_packages=$(sudo -u ${SUDO_USER} zenity --entry --height=480 --width=640 --title="LinuxLoops installer" --text="Do you want to install additional packages ? (if so, please provide a space separated package list)" --ok-label="Next" 2>/dev/null)
		custom_script_enable=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --list --text "Do you want to run a custom script during the install process ? (if so, select a bash script that will be run as root at the end of the install process)" --column "Run a custom script ?" "No" "Yes" --ok-label="Next" 2>/dev/null)
		if [ -z "${custom_script_enable}" ]; then exit 1; fi
		if [ "${custom_script_enable}" == "Yes" ]; then
			if [ ! -z "${chromeos}" ] || [ ! -z "${brunch}" ]; then
				custom_script=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer - Select the path to your custom script" --file-selection --file-filter=*.sh --filename="/home/chronos/user/" 2>/dev/null)
			else
				custom_script=$(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer - Select the path to your custom script" --file-selection --file-filter=*.sh --filename="$(eval echo ~${SUDO_USER})/" 2>/dev/null)
			fi
			if [ -z "${custom_script}" ]; then exit 1; fi
		fi
		kernel_parameters=$(sudo -u ${SUDO_USER} zenity --entry --height=480 --width=640 --title="LinuxLoops installer" --text="Do you want to add specific kernel parameters ? (if so, please provide a space separated kernel parameters list)" --ok-label="Next" 2>/dev/null)
	fi
	set_credentials
	if [ "${distro}" != "Qubes" ]; then
		hostname="$(echo "${distro}" | sed 's@[ !]@@g')-${RANDOM}"
		until false; do
			hostname=$(sudo -u ${SUDO_USER} zenity --entry --height=480 --width=640 --title="LinuxLoops installer" --text="Which hostname should be used to identify this machine on the network ?" --entry-text "${hostname}" --ok-label="Next" 2>/dev/null)
			if [ -z "${hostname}" ]; then exit 1; fi
			if ! echo "${hostname}" | grep -Pq '^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$'; then sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --error --text="hostname contains unsupported characters.\n" 2>/dev/null; continue; fi
			break
		done
	fi
fi
if [ "${install_type}" == "disk" ]; then
	if ! sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --question --text="WARNING: All data on device ${destination} will be erased, are you sure you want to continue ?" 2>/dev/null; then exit 1; fi
	start_install  2>&1 >(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --progress --auto-close --pulsate --text="Installing ${distro} with ${desktop} environment.\nYou can follow the install process in the terminal window." 2>/dev/null) || exit_with_error "Failed to install ${distro} in chroot."
	sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --info --text="Linuxloops installation process is finished.\nYou can now reboot your computer and start ${distro} by selecting your device in the UEFI boot menu." --ok-label="Exit" 2>/dev/null
else
	start_install  2>&1 >(sudo -u ${SUDO_USER} zenity --height=480 --width=640 --title="LinuxLoops installer" --progress --auto-close --pulsate --text="Installing ${distro} with ${desktop} environment.\nYou can follow the install process in the terminal window." 2>/dev/null) || exit_with_error "Failed to install ${distro} in chroot."
	grub_config
fi
}

cli_installer()
{
if [ "${declarative}" == "Yes" ]; then
	if [ ! -f "${declarative_config}" ]; then echo "Declarative file not found at path: ${declarative_config}."; exit 1; fi
	source "${declarative_config}"
	if [ ! -z "${custom_packages}" ]; then custom_packages=$(echo ${custom_packages} | sed -e 's@\n@ @g'); fi
	if [ ! -z "${custom_commands}" ]; then
		cat >"${linuxloopsdir}"/custom_commands <<CUSTOM_COMMANDS
#!/bin/bash
set -e
${custom_commands}
CUSTOM_COMMANDS
		chmod 0755 "${linuxloopsdir}"/custom_commands
		custom_script="${linuxloopsdir}"/custom_commands
	fi
fi
if [ -z "${hostname}" ]; then hostname="$(echo "${distro}" | sed 's@[ !]@@g')-${RANDOM}"; fi
if [ -z "${locale}" ]; then locale="en_US"; fi
if [ -z "${keymap}" ]; then keymap="us"; fi
if [ -z "${timezone}" ]; then timezone="UTC"; fi
if [ -z "${install_size}" ]; then
	if [ "${install_type}" == "image" ]; then install_size=14; fi
else
	if [ -z "${install_size##*[!0-9]*}" ] || [ "${install_size}" -lt 0 ]; then
		echo "Install size is not a positive integer: ${install_size}."
		exit 1
	elif [ "${install_size}" -lt 14 ] ; then
		echo "Install size cannot be lower than 14 GB."
		exit 1
	fi
fi
if [ -z "${distro}" ] || [[ ! " ${available_distros[*]} " =~ " ${distro} " ]]; then echo -e "Please select a distro from the below list:"; list_array "available_distros"; exit 1; fi
check_home_space
list_desktops "${distro}"
if [ -z "${desktop}" ] || [[ ! " ${available_desktops[*]} " =~ " ${desktop} " ]]; then echo -e "Please select an environment from the below list:"; list_array "available_desktops"; exit 1; fi
if [ -z "${destination}" ]; then echo "Please provide a destination path for the image with \"-dst\" or \"--destination\" argument.\n"; exit 1; fi
if [ -z "${destination##/dev/*}" ]; then install_type="disk"; else install_type="image"; fi
if [ "${install_type}" == "disk" ]; then
	if [ ! -b "${destination}" ]; then echo "Disk ${destination} was not found."; exit 1; fi
	if [ ! "$(lsblk ${destination} -nd -o TYPE)" == "disk" ]; then echo "Linuxloops can only be installed on a full disk."; exit 1; fi
	fullpath="${destination}"
	if [ ! -z "${install_size}" ]; then if [ $(( ($(lsblk -drnbpf -o SIZE "${destination}") / 1024 / 1024 / 1024) )) -lt "${install_size}" ]; then echo "You have requested an install size of ${install_size} GB but this device only has $(( ($(lsblk -drnbpf -o SIZE ${destination}) / 1024 / 1024 / 1024) )) GB available."; exit 1; fi; fi
	if [ -z "${install_size}" ]; then install_sizeMB=$(( ($(lsblk -drnbpf -o SIZE "${destination}") / 1024 / 1024) )); else install_sizeMB=$(( install_size * 1024 )); fi
else
	if [[ "${destination}" == *"/"* ]] && ([ -z "$(realpath ${destination} 2> /dev/null)" ] || [ ! -d "$(echo $(realpath ${destination}) | sed 's![^/]*$!!')" ]); then echo "Desination path does not exist, please provide an existing path."; exit 1; fi
	if [ "$(lsblk $(df -h --output=source $(echo $(realpath ${destination}) | sed 's![^/]*$!!') | tail -1) -no TYPE)" == "crypt" ]; then echo "Linuxloops disk images cannot be booted from an encrypted partition."; exit 1; fi
	if [[ ! "${destination}" == *"/"* ]]; then path="${PWD}/"; else path="$(echo $(realpath ${destination}) | sed 's![^/]*$!!')"; fi
	fullpath="${path}$(basename ${destination})"
	if [ ! -z "${wsl}" ] && [ ! -z "${path##/mnt/*}" ]; then echo "The ${distro} disk image has to be installed outside of the WSL VM, please specify a path such as /mnt/<drive letter>/..."; exit 1; fi
	if [ ! -z "${chromeos}" ] || [ ! -z "${brunch}" ] && [ ! -z "${path##/mnt/stateful_partition/unencrypted/*}" ]; then echo "The ${distro} disk image has to be installed in the unencrypted data partition, please specify a path such as /mnt/stateful_partition/unencrypted/..."; exit 1; fi
	possible_image_size
	if [ $(( ${maximum_image_size} - ${install_size} )) -lt 0 ]; then echo -e "Maximum available space to create the ${distro} image on this partition is ${maximum_image_size} GB.\nAvailable space: $(( ($(df -k --output=avail $(echo $(realpath ${destination}) | sed 's![^/]*$!!') | sed 1d) / 1024 / 1024) + ${freed_space} )) GB\nSpace needed to bootstrap: ${bootstrap_space} GB\nIf you think that available space value is incorrect, verify that you have correctly mounted the destination partition or if the partition is in ext4 format that there is no reserved space (cf. https://odzangba.wordpress.com/2010/02/20/how-to-free-reserved-space-on-ext4-partitions)"; exit 1; else install_sizeMB=$(( install_size * 1024)); fi
fi
if [ ! -z "${swap_size}" ]; then
	if [ -z "${swap_size##*[!0-9]*}" ] || [ "${swap_size}" -lt 0 ]; then echo "Provided swap size is not a positive integer: ${swap_size}."; exit 1; fi
	if [ "${swap_size}" -gt 0 ] && [ $(( install_sizeMB - (swap_size * 1024) )) -lt $(( 12 * 1024 )) ]; then echo "At least 12 GB should be available for the main partition, please increase the image size or reduce the swap size."; exit 1; fi
fi
if [ "${distro}" == "BlissOS" ] || [ "${distro}" == "Brunch" ] || [ "${distro}" == "ChromeOS-Flex" ] || [ "${distro}" == "Tails" ]; then
	if [ "${encryption}" == "Yes" ]; then echo -e "rootfs encryption is not supported with ${distro}.\n"; exit 1; fi
	if [ ! -z "${swap_size}" ] && [ "${swap_size}" -ne 0 ]; then echo -e "Swap cannot be enabled by design with ${distro}.\n"; exit 1; fi
fi
if [ ! $(list_array "available_locales" | grep -w "${locale}") ]; then echo "Locale ${locale} is not available, supported locales are:"; echo $(list_array "available_locales" | sed -e 's@\n@ @g'); exit 1; fi
if [ ! $(list_array "available_keymaps" | grep -w "${keymap}") ]; then echo "Keymap ${keymap} is not available, supported keympas are:"; echo $(list_array "available_keymaps" | sed -e 's@\n@ @g'); exit 1; fi
if [ ! $(list_array "available_timezones" | grep -w "${timezone}") ]; then echo "Timezone ${timezone} is not available, supported timezones are:"; echo $(list_array "available_timezones" | sed -e 's@\n@ @g'); exit 1; fi
if [ ! -z "${hostname}" ] && ! echo "${hostname}" | grep -Pq '^(([a-zA-Z0-9]|[a-zA-Z0-9][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z0-9]|[A-Za-z0-9][A-Za-z0-9\-]*[A-Za-z0-9])$'; then echo "Provided hostname contains invalid characters."; exit 1; fi
if [ "${fstype}" == "btrfs" ] && [[ ! " ${btrfs_supported[*]} " =~ " ${distro} " ]]; then echo "btrfs is not available for this distro, supported distros are:"; list_array "btrfs_supported"; exit 1; fi
if [ "${nvidia}" == "Yes" ] && [[ ! " ${nvidia_supported[*]} " =~ " ${distro} " ]]; then echo "nvidia driver is not available for this distro, supported distros are:"; list_array "nvidia_supported"; exit 1; fi
if [ "${surface}" == "Yes" ] && [[ ! " ${surface_supported[*]} " =~ " ${distro} " ]]; then echo "Surface patches are not available for this distro, supported distros are:"; list_array "surface_supported"; exit 1; fi
if [ "${live}" == "Yes" ] && [ ! "${distro}" == "Debian" ]; then echo "Linuxloops live can only be created with Debian distro."; exit 1; fi
if [ ! -z "${custom_script}" ] && [ ! -f "${custom_script}" ]; then echo "Custom script ${1} could not be found."; exit 1; fi
set_credentials
if [ "${install_type}" == "disk" ]; then
	read -p "WARNING: All data on device ${destination} will be erased, are you sure you want to continue ? (type yes to continue)"$'\n' confirm
	if [ -z ${confirm} ] || [ ! ${confirm} == "yes" ]; then echo "Invalid answer ${confirm}, exiting"; exit 1; fi
	start_install || exit_with_error "Failed to install ${distro} in chroot."
	echo -e "Linuxloops installation process is finished.\nYou can now reboot your computer and start ${distro} by selecting your device in the UEFI boot menu."
else
	start_install || exit_with_error "Failed to install ${distro} in chroot."
	grub_config
fi
}

check_dependencies()
{
if ( ! test -z {,} ); then echo "Linuxloops must be ran with \"bash\"."; exit 1; fi
if [ -z "$(command -v curl)" ]; then echo "\"curl\" program needs to be installed first."; exit 1; fi
if [ -z "$(command -v losetup)" ]; then echo "\"losetup\" program needs to be installed first."; exit 1; fi
if [ -z "$(command -v tar)" ]; then echo "\"tar\" program needs to be installed first."; exit 1; fi
if [ -z "$(command -v xz)" ]; then echo "\"xz\" program needs to be installed first."; exit 1; fi
if [ $(whoami) != "root" ]; then echo "Please run with this script with sudo."; exit 1; fi
if ! : >/dev/tcp/1.1.1.1/80; then echo -e "Internet connection not available, please make sure you are connected to the internet."; exit 1; fi
}

set_base_parameters()
{
linuxloopsdir="$(eval echo ~${SUDO_USER})"/.linuxloops
mkdir -p "${linuxloopsdir}"
if grep -qi 'Microsoft' /proc/version; then wsl=1; fi
if [ "$(grep -o 'NAME=[^,]\+' /etc/os-release | cut -d'=' -f2)" == "Chrome OS" ]; then if [ -f /etc/brunch_version ]; then brunch=1; else chromeos=1; fi; fi
}

set +H
check_dependencies
set_base_parameters
if [ ${#} -eq 0 ]; then
	if [ -z "$(command -v zenity)" ]; then echo "To use the GUI installer you need to install the \"zenity\" binary package." 2>/dev/null; usage; exit 1; fi
	zenity=1
	zenity_installer
else
	while [ ${#} -gt 0 ]; do
		case "${1}" in
			-distro | --distribution)
				shift
				distro="${1}"
			;;
			-env | --environment)
				shift
				desktop="${1}"
			;;
			-dst | --destination)
				shift
				destination="${1}"
			;;
			-s | --size)
				shift
				install_size="${1}"
			;;
			-z | --swapsize)
				shift
				swap_size="${1}"
			;;
			-a | --autologin)
				autologin="Yes"
			;;
			-b | --btrfs)
				fstype="btrfs"
			;;
			-e | --encrypt)
				encryption="Yes"
			;;
			-H | --hostname)
				shift
				hostname="${1}"
			;;
			-L | --locale)
				shift
				locale="${1}"
			;;
			-K | --keymap)
				shift
				keymap="${1}"
			;;
			-T | --timezone)
				shift
				timezone="${1}"
			;;
			-n | --nvidia)
				nvidia="Yes"
			;;
			-S | --surface)
				surface="Yes"
			;;
			-c | --custom-packages)
				shift
				custom_packages="${1}"
			;;
			-C | --custom-script)
				shift
				custom_script="$(sudo -u ${SUDO_USER} echo $(realpath ${1}))"
			;;
			-k | --kernel-parameters)
				shift
				kernel_parameters="${1}"
			;;
			-d | --declarative)
				shift
				declarative="Yes"
				declarative_config="${1}"
			;;
			-t | --test)
				test_distro="Yes"
			;;
			-u | --usb-live)
				live="Yes"
			;;
			-l | --list)
				list_array "all"
				exit 0
			;;
			-ll | --list-locales)
				echo -e "Available locales:\n"$(list_array "available_locales" | sed -e 's@\n@ @g')
				exit 0
			;;
			-lk | --list-keympas)
				echo -e "Available keymaps:\n"$(list_array "available_keymaps" | sed -e 's@\n@ @g')
				exit 0
			;;
			-lt | --list-timezones)
				echo -e "Available timezones:\n"$(list_array "available_timezones" | sed -e 's@\n@ @g')
				exit 0
			;;
			-h | --help)
				usage
				exit 0
			;;
			*)
				echo "${1} argument is not valid"
				usage
				exit 1
		esac
		shift
	done
	cli_installer
fi
